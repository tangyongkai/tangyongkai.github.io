<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-gulp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/27/gulp/" class="article-date">
  <time datetime="2017-07-27T05:57:03.000Z" itemprop="datePublished">2017-07-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/27/gulp/">gulp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="gulp"><a href="#gulp" class="headerlink" title="gulp"></a>gulp</h1><h2 id="1-什么是gulp"><a href="#1-什么是gulp" class="headerlink" title="1.什么是gulp"></a>1.什么是gulp</h2><p><strong>gulp</strong>是可以自动化执行任务的工具 在平时开发的流程里面,一定有一些任务需要手工重复得执行，比如:</p>
<ul>
<li>把文件从开发目录<strong>拷贝</strong>到生产目录</li>
<li>把多个 JS 或者 CSS 文件<strong>合并</strong>成一个文件</li>
<li>对JS文件和CSS进行<strong>压缩</strong></li>
<li>把sass或者less文件<strong>编译</strong>成CSS</li>
<li><strong>压缩图像</strong>文件</li>
<li>创建一个可以<strong>实时刷新</strong>页面内容的本地服务器</li>
</ul>
<p>只要你觉得有些动作是要<strong>重复</strong>去做的,就可以把这些动作创建成一个gulp任务 然后在指定的条件下自动执行 比如在less源文件发生改变后自动编译成css文件</p>
<h2 id="2-gulp特点"><a href="#2-gulp特点" class="headerlink" title="2.gulp特点"></a>2.gulp特点</h2><ul>
<li><strong>易于使用</strong> 通过代码优于配置的策略，Gulp 让简单的任务简单，复杂的任务可管理。</li>
<li><strong>快速构建</strong> 利用 node.js 流的威力，你可以快速构建项目并减少频繁的 IO 操作。前一级的输出，直接变成后一级的输入，使得在操作上非常简单</li>
<li><strong>高质量的插件</strong> Gulp 严格的插件指南确保插件如你期望的那样简洁地工作。</li>
<li><strong>易于学习</strong> 通过最少的 API，掌握 gulp 毫不费力，构建工作尽在掌握。<h2 id="3-安装gulp"><a href="#3-安装gulp" class="headerlink" title="3.安装gulp"></a>3.安装gulp</h2>在项目里使用gulp需要</li>
<li>安装node</li>
<li>在全局范围内去安装一下gulp的命令行工具</li>
<li>然后在项目里面再去本地安装gulp<h4 id="3-1安装node"><a href="#3-1安装node" class="headerlink" title="3.1安装node"></a>3.1安装node</h4>gulp是基于Nodejs的自动任务运行器 安装Gulp和相关行件用的都是node的包管理工具npm 所以你需要先在电脑上安装 node,确定在命令行工具的下面可以使用npm这个命令，这样就能去安装Gulp了<br>安装好以后，我们可以打开命令行工具，mac 用户可以使用终端工具，windows 用户可以找到cmd命令行工具。<h4 id="3-2gulp命令行工具"><a href="#3-2gulp命令行工具" class="headerlink" title="3.2gulp命令行工具"></a>3.2gulp命令行工具</h4></li>
<li>使用 npm install 去安装 gulp，注意加上一个 -g 的参数，表示在全局范围内去安装.</li>
<li>一般用 npm 安装的时候用一个 -g 的参数就表示，这个安装的东西会作为命令去执行。</li>
<li>如果你在mac或linux下遇到了权限问题,在下面这个命令的前面加上 sudo npm install gulp -g 并输入mac密码。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install -g gulp</div></pre></td></tr></table></figure>
</li>
</ul>
<p>安装完成后可以输入 gulp –help 如果输出一些帮助的信息就表示可以gulp命令行成功安装了</p>
<p>如果安装不上可以换一下源试试</p>
<ul>
<li>淘宝源 npm install -g gulp –registry=<a href="http://registry.npm.taobao.org" target="_blank" rel="external">http://registry.npm.taobao.org</a></li>
<li>中国源 npm install -g gulp –registry=<a href="http://registry.cnpmjs.org" target="_blank" rel="external">http://registry.cnpmjs.org</a></li>
<li>官方源 npm install -g gulp –registry=<a href="http://www.npmjs.org/" target="_blank" rel="external">http://www.npmjs.org/</a><h4 id="3-3-gulp本地安装"><a href="#3-3-gulp本地安装" class="headerlink" title="3.3 gulp本地安装"></a>3.3 gulp本地安装</h4>1.先创建一个目录 在 mac 和 linux 操作系统下创建一个文件夹<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir learngulp</div></pre></td></tr></table></figure>
</li>
</ul>
<p>2.使用 cd 命令进入此目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cd learngulp</div></pre></td></tr></table></figure></p>
<p>3.创建项目描述文件package.json 项目需要一个叫package.json的文件来管理项目的配置,可以使用 npm init 这个命令生成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ npm init</div><div class="line"></div><div class="line"> name: (zhufeng_automation) learngulp //项目名称</div><div class="line"> version: (1.0.0) 1.0.0   //项目版本号</div><div class="line"> description: learn gulp //项目说明</div><div class="line"> entry point: (index.js) index.js // 入口文件</div><div class="line"> test command: test.js //测试脚本 执行npm test时会执行此文件</div><div class="line"> git repository: (https://github.git) //模块的git仓库</div><div class="line"> keywords: node.js gulp  //在npmjs官网搜索时的关键字</div><div class="line"> author: zhufengpeixun //项目作者名字</div><div class="line"> license: (ISC) MIT //授权协议</div><div class="line"> About to write to D:\mygit\zhufeng_automation\package.json:</div><div class="line"> Is this ok? (yes) yes //直接回车确认</div></pre></td></tr></table></figure></p>
<p>回车后会在当前目录下创建一个 package.json 文件</p>
<p>4.本地安装gulp到开发依赖中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install gulp --save-dev</div></pre></td></tr></table></figure></p>
<p>这样可以把 gulp 作为项目的开发依赖(只在开发时用，不会发布到线上) 第一会在node_modules下安装本地的gulp库 第二会把并把添加配置到package.json文件里面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;devDependencies&quot;:&#123;</div><div class="line">        &quot;gulp&quot;: &quot;^3.9.0&quot;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<h2 id="4-运行gulp"><a href="#4-运行gulp" class="headerlink" title="4.运行gulp"></a>4.运行gulp</h2><h4 id="4-1创建配置文件"><a href="#4-1创建配置文件" class="headerlink" title="4.1创建配置文件"></a>4.1创建配置文件</h4><p>gulp的任务要放到一个叫 gulpfile.js 的文件里面 先在项目的根目录下面创建一个这样的文件 然后在这个文件的顶部添加下面这行代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div></pre></td></tr></table></figure></p>
<p>通过require可以把gulp模块引入当前项目并赋值给gulp变量 这样gulp这个变量里面就会拥有gulp的所有的方法了</p>
<h4 id="4-2创建gulp的任务"><a href="#4-2创建gulp的任务" class="headerlink" title="4.2创建gulp的任务"></a>4.2创建gulp的任务</h4><p>可以使用gulp的task方法 同样我们去创建一个叫 hello 的任务，它要做的事就是在控制台上输出 “您好” 这两个字</p>
<p>1.第一个参数是任务的名称</p>
<p>2.第二个参数是任务的定义,是一个匿名函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'hello'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">   <span class="built_in">console</span>.log(<span class="string">'您好'</span>);</div><div class="line"> &#125;);</div></pre></td></tr></table></figure></p>
<h4 id="4-3执行gulp任务"><a href="#4-3执行gulp任务" class="headerlink" title="4.3执行gulp任务"></a>4.3执行gulp任务</h4><p>打开命令行工具，进入到项目所在的目录，然后输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gulp hello</div></pre></td></tr></table></figure></p>
<p>会返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[21:36:34] Starting &apos;hello&apos;...</div><div class="line">    您好</div><div class="line">    [21:36:34] Finished &apos;hello&apos; after 959 μs</div></pre></td></tr></table></figure></p>
<p>gulp后面跟着的是任务的名称 不输入任务名称的话会默认找default任务，找不到会报错</p>
<h4 id="4-4执行其它任务"><a href="#4-4执行其它任务" class="headerlink" title="4.4执行其它任务"></a>4.4执行其它任务</h4><p>可以使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gulp &lt;task&gt; &lt;othertask&gt;</div></pre></td></tr></table></figure></p>
<h2 id="5-gulp参数"><a href="#5-gulp参数" class="headerlink" title="5.gulp参数"></a>5.gulp参数</h2><p>gulp 只有你需要熟知的参数标记，其他所有的参数标记只在一些任务需要的时候使用。</p>
<ul>
<li>-v 或 –version 会显示全局和项目本地所安装的 gulp版本号</li>
<li>–gulpfile 手动指定一个 gulpfile 的路径，这在你有很多个 gulpfile 的时候很有用。这也会将 CWD 设置到该 gulpfile 所在目录</li>
<li>–cwd dirpath 手动指定 CWD。定义 gulpfile 查找的位置，此外，所有的相应的依赖（require）会从这里开始计算相对路径</li>
<li>-T 或 –tasks 会显示所指定 gulpfile 的 task 依赖树</li>
<li>–color 强制 gulp 和 gulp 插件显示颜色，即便没有颜色支持</li>
<li>–no-color 强制不显示颜色，即便检测到有颜色支持</li>
<li>–silent 禁止所有的 gulp 日志<h2 id="6-gulp-js工作方式"><a href="#6-gulp-js工作方式" class="headerlink" title="6.gulp.js工作方式"></a>6.gulp.js工作方式</h2>gulp的使用流程一般是:</li>
</ul>
<p>1.首先通过gulp.src()方法获取到想要处理的文件流</p>
<p>2.然后把文件流通过pipe方法导入到gulp的插件中</p>
<p>3.最后把经过插件处理后的流再通过pipe方法导入到gulp.dest()中</p>
<p>4.gulp.dest()方法则把流中的内容写入到文件中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">    gulp.src(<span class="string">'script/src.js'</span>)             <span class="comment">// 获取文件的流的api</span></div><div class="line">        .pipe(gulp.dest(<span class="string">'dist/dest.js'</span>)); <span class="comment">// 写文件的api</span></div></pre></td></tr></table></figure></p>
<h2 id="7-gulp核心API"><a href="#7-gulp核心API" class="headerlink" title="7. gulp核心API"></a>7. gulp核心API</h2><p><strong>gulp只有4个核心API</strong></p>
<h4 id="7-1-gulp-src"><a href="#7-1-gulp-src" class="headerlink" title="7.1 gulp.src()"></a>7.1 gulp.src()</h4><p>在Gulp中，使用的是Nodejs中的stream(流)，首先获取到需要的stream 然后可以通过stream的pipe方法把流导入到你想要的地方 比如Gulp的插件中,经过插件处理后的流又可以继续导入到其他插件中，当然也可以把流写入到文件中 所以Gulp是以stream为媒介的，它不需要频繁的生成临时文件，这也是Gulp的速度快的一个原因 gulp.src()方法正是用来获取流的</p>
<p>但要注意这个流里的内容不是原始的文件流,而是一个虚拟文件对象流,这个虚拟文件对象中存储着原始文件的路径、文件名和内容等信息 vinyl<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> File = <span class="built_in">require</span>(<span class="string">'vinyl'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> indexFile = <span class="keyword">new</span> File(&#123;</div><div class="line">    <span class="attr">cwd</span>: <span class="string">"/"</span>,</div><div class="line">    <span class="attr">base</span>: <span class="string">"/test/"</span>,</div><div class="line">    <span class="attr">path</span>: <span class="string">"/test/index.js"</span>,</div><div class="line">    <span class="attr">contents</span>: <span class="keyword">new</span> Buffer(<span class="string">"name=zfpx"</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(File.isVinyl(indexFile));</div><div class="line"><span class="built_in">console</span>.log(indexFile.isBuffer());</div><div class="line"><span class="built_in">console</span>.log(indexFile.isStream());</div></pre></td></tr></table></figure></p>
<p>其语法为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gulp.src(globs[, options])</div></pre></td></tr></table></figure></p>
<ul>
<li>globs 参数是文件匹配模式(类似正则表达式)，用来匹配文件路径(包括文件名)，当然这里也可以直接指定某个具体的文件路径。当有多个匹配模式时，该参数可以为一个数组</li>
<li><p>options 为可选参数。通常情况下我们不需要用到</p>
<h4 id="7-2-gulp-dest"><a href="#7-2-gulp-dest" class="headerlink" title="7.2  gulp.dest()"></a>7.2  gulp.dest()</h4><p>是用来向硬盘写入文件的，其语法为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gulp.dest(path[,options])</div></pre></td></tr></table></figure>
</li>
<li><p>path 为写入文件的路径</p>
</li>
<li>options 为一个可选的参数对象，通常我们不需要用到<br>要想使用好<strong>gulp.dest()</strong>这个方法，就要理解给它传入的路径参数与最终生成的文件的关系。</li>
</ul>
<p><strong>gulp.dest()</strong>传入的路径参数只能用来指定要生成的文件的目录,而不能指定生成文件的文件名 它生成文件的文件名使用的是导入到它的文件流自身的文件名 所以生成的文件名是由导入到它的文件流决定的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">     gulp.src(<span class="string">'script/jquery.js'</span>)</div><div class="line">    .pipe(gulp.dest(<span class="string">'dist/jquery.js'</span>));</div><div class="line">    <span class="comment">//最终生成的文件路径为 dist/jquery.js/jquery.js,而不是dist/jquery.js</span></div><div class="line"><span class="comment">//gulp.dest(path)生成的文件路径是我们传入的path参数后面再加上gulp.src()中有通配符开始出现的那部分路径</span></div><div class="line"></div><div class="line"><span class="comment">//通过指定gulp.src()方法配置参数中的base属性，我们可以更灵活的来改变gulp.dest()生成的文件路径</span></div><div class="line"></div><div class="line"> <span class="comment">//配置了base参数，此时base路径为script</span></div><div class="line">gulp.src(<span class="string">'script/lib/*.js'</span>, &#123;<span class="attr">base</span>:<span class="string">'script'</span>&#125;)</div><div class="line">    <span class="comment">//假设匹配到的文件为script/lib/jquery.js</span></div><div class="line">    <span class="comment">//此时生成的文件路径为 build/lib/jquery.js</span></div><div class="line">    .pipe(gulp.dest(<span class="string">'build'</span>))</div></pre></td></tr></table></figure></p>
<h4 id="7-3gulp-task"><a href="#7-3gulp-task" class="headerlink" title="7.3gulp.task()"></a>7.3gulp.task()</h4><p>gulp.task方法用来定义任务，其语法为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gulp.task(name[, deps], fn)</div></pre></td></tr></table></figure></p>
<ul>
<li>name 为任务名称</li>
<li>deps 是当前定义的任务需要依赖的其他任务，为一个数组。当前定义的任务会在所有依赖的任务执行完毕后才开始执行。如果没有依赖，则可省略这个参数</li>
<li>fn 为任务定义函数，我们把任务要执行的代码都写在里面。该参数也是可选的。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'mytask'</span>, [<span class="string">'array'</span>, <span class="string">'of'</span>, <span class="string">'task'</span>, <span class="string">'names'</span>],</div><div class="line">   <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">//定义一个有依赖的任务</span></div><div class="line">      <span class="comment">// Do something</span></div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果某个任务所依赖的任务是异步的，就要注意了，gulp并不会等待那个所依赖的异步任务完成，而是会接着执行后续的任务<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//two任务虽然依赖于one任务,但并不会等到one任务中的异步操作完成后再执行</span></div><div class="line">gulp.task(<span class="string">'one'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="comment">//one是一个异步执行的任务</span></div><div class="line">      setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'one is done'</span>)</div><div class="line">      &#125;,<span class="number">5000</span>);</div><div class="line">    &#125;);</div><div class="line"> gulp.task(<span class="string">'two'</span>,[<span class="string">'one'</span>],<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'two is done'</span>);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<p>在异步操作完成后执行一个回调函数来通知gulp这个异步任务已经完成,这个回调函数就是任务函数的第一个参数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'one'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">cb</span>)</span>&#123; <span class="comment">//cb为任务函数提供的回调，用来通知任务已经完成</span></div><div class="line">      <span class="comment">//one是一个异步执行的任务</span></div><div class="line">      setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'one is done'</span>);</div><div class="line">        cb();  <span class="comment">//执行回调，表示这个异步任务已经完成</span></div><div class="line">      &#125;,<span class="number">5000</span>);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<h4 id="7-4gulp-watch"><a href="#7-4gulp-watch" class="headerlink" title="7.4gulp.watch()"></a>7.4gulp.watch()</h4><p>用来监视文件的变化，当文件发生变化后，我们可以利用它来执行相应的任务，例如文件拷贝等。其语法为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gulp.watch(glob[, opts], tasks)</div></pre></td></tr></table></figure></p>
<ul>
<li>glob 为要监视的文件匹配模式，规则和用法与gulp.src()方法中的 glob 相同。</li>
<li>opts 为一个可选的配置对象，通常不需要用到</li>
<li>tasks 为文件变化后要执行的任务，为一个数组<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'uglify'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   <span class="comment">//do something</span></div><div class="line"> &#125;);</div><div class="line"> gulp.task(<span class="string">'reload'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   <span class="comment">//do something</span></div><div class="line"> &#125;);</div><div class="line"> gulp.watch(<span class="string">'js/**/*.js'</span>, [<span class="string">'uglify'</span>,<span class="string">'reload'</span>]);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>另外一种使用方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gulp.watch(glob[, opts, cb])</div></pre></td></tr></table></figure></p>
<ul>
<li>glob和 opts 参数与第一种用法相同</li>
<li>cb参数为一个函数。每当监视的文件发生变化时，就会调用这个函数,并且会给它传入一个对象，该对象包含了文件变化的一些信息 type属性为变化的类型，可以是 added、changed、deleted和path属性为发生变化的文件的路径<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">gulp.watch(<span class="string">'js/**/*.js'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">    <span class="comment">//变化类型 added为新增,deleted为删除，changed为改变</span></div><div class="line">    <span class="built_in">console</span>.log(event.type);</div><div class="line">    <span class="comment">//变化的文件的路径</span></div><div class="line">    <span class="built_in">console</span>.log(event.path);</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="8-基本任务"><a href="#8-基本任务" class="headerlink" title="8.基本任务"></a>8.基本任务</h2><h4 id="8-1复制单个文件"><a href="#8-1复制单个文件" class="headerlink" title="8.1复制单个文件"></a>8.1复制单个文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">     gulp.task(<span class="string">'copy-html'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">         <span class="keyword">return</span> gulp.src(<span class="string">'app/index.html'</span>).pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">     &#125;);</div></pre></td></tr></table></figure>
<h4 id="8-2-复制多个文件"><a href="#8-2-复制多个文件" class="headerlink" title="8.2 复制多个文件"></a>8.2 复制多个文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">   <span class="comment">//复制图片</span></div><div class="line">   gulp.task(<span class="string">'copy-images'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       <span class="keyword">return</span> gulp.src(<span class="string">'app/imgs/*.jpg'</span>)</div><div class="line">       .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 1. &#123;&#125; 里可以指定多个扩展名</div><div class="line">    * 2. * 匹配所有的字符，除了路径分隔符 /</div><div class="line">    * 3. ** 匹配所有的字符，包括路径分隔符 /</div><div class="line">    */</div><div class="line">   gulp.task(<span class="string">'copy-images'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       <span class="keyword">return</span> gulp.src(<span class="string">'app/imgs/**/*.&#123;jpg,png&#125;'</span>)</div><div class="line">       .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 1. 匹配多个目录 glob</div><div class="line">    * 2. 可以填写一个数组</div><div class="line">    */</div><div class="line">   gulp.task(<span class="string">'copy-other'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">           <span class="keyword">return</span> gulp.src([<span class="string">'app/css/*.css'</span>,<span class="string">'app/js/*.js'</span>],&#123;<span class="attr">base</span>:<span class="string">'app'</span>&#125;)</div><div class="line">           .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">       &#125;);</div><div class="line">   </div><div class="line">       <span class="comment">/**</span></div><div class="line">        * 1. 匹配多个目录 glob</div><div class="line">        * 2. !表示 排除一个文件</div><div class="line">        */</div><div class="line">       gulp.task(<span class="string">'copy-other'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">           <span class="keyword">return</span> gulp.src([<span class="string">'app/css/*.css'</span>,<span class="string">'app/js/*.js'</span></div><div class="line">           ,<span class="string">'!app/js/*.tmp.js'</span>],&#123;<span class="attr">base</span>:<span class="string">'app'</span>&#125;)</div><div class="line">           .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">       &#125;);</div></pre></td></tr></table></figure>
<h4 id="8-3组合任务"><a href="#8-3组合任务" class="headerlink" title="8.3组合任务"></a>8.3组合任务</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line"></div><div class="line">   gulp.task(<span class="string">'copy-html'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       <span class="keyword">return</span> gulp.src(<span class="string">'app/index.html'</span>).pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   gulp.task(<span class="string">'copy-images'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       <span class="keyword">return</span> gulp.src(<span class="string">'app/imgs/**/*.&#123;jpg,png&#125;'</span>).pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   gulp.task(<span class="string">'copy-other'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       <span class="keyword">return</span> gulp.src([<span class="string">'app/css/*.css'</span>,<span class="string">'app/js/*.js'</span>,<span class="string">'app/js/*.tmp.js'</span>],&#123;<span class="attr">base</span>:<span class="string">'app'</span>&#125;).pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">   &#125;);</div><div class="line"></div><div class="line"></div><div class="line">   gulp.task(<span class="string">'default'</span>,[<span class="string">'copy-html'</span>,<span class="string">'copy-images'</span>,<span class="string">'copy-other'</span>],<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       <span class="built_in">console</span>.log(<span class="string">'全部拷贝任务执行完毕!'</span>);</div><div class="line">   &#125;);</div></pre></td></tr></table></figure>
<h4 id="8-3监听任务"><a href="#8-3监听任务" class="headerlink" title="8.3监听任务"></a>8.3监听任务</h4><p>使用 gulp 的 watch 这个方法，我们可以去监视一些文件，当这些文件发生变化的时候，立即去执行一些指定的任务<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'copy-html'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> gulp.src(<span class="string">'app/index.html'</span>)</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'copy-images'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> gulp.src(<span class="string">'app/imgs/**/*.&#123;jpg,png&#125;'</span>,&#123;<span class="attr">base</span>:<span class="string">'app'</span>&#125;)</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'copy-other'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> gulp.src([<span class="string">'app/css/*.css'</span>,<span class="string">'app/js/*.js'</span></div><div class="line">        ,<span class="string">'app/js/*.tmp.js'</span>],&#123;<span class="attr">base</span>:<span class="string">'app'</span>&#125;).pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">//在执行watch的时候会监控index.html文件的变化，发生变化后可以执行拷贝html的任务</span></div><div class="line">    gulp.task(<span class="string">'default'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        gulp.watch(<span class="string">'app/index.html'</span>,[<span class="string">'copy-html'</span>]);</div><div class="line">        gulp.watch(<span class="string">'app/imgs/**/*.&#123;jpg,png&#125;'</span>,[<span class="string">'copy-images'</span>]);</div><div class="line">        gulp.watch([<span class="string">'app/css/*.css'</span>,<span class="string">'app/js/*.js'</span></div><div class="line">        ,<span class="string">'app/js/*.tmp.js'</span>],[<span class="string">'copy-other'</span>]);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<h2 id="9-gulp插件"><a href="#9-gulp插件" class="headerlink" title="9.gulp插件"></a>9.gulp插件</h2><p>gulp提供了一些很实用的接口，但本身并不能做太多的事情 可以读取文件、写入文件以及监控文件等一少部分功能 其它实用的功能都是依靠插件来进行扩展的 这些插件可以实现比如</p>
<ul>
<li>编译 Sass：gulp-sass</li>
<li>编译 Less：gulp-less</li>
<li>合并文件：gulp-concat</li>
<li>压缩js 文件：gulp-uglify</li>
<li>重命名js文件：gulp-rename</li>
<li>优化图像大小：gulp-imagemin</li>
<li>压缩css 文件：gulp-minify-css</li>
<li>创建本地服务器：gulp-connect</li>
<li>实时预览 gulp-connect<h4 id="9-1使用插件步骤"><a href="#9-1使用插件步骤" class="headerlink" title="9.1使用插件步骤"></a>9.1使用插件步骤</h4>1.npm install xxx –save-dev 安装插件</li>
</ul>
<p>2.在 gulpfile.js 顶部引入此插件</p>
<p>3.在创建任务的时候使用此插件</p>
<h4 id="9-2gulp-load-plugins"><a href="#9-2gulp-load-plugins" class="headerlink" title="9.2gulp-load-plugins"></a>9.2gulp-load-plugins</h4><p>这个插件能自动帮你加载package.json文件里的gulp插件。 例如假设你的package.json文件里的依赖是这样的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&quot;devDependencies&quot;: &#123;</div><div class="line">       &quot;gulp&quot;: &quot;^3.9.0&quot;,</div><div class="line">       &quot;gulp-concat&quot;: &quot;^2.6.0&quot;,</div><div class="line">       &quot;gulp-connect&quot;: &quot;^2.2.0&quot;</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<p>然后我们可以在gulpfile.js中使用gulp-load-plugins来帮我们加载插件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">    <span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">'gulp-load-plugins'</span>)();</div></pre></td></tr></table></figure></p>
<p>然后我们要使用gulp-concat和gulp-connect这两个插件的时候， 就可以使用$.concat和$.connect来代替了,也就是原始插件名去掉gulp-前缀，之后再转换为驼峰命名。</p>
<h4 id="9-3less"><a href="#9-3less" class="headerlink" title="9.3less"></a>9.3less</h4><p>less插件可以把less文件编译成css<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$    npm install gulp-less --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">    <span class="keyword">var</span> less = <span class="built_in">require</span>(<span class="string">'gulp-less'</span>);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'less'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> gulp.src(<span class="string">'app/less/*.less'</span>)</div><div class="line">        .pipe(less())</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist/css'</span>));</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'default'</span>,[<span class="string">'less'</span>]);</div></pre></td></tr></table></figure>
<h4 id="9-4gulp-concat"><a href="#9-4gulp-concat" class="headerlink" title="9.4gulp-concat"></a>9.4gulp-concat</h4><p>这个插件可以把几个文件合并到一块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$    npm install gulp-concat --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">  <span class="keyword">var</span> concat = <span class="built_in">require</span>(<span class="string">'gulp-concat'</span>);</div><div class="line"></div><div class="line">  gulp.task(<span class="string">'concat'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">return</span> gulp.src([<span class="string">'app/js/*.js'</span>,<span class="string">'!app/js/*.tmp.js'</span>])<span class="comment">//指定要合并的文件glob</span></div><div class="line">          .pipe(concat(<span class="string">'app.js'</span>))<span class="comment">//进行合并并指定合并后的文件名</span></div><div class="line">          .pipe(gulp.dest(<span class="string">'dist/js'</span>));<span class="comment">//输出到目标路径</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  gulp.task(<span class="string">'default'</span>,[<span class="string">'concat'</span>]);</div></pre></td></tr></table></figure>
<h4 id="9-5gulp-uglify"><a href="#9-5gulp-uglify" class="headerlink" title="9.5gulp-uglify"></a>9.5gulp-uglify</h4><p>合并后我们可以对JS文件进行压缩,最小化处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$  npm install gulp-uglify --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">    <span class="keyword">var</span> concat = <span class="built_in">require</span>(<span class="string">'gulp-concat'</span>);</div><div class="line">    <span class="keyword">var</span> uglify = <span class="built_in">require</span>(<span class="string">'gulp-uglify'</span>)</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'uglify'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> gulp.src([<span class="string">'app/js/*.js'</span>,<span class="string">'!app/js/*.tmp.js'</span>])</div><div class="line">            .pipe(concat(<span class="string">'app.js'</span>)) <span class="comment">//把多个JS文件合并成一个文件</span></div><div class="line">            .pipe(uglify()) <span class="comment">//对合并后的app.js文件进行压缩</span></div><div class="line">            .pipe(gulp.dest(<span class="string">'dist/js'</span>)); <span class="comment">//输出到目的地</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'default'</span>,[<span class="string">'uglify'</span>]);</div></pre></td></tr></table></figure>
<h4 id="9-6gulp-rename"><a href="#9-6gulp-rename" class="headerlink" title="9.6gulp-rename"></a>9.6gulp-rename</h4><p>在把处理好的文件存放到指定的位置之前，我们可以先去重新命名一下它<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install gulp-rename --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">    <span class="keyword">var</span> concat = <span class="built_in">require</span>(<span class="string">'gulp-concat'</span>);</div><div class="line">    <span class="keyword">var</span> uglify = <span class="built_in">require</span>(<span class="string">'gulp-uglify'</span>);</div><div class="line">    <span class="keyword">var</span> rename = <span class="built_in">require</span>(<span class="string">'gulp-rename'</span>);</div><div class="line">    gulp.task(<span class="string">'uglify'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> gulp.src([<span class="string">'app/js/*.js'</span>,<span class="string">'!app/js/*.tmp.js'</span>])<span class="comment">//指定要处理的文件</span></div><div class="line">            .pipe(concat(<span class="string">'app.js'</span>))<span class="comment">//合并成一个文件</span></div><div class="line">            .pipe(gulp.dest(<span class="string">'dist/js'</span>))<span class="comment">//保存此文件</span></div><div class="line">            .pipe(uglify())<span class="comment">//进行压缩</span></div><div class="line">            .pipe(rename(<span class="string">'app.min.js'</span>))<span class="comment">//对此文件进行重命名</span></div><div class="line">            .pipe(gulp.dest(<span class="string">'dist/js'</span>));<span class="comment">//再输出一次</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'default'</span>,[<span class="string">'uglify'</span>]);</div></pre></td></tr></table></figure>
<h4 id="9-7-gulp-minify-css"><a href="#9-7-gulp-minify-css" class="headerlink" title="9.7 gulp-minify-css"></a>9.7 gulp-minify-css</h4><p>压缩css<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$    npm install gulp-minify-css --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">   <span class="keyword">var</span> less = <span class="built_in">require</span>(<span class="string">'gulp-less'</span>);</div><div class="line">   <span class="keyword">var</span> minify = <span class="built_in">require</span>(<span class="string">'gulp-minify-css'</span>);<span class="comment">//在文件的顶部去包含这个插件，起个名字，叫做 minify</span></div><div class="line">   <span class="keyword">var</span> rename = <span class="built_in">require</span>(<span class="string">'gulp-rename'</span>);</div><div class="line">   gulp.task(<span class="string">'minify'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       <span class="keyword">return</span> gulp.src(<span class="string">'app/less/page.less'</span>)<span class="comment">//指定 less文件</span></div><div class="line">           .pipe(less())<span class="comment">//把less编译成css</span></div><div class="line">           .pipe(gulp.dest(<span class="string">'dist/css'</span>))<span class="comment">//输出到目的地</span></div><div class="line">           .pipe(minify())<span class="comment">//对 css再进行压缩</span></div><div class="line">           .pipe(rename(<span class="string">'page.min.css'</span>))<span class="comment">//重命名</span></div><div class="line">           .pipe(gulp.dest(<span class="string">'dist/css'</span>));<span class="comment">//输出到目的地</span></div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   gulp.task(<span class="string">'default'</span>,[<span class="string">'less'</span>]);</div></pre></td></tr></table></figure>
<h4 id="9-8gulp-minify-html"><a href="#9-8gulp-minify-html" class="headerlink" title="9.8gulp-minify-html"></a>9.8gulp-minify-html</h4><p>html文件压缩<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install gulp-minify-html --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</div><div class="line">        minifyHtml = <span class="built_in">require</span>(<span class="string">"gulp-minify-html"</span>);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'minify-html'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        gulp.src(<span class="string">'src/*.html'</span>) <span class="comment">// 要压缩的html文件</span></div><div class="line">        .pipe(minifyHtml())    <span class="comment">//压缩</span></div><div class="line">        .pipe(gulp.dest(<span class="string">'dist/html'</span>));<span class="comment">//输出到目的地</span></div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<h4 id="9-9gulp-imagemin"><a href="#9-9gulp-imagemin" class="headerlink" title="9.9gulp-imagemin"></a>9.9gulp-imagemin</h4><p>如果要想在保证不改变图像质量的情况下，让图像文件的体积变得更小一点,我们可以使用gulp-imagemin<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install gulp-imagemin --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line"> <span class="keyword">var</span> imagemin = <span class="built_in">require</span>(<span class="string">'gulp-imagemin'</span>);</div><div class="line"></div><div class="line"> gulp.task(<span class="string">'copy-images'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">     <span class="keyword">return</span> gulp.src(<span class="string">'app/imgs/**/*.&#123;jpg,png&#125;'</span>)<span class="comment">//指定要压缩的图片</span></div><div class="line">         .pipe(imagemin()) <span class="comment">//进行图片压缩</span></div><div class="line">         .pipe(gulp.dest(<span class="string">'dist'</span>));<span class="comment">//输出目的地</span></div><div class="line"> &#125;);</div><div class="line"></div><div class="line">  gulp.task(<span class="string">'default'</span>,[<span class="string">'copy-images'</span>]);</div></pre></td></tr></table></figure>
<h4 id="9-10gulp-connect"><a href="#9-10gulp-connect" class="headerlink" title="9.10gulp-connect"></a>9.10gulp-connect</h4><p>有些时候我们需要把文件放到本地服务器上去预览，gulp-connect可以帮我们创建一个本地服务器去运行我们的项目<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install gulp-connect --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">    <span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">'gulp-connect'</span>);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'server'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       connect.server(&#123;</div><div class="line">           <span class="attr">root</span>:<span class="string">'dist'</span>,<span class="comment">//服务器的根目录</span></div><div class="line">           port:<span class="number">8080</span> <span class="comment">//服务器的地址，没有此配置项默认也是 8080</span></div><div class="line">       &#125;);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'default'</span>,[<span class="string">'server'</span>]); <span class="comment">//运行此任务的时候会在8080上启动服务器，</span></div></pre></td></tr></table></figure>
<h4 id="9-11自动刷新"><a href="#9-11自动刷新" class="headerlink" title="9.11自动刷新"></a>9.11自动刷新</h4><p>我们希望当文件变化的时候浏览器可以自动刷新，这样我们就不需要文件修改后手动去刷新浏览器了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line">    <span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">'gulp-connect'</span>);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'copy-html'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">         gulp.src(<span class="string">'app/index.html'</span>)<span class="comment">//指定源文件</span></div><div class="line">             .pipe(gulp.dest(<span class="string">'dist'</span>))<span class="comment">//拷贝到dist目录</span></div><div class="line">             .pipe(connect.reload());<span class="comment">//通知浏览器重启</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'watch'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        gulp.watch(<span class="string">'app/index.html'</span>,[<span class="string">'copy-html'</span>]);<span class="comment">//当index.html文件变化时执行copy-html任务</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'server'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        connect.server(&#123;</div><div class="line">            <span class="attr">root</span>:<span class="string">'dist'</span>,<span class="comment">//服务器的根目录</span></div><div class="line">            port:<span class="number">8080</span>, <span class="comment">//服务器的地址，没有此配置项默认也是 8080</span></div><div class="line">            livereload:<span class="literal">true</span><span class="comment">//启用实时刷新的功能</span></div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">    gulp.task(<span class="string">'default'</span>,[<span class="string">'server'</span>,<span class="string">'watch'</span>]);<span class="comment">//运行此任务的时候会在8080上启动服务器，</span></div></pre></td></tr></table></figure></p>
<h4 id="9-12jshint"><a href="#9-12jshint" class="headerlink" title="9.12jshint"></a>9.12jshint</h4><p>可以用此插件进行代码检查,注意必须同时安装jshint和gulp-jshint 全部选项<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install jshint gulp-jshint  --save-dev</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</div><div class="line">        jshint = <span class="built_in">require</span>(<span class="string">"gulp-jshint"</span>);</div><div class="line"></div><div class="line">    gulp.task(<span class="string">'jsLint'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        gulp.src(<span class="string">'src/*.js'</span>)</div><div class="line">        .pipe(jshint()) <span class="comment">//进行代码检查</span></div><div class="line">        .pipe(jshint.reporter()); <span class="comment">// 输出检查结果</span></div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<h2 id="10-项目实战"><a href="#10-项目实战" class="headerlink" title="10.项目实战"></a>10.项目实战</h2><h4 id="10-1生成项目"><a href="#10-1生成项目" class="headerlink" title="10.1生成项目"></a>10.1生成项目</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$    mkdir gulpstart</div><div class="line">$    cd gulpstart</div><div class="line">$    npm install generator-gulp-webapp@0.2.0 -g</div><div class="line">$    yo gulp-webapp gulpstart</div></pre></td></tr></table></figure>
<h4 id="10-2阅读gulpfile-js文件"><a href="#10-2阅读gulpfile-js文件" class="headerlink" title="10.2阅读gulpfile.js文件"></a>10.2阅读gulpfile.js文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* jshint node:true */</span></div><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"><span class="comment">// generated on 2015-10-15 using generator-gulp-webapp 0.2.0</span></div><div class="line"><span class="comment">//使用require把gulp引入进来</span></div><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 读取package.json中的devDependencies配置项，调用gulp api把相关的插件加载进来</div><div class="line"> * 返回一个object,每个key指向各自的插件，把对象赋值给 $,后面可以用$获取每个插件的引用</div><div class="line"> * 如果不使用gulp-load-plugins,就可以使用require引入插件 如</div><div class="line"> *  var sass = require('gulp-sass');</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">'gulp-load-plugins'</span>)();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 1.此插件是用来编译sass的</div><div class="line"> * 2.</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'styles'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//把执行结果返回，以便此任务可以跟后续的任务配合依次执行。将多个小的操作进行组合，连接在一起就是流，数据依次从源头穿过一个个的管道，依次执行，最终在底部得到结果，可以很好的进行数据的转换</span></div><div class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/styles/main.scss'</span>)<span class="comment">//读取此文件到数据流中</span></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 1.pipe是steam模块中负责传递流数据的方法，把前一个流里的数据以管道的方式传递给下一个管道。</div><div class="line">   * 2.标准的流当期中一个管道出错的时候会触发unpipe事件，会导致gulp报错并强制退出</div><div class="line">   * 我们现在监听main.scss文件的变化，一旦变化时会执行rubySass,但如果sass有语法错误，执行rubySass的时候会报错，会导致gulp报错并强制退出从而导致整个任务失败，watch就会失败，只能重启gulp服务。</div><div class="line">   * 然后不停的失败再重启，这样肯定是不可接受的。</div><div class="line">   * 3.plumber是水管工的意思，plumber通过替换pipe方法并移除onerror处理函数，这样即使有管道出问题了不会影响其它管道以及影响其它后续数据流的再处理。</div><div class="line">   * 当我们希望我们的管道能容忍容错的时候，就必须先通过plumber插件。</div><div class="line">   */</div><div class="line">      .pipe($.plumber())</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 通过 npm install gulp-ruby-sass 安装</div><div class="line">   */</div><div class="line">      .pipe($.rubySass(&#123;</div><div class="line">        <span class="attr">style</span>: <span class="string">'expanded'</span>,<span class="comment">// 设置编译出来的模式为expanded模式，一共有四种 nested(层级选择器嵌套) expanded(不嵌套) compact(属性合合并在一行) compressed(全部合并到一行)，请参考 http://sass-lang.com/documentation/file.SASS_REFERENCE.html#_13</span></div><div class="line">        precision: <span class="number">10</span> <span class="comment">//属性保留几位小数点 因为sass支持表达式，比如10/3,那么除不尽会有小数，我们尽可能保留完整，如果不能保留10位</span></div><div class="line">      &#125;))</div><div class="line">    <span class="comment">//需要厂商前缀的属性自动添加厂商前缀，只适配每种浏览器最新的一个版本</span></div><div class="line">      .pipe($.autoprefixer(&#123;<span class="attr">browsers</span>: [<span class="string">'last 1 version'</span>]&#125;))</div><div class="line">    <span class="comment">//处理完成后把流数据写入.tmp/styles目录</span></div><div class="line">      .pipe(gulp.dest(<span class="string">'.tmp/styles'</span>));</div><div class="line">&#125;);</div><div class="line">gulp.task(<span class="string">'jshint'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//对scripts目录下的JS进行校验，使用.jshintrc作为配置文件</span></div><div class="line">  <span class="comment">//配置文件说明 http://jinlong.github.io/2014/10/25/jshint-configuration/?utm_source=tuicool</span></div><div class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/scripts/**/*.js'</span>)</div><div class="line">      .pipe($.jshint())</div><div class="line">    <span class="comment">//校验结果传递给jshint-stylish reporter</span></div><div class="line">      .pipe($.jshint.reporter(<span class="string">'jshint-stylish'</span>))<span class="comment">//传递的是report的名称</span></div><div class="line">    <span class="comment">//当校验没通过时会通过stylish记录下错误信息并传递给fail reporter,并使当前任务失败</span></div><div class="line">      .pipe($.jshint.reporter(<span class="string">'fail'</span>));</div><div class="line">&#125;);</div><div class="line">gulp.task(<span class="string">'html'</span>, [<span class="string">'styles'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//lazypipe用来缓存一组管道配置，存起来稍后使用</span></div><div class="line">  <span class="keyword">var</span> lazypipe = <span class="built_in">require</span>(<span class="string">'lazypipe'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> cssChannel = lazypipe()</div><div class="line">    <span class="comment">//注意传递的是插件对象而不是插件方法调用</span></div><div class="line">    <span class="comment">//csso用来压缩css文件</span></div><div class="line">      .pipe($.csso)</div><div class="line">    <span class="comment">//替换内容</span></div><div class="line">      .pipe($.replace, <span class="string">'bower_components/bootstrap-sass-official/assets/fonts/bootstrap'</span>,<span class="string">'fonts'</span>);</div><div class="line">  <span class="comment">//通过解析html中的注释块来处理替换html中那些未经合并压缩的JS CSS等资源的引入</span></div><div class="line">  <span class="comment">//分成二步  assets 和 useref</span></div><div class="line">  <span class="comment">// assets方法用来生成检索资源文件的管道</span></div><div class="line">  <span class="keyword">var</span> assets = $.useref.assets(&#123;<span class="attr">searchPath</span>: <span class="string">'&#123;.tmp,app&#125;'</span>&#125;);<span class="comment">//指定在哪些目录中搜索 html文件，是相对于gulp</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/*.html'</span>)</div><div class="line">      .pipe(assets)<span class="comment">//检索传递进来的html文件，按注释指令对这些文件进行合并，然后生成一个新的流，将之前的HTML文件替换掉,新增加合并合的资源文件</span></div><div class="line">      .pipe($.<span class="keyword">if</span>(<span class="string">'*.js'</span>, $.uglify()))<span class="comment">//符合条件才能进入后面的流，如果是JS进行压缩再回归到主流</span></div><div class="line">      .pipe($.<span class="keyword">if</span>(<span class="string">'*.css'</span>, cssChannel()))<span class="comment">//如果是CSS文件，则先压缩CSS再替换fonts路径</span></div><div class="line">      .pipe(assets.restore())<span class="comment">//再回到主流，把删除的HTML文件添加回来</span></div><div class="line">      .pipe($.useref())<span class="comment">//修改原来注释块用修改后的引用地址替换掉原来的地址</span></div><div class="line">      .pipe($.<span class="keyword">if</span>(<span class="string">'*.html'</span>, $.minifyHtml(&#123;<span class="attr">conditionals</span>: <span class="literal">true</span><span class="comment">/*true不移除针对IE的注释*/</span>, <span class="attr">loose</span>: <span class="literal">true</span><span class="comment">/*压缩空格的时候至少保留一个空格*/</span>&#125;)))<span class="comment">//如果是html文件，则进行压缩</span></div><div class="line">      .pipe(gulp.dest(<span class="string">'dist'</span>));<span class="comment">//把处理后的文件输出到dist目录</span></div><div class="line">&#125;);</div><div class="line">gulp.task(<span class="string">'images'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'app/images/**/*'</span>)<span class="comment">//把图片读取入流中</span></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 为了避免图片多次压缩失真</div><div class="line">   * imagemin只负责压缩图片，不负责检查图片是否被压缩过</div><div class="line">   * 为了避免二次压缩使用$.cache，维护一份临时文件记录哪些文件已经被处理过了，处理过了则不再传递给它包装的管道。</div><div class="line">   */</div><div class="line">      .pipe($.cache($.imagemin(&#123;</div><div class="line">        <span class="attr">progressive</span>: <span class="literal">true</span>,<span class="comment">//针对jpg 图像逐行扫描，先以比较模糊的方式出现，再清晰。</span></div><div class="line">        interlaced: <span class="literal">true</span> <span class="comment">//针夺gif,隔行扫描的方式。比如先出奇数行，再出偶数行，一半的时间就可以看到轮廓。</span></div><div class="line">      &#125;)))</div><div class="line">      .pipe(gulp.dest(<span class="string">'dist/images'</span>));<span class="comment">//输出到images目录</span></div><div class="line">&#125;);</div><div class="line">gulp.task(<span class="string">'fonts'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//main-bower-files 读取所有的bower的文件并合并上所有的字体文件读取入流</span></div><div class="line">  <span class="keyword">return</span> gulp.src(<span class="built_in">require</span>(<span class="string">'main-bower-files'</span>)().concat(<span class="string">'app/fonts/**/*'</span>))</div><div class="line">      .pipe($.filter(<span class="string">'**/*.&#123;eot,svg,ttf,woff&#125;'</span>))<span class="comment">//类似于if,符合流转，不符合则被剔除</span></div><div class="line">      .pipe($.flatten())<span class="comment">//将相对路径移除</span></div><div class="line">      .pipe(gulp.dest(<span class="string">'dist/fonts'</span>));<span class="comment">//将字体文件写入fonts目录</span></div><div class="line">&#125;);</div><div class="line"><span class="comment">//将app下除了html以外的文件拷贝到dist目录 只拷贝一级</span></div><div class="line">gulp.task(<span class="string">'extras'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> gulp.src([</div><div class="line">    <span class="string">'app/*.*'</span>,</div><div class="line">    <span class="string">'!app/*.html'</span>,</div><div class="line">    <span class="string">'node_modules/apache-server-configs/dist/.htaccess'</span><span class="comment">//拷贝apache配置文件</span></div><div class="line">  ], &#123;</div><div class="line">    <span class="attr">dot</span>: <span class="literal">true</span><span class="comment">// node glob配置项，true时匹配以.开头的文件或文件夹</span></div><div class="line">  &#125;).pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">&#125;);</div><div class="line"><span class="comment">//删除.tmp和dist下的所有文件</span></div><div class="line">gulp.task(<span class="string">'clean'</span>, <span class="built_in">require</span>(<span class="string">'del'</span>).bind(<span class="literal">null</span>, [<span class="string">'.tmp'</span>, <span class="string">'dist'</span>]));</div><div class="line"><span class="comment">//等同于 gulp.task('clean',function()&#123;require('del')(['.tmp','dist'])&#125;);</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 1.connect会依赖styles</div><div class="line"> * 2.这是一个node扩展的http框架，可以使用中间件方便配置</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'connect'</span>, [<span class="string">'styles'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> serveStatic = <span class="built_in">require</span>(<span class="string">'serve-static'</span>);<span class="comment">//静态文件服务器中间件</span></div><div class="line">  <span class="keyword">var</span> serveIndex = <span class="built_in">require</span>(<span class="string">'serve-index'</span>);<span class="comment">//显示索引文件中间件</span></div><div class="line">  <span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'connect'</span>)()<span class="comment">//先创建connect对象叫app</span></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 此中间件就是自动为html插入livereload脚本，通过参数传递配置项参数</div><div class="line">   */</div><div class="line">      .use(<span class="built_in">require</span>(<span class="string">'connect-livereload'</span>)(&#123;<span class="attr">port</span>: <span class="number">35729</span>&#125;))<span class="comment">//实时重启服务器中间件</span></div><div class="line">      .use(serveStatic(<span class="string">'.tmp'</span>))<span class="comment">//对根目录的请求映射到.tmp目录</span></div><div class="line">      .use(serveStatic(<span class="string">'app'</span>))<span class="comment">//对根目录的请求映射到app目录</span></div><div class="line">    <span class="comment">//将对bower_components目录的访问定位到bower_components目录下</span></div><div class="line">      .use(<span class="string">'/bower_components'</span>, serveStatic(<span class="string">'bower_components'</span>))</div><div class="line">    <span class="comment">//参数为本地的一个文件目录，当路径命中这个目录的时候，而路径下没有index文件的时候会显示目录索引文件显示此目录下的所的文件</span></div><div class="line">      .use(serveIndex(<span class="string">'app'</span>));</div><div class="line">  <span class="comment">//加载http组件并创建http服务器，传入的参数app就是一个请求监听处理函数</span></div><div class="line">  <span class="comment">//当服务器接受请求的时候，会依次执行上面的一系列中间件，其实就是用请求路径在相应的文件夹里进行匹配，如果匹配上就返回</span></div><div class="line">  <span class="built_in">require</span>(<span class="string">'http'</span>).createServer(app)</div><div class="line">      .listen(<span class="number">9000</span>)</div><div class="line">    <span class="comment">//服务器监听成功后会输出此信息</span></div><div class="line">      .on(<span class="string">'listening'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Started connect web server on http://localhost:9000'</span>);</div><div class="line">      &#125;);</div><div class="line">&#125;);</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 1. 在命令行中执行 gulp serve 就可以自动打开浏览器，然后修改app/index.html就会实时刷新浏览器</div><div class="line"> * 2.因为watch依赖connect,所以这里connect可以省略</div><div class="line"> * 3.</div><div class="line"> *</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'serve'</span>, [<span class="string">'connect'</span>, <span class="string">'watch'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//打开浏览器并打开指定的URL地址</span></div><div class="line">  <span class="built_in">require</span>(<span class="string">'opn'</span>)(<span class="string">'http://localhost:9000'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//插入bower_component文件</span></div><div class="line">gulp.task(<span class="string">'wiredep'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> wiredep = <span class="built_in">require</span>(<span class="string">'wiredep'</span>).stream;</div><div class="line">  <span class="comment">//先处理sass文件对bower_component文件的依赖</span></div><div class="line">  gulp.src(<span class="string">'app/styles/*.scss'</span>)</div><div class="line">      .pipe(wiredep())</div><div class="line">      .pipe(gulp.dest(<span class="string">'app/styles'</span>));</div><div class="line"></div><div class="line">  <span class="comment">//处理app下的html文件对bower_component文件的依赖</span></div><div class="line">  gulp.src(<span class="string">'app/*.html'</span>)</div><div class="line">      .pipe(wiredep(&#123;<span class="attr">exclude</span>: [<span class="string">'bootstrap-sass-official'</span>]&#125;))<span class="comment">//排除bootstrap-sass-official</span></div><div class="line">      .pipe(gulp.dest(<span class="string">'app'</span>));</div><div class="line">&#125;);</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 1. watch依赖connect执行</div><div class="line"> * 2.</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'watch'</span>, [<span class="string">'connect'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 1.先调用livereload的listen方法启动监听,这样文件发生改动时就可以接收到变化通知了</div><div class="line">   * 原理都是一样的，即通过在本地开启一个websocket服务，检测文件变化，当文件被修改后触发livereload任务，推送消息给浏览器刷新页面。详情参考</div><div class="line">   * http://blog.csdn.net/u010373419/article/details/38184333?utm_source=tuicool</div><div class="line">   */</div><div class="line">  $.livereload.listen();</div><div class="line"></div><div class="line">  <span class="comment">//监听文件的变化，当文件发生变化的时候重启服务器</span></div><div class="line">  <span class="comment">//gulp.watch返回的一个eventEmitter对象，通过on change可以添加事件监听 ，当watch监控这些文件发生变化的时候可以发射change事件，从而调用$.livereload.changed监听函数执行，这就是订阅者设计模式</span></div><div class="line">  <span class="comment">//监听函数可以获得哪些文件发生了改变，通过livereload服务器哪些文件变更了，</span></div><div class="line">  gulp.watch([</div><div class="line">    <span class="string">'app/*.html'</span>,</div><div class="line">    <span class="string">'.tmp/styles/**/*.css'</span>,</div><div class="line">    <span class="string">'app/scripts/**/*.js'</span>,</div><div class="line">    <span class="string">'app/images/**/*'</span></div><div class="line">  ]).on(<span class="string">'change'</span>, $.livereload.changed);</div><div class="line">  <span class="comment">//当scss文件变化的时候重新编译sass</span></div><div class="line">  gulp.watch(<span class="string">'app/styles/**/*.scss'</span>, [<span class="string">'styles'</span>]);</div><div class="line">  <span class="comment">//当bower.json文件发生变化的时候自动重启把依赖的组件引入html文件</span></div><div class="line">  gulp.watch(<span class="string">'bower.json'</span>, [<span class="string">'wiredep'</span>]);</div><div class="line">&#125;);</div><div class="line"><span class="comment">/**</span></div><div class="line"> *编译</div><div class="line"> *</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'build'</span>, [<span class="string">'jshint'</span>, <span class="string">'html'</span>, <span class="string">'images'</span>, <span class="string">'fonts'</span>, <span class="string">'extras'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//size展示文件大小以及总的大小 gzip为true展示gzip压缩后的文件大小,展示的是项目的总大小</span></div><div class="line">  <span class="keyword">return</span> gulp.src(<span class="string">'dist/**/*'</span>).pipe($.size(&#123;<span class="attr">title</span>: <span class="string">'build'</span>, <span class="attr">gzip</span>: <span class="literal">true</span>&#125;));</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 组合任务</div><div class="line"> *</div><div class="line"> */</div><div class="line">gulp.task(<span class="string">'default'</span>, [<span class="string">'clean'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  gulp.start(<span class="string">'build'</span>);<span class="comment">//start 可以运行build任务</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="11-自定义插件"><a href="#11-自定义插件" class="headerlink" title="11.自定义插件"></a>11.自定义插件</h2><h4 id="11-1vinyl"><a href="#11-1vinyl" class="headerlink" title="11.1vinyl"></a>11.1vinyl</h4><p>gulp.src中这个流里的内容不是原始的文件流,而是一个虚拟文件对象流,这个虚拟文件对象中存储着原始文件的路径、文件名和内容等信息 vinyl<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> File = <span class="built_in">require</span>(<span class="string">'vinyl'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> indexFile = <span class="keyword">new</span> File(&#123;</div><div class="line">    <span class="attr">cwd</span>: <span class="string">"/"</span>,<span class="comment">//当前路径</span></div><div class="line">    base: <span class="string">"/test/"</span>,<span class="comment">//文件名</span></div><div class="line">    path: <span class="string">"/test/index.js"</span>,<span class="comment">//路径</span></div><div class="line">    contents: <span class="keyword">new</span> Buffer(<span class="string">"name=zfpx"</span>)<span class="comment">//文件内容</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(File.isVinyl(indexFile));<span class="comment">//是否是vinyl</span></div><div class="line"><span class="built_in">console</span>.log(indexFile.isBuffer());<span class="comment">//内容是否是Buffer</span></div><div class="line"><span class="built_in">console</span>.log(indexFile.isStream());<span class="comment">//内容是否是Stream</span></div></pre></td></tr></table></figure></p>
<h4 id="11-2through2"><a href="#11-2through2" class="headerlink" title="11.2through2"></a>11.2through2</h4><p><a href="https://www.npmjs.com/package/through2" target="_blank" rel="external">https://www.npmjs.com/package/through2</a> 二进制流的方式<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> through2 = <span class="built_in">require</span>(<span class="string">'through2'</span>);</div><div class="line"> <span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"> fs.createReadStream(<span class="string">'src.txt'</span>,&#123;<span class="attr">highWaterMark</span>:<span class="number">1</span>&#125;)</div><div class="line">     .pipe(through2(<span class="function"><span class="keyword">function</span> (<span class="params">chunk, encoding, callback</span>) </span>&#123;</div><div class="line">         <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; chunk.length; i++)</div><div class="line">             chunk[i] = chunk[i] + <span class="number">1</span>;</div><div class="line">         <span class="keyword">this</span>.push(chunk); <span class="comment">//向流中写数据,每push一次就发射一次data事件</span></div><div class="line">         callback();</div><div class="line">     &#125;)).on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(data.toString());</div><div class="line">     &#125;).on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'end'</span>);</div><div class="line"> &#125;)</div><div class="line"> <span class="comment">//.pipe(fs.createWriteStream('dest.txt'))</span></div></pre></td></tr></table></figure></p>
<p>对象方式<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> through2 = <span class="built_in">require</span>(<span class="string">'through2'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> all = [];</div><div class="line">fs.createReadStream(<span class="string">'src.txt'</span>, &#123;<span class="attr">highWaterMark</span>: <span class="number">1</span>&#125;)</div><div class="line">    .pipe(through2.obj(<span class="function"><span class="keyword">function</span> (<span class="params">chunk, enc, callback</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> data = &#123;</div><div class="line">            <span class="attr">name</span>: chunk.toString()</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.push(data);</div><div class="line">        callback();</div><div class="line">    &#125;))</div><div class="line">    .on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(data)</div><div class="line">    &#125;)</div><div class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'end'</span>)</div><div class="line">    &#125;)</div></pre></td></tr></table></figure></p>
<h4 id="11-3buffer往头部增加内容插件"><a href="#11-3buffer往头部增加内容插件" class="headerlink" title="11.3buffer往头部增加内容插件"></a>11.3buffer往头部增加内容插件</h4><p>如果你的插件依赖着一个基于 buffer 处理的库，你可能会选择让你的插件以 buffer 的形式来处理 file.contents。让我们来实现一个在文件头部插入额外文本的插件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> through = <span class="built_in">require</span>(<span class="string">'through2'</span>);</div><div class="line"><span class="keyword">var</span> PluginError = <span class="built_in">require</span>(<span class="string">'gulp-util'</span>).PluginError;</div><div class="line"><span class="keyword">const</span> PLUGIN_NAME = <span class="string">'gulp-prefixer'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 插件级别的函数（处理文件）</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">gulpPrefixer</span>(<span class="params">prefixText</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!prefixText) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PluginError(PLUGIN_NAME, <span class="string">'Missing prefix text!'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    prefixText = <span class="keyword">new</span> Buffer(prefixText); <span class="comment">// 提前分配</span></div><div class="line">     <span class="comment">// 创建一个 stream 通道，以让每个文件通过</span></div><div class="line">        <span class="keyword">var</span> stream = through.obj(<span class="function"><span class="keyword">function</span>(<span class="params">file, enc, cb</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (file.isStream()) &#123;</div><div class="line">                <span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="keyword">new</span> PluginError(PLUGIN_NAME, <span class="string">'Streams are not supported!'</span>));</div><div class="line">                <span class="keyword">return</span> cb();</div><div class="line">            &#125;</div><div class="line">    </div><div class="line">            <span class="keyword">if</span> (file.isBuffer()) &#123;</div><div class="line">                file.contents = Buffer.concat([prefixText, file.contents]);</div><div class="line">            &#125;</div><div class="line">    </div><div class="line">            <span class="comment">// 确保文件进入下一个 gulp 插件</span></div><div class="line">            <span class="keyword">this</span>.push(file);</div><div class="line">    </div><div class="line">            <span class="comment">// 告诉 stream 引擎，我们已经处理完了这个文件</span></div><div class="line">            cb();</div><div class="line">        &#125;);</div><div class="line">    </div><div class="line">        <span class="comment">// 返回文件 stream</span></div><div class="line">        <span class="keyword">return</span> stream;</div><div class="line">    &#125;;</div><div class="line"><span class="comment">// 导出插件主函数</span></div><div class="line"><span class="built_in">module</span>.exports = gulpPrefixer;</div></pre></td></tr></table></figure></p>
<p>上述的插件可以这样使用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line"><span class="keyword">var</span> gulpPrefixer = <span class="built_in">require</span>(<span class="string">'gulp-prefixer'</span>);</div><div class="line"></div><div class="line">gulp.src(<span class="string">'files/**/*.js'</span>)</div><div class="line">  .pipe(gulpPrefixer(<span class="string">'prepended string'</span>))</div><div class="line">  .pipe(gulp.dest(<span class="string">'modified-files'</span>));</div></pre></td></tr></table></figure></p>
<h4 id="11-4stream往头部增加内容插件"><a href="#11-4stream往头部增加内容插件" class="headerlink" title="11.4stream往头部增加内容插件"></a>11.4stream往头部增加内容插件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> through = <span class="built_in">require</span>(<span class="string">'through2'</span>);</div><div class="line"> <span class="keyword">var</span> PluginError = <span class="built_in">require</span>(<span class="string">'gulp-util'</span>).PluginError;</div><div class="line"></div><div class="line"> <span class="comment">//常量</span></div><div class="line"> <span class="keyword">const</span> PLUGIN_NAME = <span class="string">'gulp-prefixer'</span>;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">function</span> <span class="title">prefixStream</span>(<span class="params">prefixText</span>) </span>&#123;</div><div class="line">     <span class="keyword">var</span> stream = through();</div><div class="line">     stream.write(prefixText);</div><div class="line">     <span class="keyword">return</span> stream;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="comment">// 插件级别函数 (处理文件)</span></div><div class="line"> <span class="function"><span class="keyword">function</span> <span class="title">gulpPrefixer</span>(<span class="params">prefixText</span>) </span>&#123;</div><div class="line">     <span class="keyword">if</span> (!prefixText) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> PluginError(PLUGIN_NAME, <span class="string">'Missing prefix text!'</span>);</div><div class="line">     &#125;</div><div class="line">     prefixText = <span class="keyword">new</span> Buffer(prefixText); <span class="comment">// 预先分配</span></div><div class="line">     </div><div class="line">          <span class="comment">// 创建一个让每个文件通过的 stream 通道</span></div><div class="line">          <span class="keyword">var</span> stream = through.obj(<span class="function"><span class="keyword">function</span> (<span class="params">file, enc, cb</span>) </span>&#123;</div><div class="line">              <span class="keyword">if</span> (file.isBuffer()) &#123;</div><div class="line">                  <span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="keyword">new</span> PluginError(PLUGIN_NAME, <span class="string">'Buffers not supported!'</span>));</div><div class="line">                  <span class="keyword">return</span> cb();</div><div class="line">              &#125;</div><div class="line">     </div><div class="line">              <span class="keyword">if</span> (file.isStream()) &#123;</div><div class="line">                  <span class="comment">// 定义转换内容的 streamer</span></div><div class="line">                  <span class="keyword">var</span> streamer = prefixStream(prefixText);</div><div class="line">                  <span class="comment">// 从 streamer 中捕获错误，并发出一个 gulp的错误</span></div><div class="line">                  streamer.on(<span class="string">'error'</span>, <span class="keyword">this</span>.emit.bind(<span class="keyword">this</span>, <span class="string">'error'</span>));</div><div class="line">                  <span class="comment">// 开始转换</span></div><div class="line">                  file.contents = file.contents.pipe(streamer);</div><div class="line">              &#125;</div><div class="line">     </div><div class="line">              <span class="comment">// 确保文件进去下一个插件</span></div><div class="line">              <span class="keyword">this</span>.push(file);</div><div class="line">              <span class="comment">// 告诉 stream 转换工作完成</span></div><div class="line">              cb();</div><div class="line">          &#125;);</div><div class="line">     </div><div class="line">          <span class="comment">// 返回文件 stream</span></div><div class="line">          <span class="keyword">return</span> stream;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 暴露（export）插件的主函数</span></div><div class="line">       <span class="built_in">module</span>.exports = gulpPrefixer;</div></pre></td></tr></table></figure>
<p>上述的插件可以这样使用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</div><div class="line"><span class="keyword">var</span> gulpPrefixer = <span class="built_in">require</span>(<span class="string">'gulp-prefixer'</span>);</div><div class="line"></div><div class="line">gulp.src(<span class="string">'files/**/*.js'</span>, &#123; <span class="attr">buffer</span>: <span class="literal">false</span> &#125;)</div><div class="line">  .pipe(gulpPrefixer(<span class="string">'prepended string'</span>))</div><div class="line">  .pipe(gulp.dest(<span class="string">'modified-files'</span>));</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/27/gulp/" data-id="cj5m7x3b20000e8u2qs9bbqy3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/17/Blog/" class="article-date">
  <time datetime="2017-04-17T03:27:02.000Z" itemprop="datePublished">2017-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/17/Blog/">Blog</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h1><h2 id="一-使用Express生成器生成一个实例项目"><a href="#一-使用Express生成器生成一个实例项目" class="headerlink" title="一.使用Express生成器生成一个实例项目"></a>一.使用Express生成器生成一个实例项目</h2><h4 id="1-安装-Express"><a href="#1-安装-Express" class="headerlink" title="1.安装 Express"></a>1.安装 Express</h4><ul>
<li><p><strong>express 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install -g express-generator</div></pre></td></tr></table></figure>
</li>
<li><p><strong>安装 express 命令行工具，使用它我们可以初始化一个 express 项目。在命令行中输入：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ express -e zhufengpeixunblog</div><div class="line">$ cd zhufengpeixunblog &amp;&amp; npm install</div></pre></td></tr></table></figure>
</li>
<li><p><strong>执行结果中会显示生成的文件并提示后续的命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">E:\&gt;express -e zhufengpeixunblog</div><div class="line"></div><div class="line">   create : zhufengpeixunblog</div><div class="line">   create : zhufengpeixunblog/package.json</div><div class="line">   create : zhufengpeixunblog/app.js</div><div class="line">   create : zhufengpeixunblog/public</div><div class="line">   create : zhufengpeixunblog/routes</div><div class="line">   create : zhufengpeixunblog/routes/index.js</div><div class="line">   create : zhufengpeixunblog/routes/users.js</div><div class="line">   create : zhufengpeixunblog/public/images</div><div class="line">   create : zhufengpeixunblog/public/javascripts</div><div class="line">   create : zhufengpeixunblog/views</div><div class="line">   create : zhufengpeixunblog/views/index.ejs</div><div class="line">   create : zhufengpeixunblog/views/error.ejs</div><div class="line">   create : zhufengpeixunblog/public/stylesheets</div><div class="line">   create : zhufengpeixunblog/public/stylesheets/style.css</div><div class="line">   create : zhufengpeixunblog/bin</div><div class="line">   create : zhufengpeixunblog/bin/www</div><div class="line"></div><div class="line">   install dependencies:</div><div class="line">     &gt; cd zhufengpeixunblog &amp;&amp; npm install</div><div class="line"></div><div class="line">   run the app:</div><div class="line">     &gt; SET DEBUG=zhufengpeixunblog:* &amp; npm start</div></pre></td></tr></table></figure>
</li>
<li><p><strong>进入生成的目录并安装依赖</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">E:\&gt;cd zhufengpeixunblog &amp;&amp; npm install</div><div class="line"></div><div class="line">debug@2.2.0 node_modules\debug</div><div class="line">└── ms@0.7.1</div><div class="line"></div><div class="line">morgan@1.6.1 node_modules\morgan</div><div class="line">├── on-headers@1.0.1</div><div class="line">├── basic-auth@1.0.3</div><div class="line">├── depd@1.0.1</div><div class="line">└── on-finished@2.3.0 (ee-first@1.1.1)</div><div class="line"></div><div class="line">cookie-parser@1.3.5 node_modules\cookie-parser</div><div class="line">├── cookie@0.1.3</div><div class="line">└── cookie-signature@1.0.6</div><div class="line"></div><div class="line">serve-favicon@2.3.0 node_modules\serve-favicon</div><div class="line">├── ms@0.7.1</div><div class="line">├── etag@1.7.0</div><div class="line">├── fresh@0.3.0</div><div class="line">└── parseurl@1.3.0</div><div class="line"></div><div class="line">body-parser@1.13.3 node_modules\body-parser</div><div class="line">├── bytes@2.1.0</div><div class="line">├── content-type@1.0.1</div><div class="line">├── depd@1.0.1</div><div class="line">├── on-finished@2.3.0 (ee-first@1.1.1)</div><div class="line">├── qs@4.0.0</div><div class="line">├── iconv-lite@0.4.11</div><div class="line">├── http-errors@1.3.1 (statuses@1.2.1, inherits@2.0.1)</div><div class="line">├── type-is@1.6.9 (media-typer@0.3.0, mime-types@2.1.7)</div><div class="line">└── raw-body@2.1.4 (unpipe@1.0.0, iconv-lite@0.4.12)</div><div class="line"></div><div class="line">express@4.13.3 node_modules\express</div><div class="line">├── escape-html@1.0.2</div><div class="line">├── array-flatten@1.1.1</div><div class="line">├── path-to-regexp@0.1.7</div><div class="line">├── merge-descriptors@1.0.0</div><div class="line">├── content-type@1.0.1</div><div class="line">├── methods@1.1.1</div><div class="line">├── utils-merge@1.0.0</div><div class="line">├── content-disposition@0.5.0</div><div class="line">├── range-parser@1.0.3</div><div class="line">├── serve-static@1.10.0</div><div class="line">├── vary@1.0.1</div><div class="line">├── depd@1.0.1</div><div class="line">├── cookie@0.1.3</div><div class="line">├── cookie-signature@1.0.6</div><div class="line">├── fresh@0.3.0</div><div class="line">├── etag@1.7.0</div><div class="line">├── on-finished@2.3.0 (ee-first@1.1.1)</div><div class="line">├── parseurl@1.3.0</div><div class="line">├── qs@4.0.0</div><div class="line">├── finalhandler@0.4.0 (unpipe@1.0.0)</div><div class="line">├── accepts@1.2.13 (negotiator@0.5.3, mime-types@2.1.7)</div><div class="line">├── type-is@1.6.9 (media-typer@0.3.0, mime-types@2.1.7)</div><div class="line">├── proxy-addr@1.0.8 (forwarded@0.1.0, ipaddr.js@1.0.1)</div><div class="line">└── send@0.13.0 (destroy@1.0.3, ms@0.7.1, statuses@1.2.1, mime@1.3.4, http-errors@1.3.1)</div><div class="line"></div><div class="line">E:\zhufengpeixunblog&gt;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>设置环境变量并启动服务器,在命令行中执行下列命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SET DEBUG=zhufengpeixunblog:* &amp; npm start</div></pre></td></tr></table></figure>
</li>
<li><p><strong>执行完成后会显示</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zhufengpeixunblog:server Listening on port 3000 +0ms</div></pre></td></tr></table></figure>
</li>
<li><p><strong>在浏览器里访问 <a href="http://localhost:3000" target="_blank" rel="external">http://localhost:3000</a> 就可以显示欢迎页面</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Express</div><div class="line">Welcome to Express</div></pre></td></tr></table></figure>
</li>
<li><p><strong>刚才我们就用express生成器生成了一个使用ejs模板的示例工程。</strong></p>
<h4 id="2-推送至github"><a href="#2-推送至github" class="headerlink" title="2.推送至github"></a>2.推送至github</h4></li>
<li><strong>创建.gitignore文件。里面内容</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">node_modules</div><div class="line">.idea</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-提交到本地仓库"><a href="#3-提交到本地仓库" class="headerlink" title="3.提交到本地仓库"></a>3.提交到本地仓库</h4><ul>
<li><strong>git init 初始化仓库</strong></li>
<li><strong>git add -A 把所有的文件添加到暂存区</strong></li>
<li><p><strong>git commit -m”初始化珠峰博客” 把所有的修改添加到历史区</strong></p>
<h4 id="4-创建远程仓库"><a href="#4-创建远程仓库" class="headerlink" title="4.创建远程仓库"></a>4.创建远程仓库</h4></li>
<li><p><strong>在github上登陆</strong></p>
</li>
<li><strong>创建一个新的项目，请特别注意</strong></li>
<li><strong>一定不要勾选Initialize this repository with a README 前面的复选框</strong></li>
<li><strong>也不要去下拉框里选择 .gitignore 或license</strong></li>
<li><strong>要保持默认，直接点击 Create repository</strong><h4 id="5-推送到远程仓库"><a href="#5-推送到远程仓库" class="headerlink" title="5.推送到远程仓库"></a>5.推送到远程仓库</h4></li>
<li><strong>git remote add origin <a href="https://github.com/zhufengnodejs/zhufengblog.git" target="_blank" rel="external">https://github.com/zhufengnodejs/zhufengblog.git</a> 添加远程仓库的关联</strong></li>
<li><strong>git push -u origin master 把本地的仓库推送到远程服务器上去</strong><h2 id="二-项目文件分析"><a href="#二-项目文件分析" class="headerlink" title="二.项目文件分析"></a>二.项目文件分析</h2><h4 id="1-生成文件说明"><a href="#1-生成文件说明" class="headerlink" title="1.生成文件说明"></a>1.生成文件说明</h4></li>
<li><strong>app.js：express的主配置文件</strong></li>
<li><strong>package.json：存储着工程的信息及模块依赖，当在 dependencies 中添加依赖的模块时，运行 npm install，npm 会检查当前目录下的 package.json，并自动安装所有指定的模块</strong></li>
<li><strong>node_modules：存放 package.json 中安装的模块，当你在 package.json 添加依赖的模块并安装后，存放在这个文件夹下</strong></li>
<li><strong>public：存放 image、css、js 等文件</strong></li>
<li><strong>routes：存放路由文件</strong></li>
<li><strong>views：存放视图文件或者说模版文件</strong></li>
<li><strong>bin：可执行文件，可以从此启动服务器</strong><h4 id="2-app-js"><a href="#2-app-js" class="headerlink" title="2. app.js"></a>2. app.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>); <span class="comment">//加载node_modules下的express模块</span></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> favicon = <span class="built_in">require</span>(<span class="string">'serve-favicon'</span>);</div><div class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</div><div class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> routes = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div><div class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();<span class="comment">// 生成一个express实例 app</span></div><div class="line"></div><div class="line"><span class="comment">// view engine setup</span></div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));<span class="comment">//设置 views 文件夹为存放视图文件的目录, 即存放模板文件的地方,__dirname 为全局变量,存储当前正在执行的脚本所在的目录。</span></div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>); <span class="comment">//设置视图模板引擎为 ejs。</span></div><div class="line"></div><div class="line"><span class="comment">// uncomment after placing your favicon in /public</span></div><div class="line"><span class="comment">//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico'))); 设置/public/favicon.ico为favicon图标。</span></div><div class="line">app.use(logger(<span class="string">'dev'</span>)); <span class="comment">//加载日志中间件。</span></div><div class="line">app.use(bodyParser.json()); <span class="comment">//加载解析json的中间件。</span></div><div class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));<span class="comment">//加载解析urlencoded请求体的中间件。</span></div><div class="line">app.use(cookieParser()); <span class="comment">//加载解析cookie的中间件。</span></div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>))); <span class="comment">//设置public文件夹为存放静态文件的目录。</span></div><div class="line"></div><div class="line">app.use(<span class="string">'/'</span>, routes); <span class="comment">//根目录的路由</span></div><div class="line">app.use(<span class="string">'/users'</span>, users);<span class="comment">// 用户路由</span></div><div class="line"></div><div class="line"><span class="comment">// catch 404 and forward to error handler 捕获404错误，并转发到错误处理器。</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found'</span>);</div><div class="line">  err.status = <span class="number">404</span>;</div><div class="line">  next(err);</div><div class="line">&#125;);</div><div class="line"><span class="comment">// error handlers 错误处理器</span></div><div class="line"></div><div class="line"><span class="comment">// development error handler 开发环境下的错误处理</span></div><div class="line"><span class="comment">// will print stacktrace 将打印出堆栈信息</span></div><div class="line"><span class="keyword">if</span> (app.get(<span class="string">'env'</span>) === <span class="string">'development'</span>) &#123;</div><div class="line">  app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">    res.status(err.status || <span class="number">500</span>);</div><div class="line">    res.render(<span class="string">'error'</span>, &#123;</div><div class="line">      <span class="attr">message</span>: err.message,</div><div class="line">      <span class="attr">error</span>: err</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// production error handler 生产环境下的错误处理</span></div><div class="line"><span class="comment">// no stacktraces leaked to user 不向用户暴露堆栈信息</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  res.status(err.status || <span class="number">500</span>);</div><div class="line">  res.render(<span class="string">'error'</span>, &#123;</div><div class="line">    <span class="attr">message</span>: err.message,</div><div class="line">    <span class="attr">error</span>: &#123;&#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = app;  <span class="comment">//导出app供 bin/www 使用</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-bin-www"><a href="#3-bin-www" class="headerlink" title="3. bin/www"></a>3. bin/www</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env node  表明是 node 可执行文件。</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Module dependencies.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'../app'</span>);<span class="comment">// 引入我们上面app.js导出的app实例</span></div><div class="line"><span class="keyword">var</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'zhufengpeixunblog:server'</span>); <span class="comment">// 引入打印调试日志的debug模块，并设置名称。</span></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>); <span class="comment">//引入http</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get port from environment and store in Express. 从环境变量中获取端口号并存放到express中</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> port = normalizePort(process.env.PORT || <span class="string">'3000'</span>);<span class="comment">// 设置端口号</span></div><div class="line">app.set(<span class="string">'port'</span>, port); <span class="comment">//设置端口号</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Create HTTP server. 创建http服务器</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> server = http.createServer(app); </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Listen on provided port, on all network interfaces. 在所有的网络接口中监听提供的端口</div><div class="line"> */</div><div class="line"></div><div class="line">server.listen(port);</div><div class="line">server.on(<span class="string">'error'</span>, onError);<span class="comment">// 监听错误事件</span></div><div class="line">server.on(<span class="string">'listening'</span>, onListening); <span class="comment">//启动工程并监听3000端口，成功后打印 Express server listening on port 3000</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Normalize a port into a number, string, or false. 把一个端口处理成一个数字或字符串或者false</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizePort</span>(<span class="params">val</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> port = <span class="built_in">parseInt</span>(val, <span class="number">10</span>); <span class="comment">//先试图转成10进制数字</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="built_in">isNaN</span>(port)) &#123;</div><div class="line">    <span class="comment">// named pipe 转不成数字就当作命名管道来处理</span></div><div class="line">    <span class="keyword">return</span> val;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (port &gt;= <span class="number">0</span>) &#123;</div><div class="line">    <span class="comment">// port number 如果端口大于0就返回端口</span></div><div class="line">    <span class="keyword">return</span> port;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">//不是命名管道，也不是正常端口就返回false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Event listener for HTTP server "error" event. 服务器的错误事件监听器</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">error</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (error.syscall !== <span class="string">'listen'</span>) &#123; <span class="comment">//如果系统调用不是监听则抛出错误</span></div><div class="line">    <span class="keyword">throw</span> error;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> bind = <span class="keyword">typeof</span> port === <span class="string">'string'</span></div><div class="line">    ? <span class="string">'Pipe '</span> + port</div><div class="line">    : <span class="string">'Port '</span> + port;</div><div class="line"></div><div class="line">  <span class="comment">// handle specific listen errors with friendly messages 更友好的处理特定的监听错误</span></div><div class="line">  <span class="keyword">switch</span> (error.code) &#123; <span class="comment">//错误编码</span></div><div class="line">    <span class="keyword">case</span> <span class="string">'EACCES'</span>:<span class="comment">// 没有权限</span></div><div class="line">      <span class="built_in">console</span>.error(bind + <span class="string">' requires elevated privileges'</span>); 没有权限绑定指定的端口</div><div class="line">      process.exit(<span class="number">1</span>); <span class="comment">//异常退出</span></div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="string">'EADDRINUSE'</span>: <span class="comment">//端口被占用</span></div><div class="line">      <span class="built_in">console</span>.error(bind + <span class="string">' is already in use'</span>);<span class="comment">//端口被占用</span></div><div class="line">      process.exit(<span class="number">1</span>);<span class="comment">//异常退出</span></div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">throw</span> error; <span class="comment">//其它的情况抛出错误并中止进程</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Event listener for HTTP server "listening" event. 服务器的监听端口成功事件回调</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onListening</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> addr = server.address();<span class="comment">// 取得服务器的地址</span></div><div class="line">  <span class="keyword">var</span> bind = <span class="keyword">typeof</span> addr === <span class="string">'string'</span> <span class="comment">//监听地址如果是字符串返回命名管道名，如果是数字返回端口</span></div><div class="line">    ? <span class="string">'pipe '</span> + addr</div><div class="line">    : <span class="string">'port '</span> + addr.port;</div><div class="line">  debug(<span class="string">'Listening on '</span> + bind); <span class="comment">//记录日志</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-routes-index-js"><a href="#4-routes-index-js" class="headerlink" title="4. routes/index.js"></a>4. routes/index.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);<span class="comment">// 导入express模块</span></div><div class="line"><span class="keyword">var</span> router = express.Router();<span class="comment">// 生成一个路由实例</span></div><div class="line"></div><div class="line"><span class="comment">/* GET home page.  取得主页*/</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123; <span class="comment">//当用户访问根目录也就是 / 的时候执行此回调</span></div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;); <span class="comment">//渲染views/index.ejs模版并显示到浏览器中</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router; <span class="comment">//导出这个路由并在app.js中通过app.use('/', routes); 加载</span></div></pre></td></tr></table></figure>
<h4 id="5-views-index-ejs"><a href="#5-views-index-ejs" class="headerlink" title="5. views/index.ejs"></a>5. views/index.ejs</h4><p>在渲染模板时我们传入了一个变量 title 值为 express 字符串，模板引擎会将所有 &lt;%= title %&gt; 替换为 express ，然后将渲染后生成的html显示到浏览器中<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome to <span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="三-路由介绍"><a href="#三-路由介绍" class="headerlink" title="三.路由介绍"></a>三.路由介绍</h2><h4 id="1-工作原理"><a href="#1-工作原理" class="headerlink" title="1.工作原理"></a>1.工作原理</h4><p>routes/index.js 中有以下代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">/* GET home page. */</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure></p>
<p>这段代码的意思是当访问主页时，调用 ejs 模板引擎，来渲染 index.ejs 模版文件（即将 title 变量全部替换为字符串 Express），生成静态页面并显示在浏览器中。</p>
<h4 id="2-路由配置"><a href="#2-路由配置" class="headerlink" title="2.路由配置"></a>2.路由配置</h4><p>express 封装了多种 http 请求方式，主要只使用 get 和 post 两种，即 app.get() 和 app.post() 。 app.get() 和 app.post() 的第一个参数都为请求的路径，第二个参数为处理请求的回调函数，回调函数有两个参数分别是 req 和 res，代表请求信息和响应信息 。路径请求及对应的获取路径有以下几种形式：</p>
<ul>
<li><p><strong>req.query(处理 get 请求，获取查询字符串)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GET /index.html?name=zfpx</div><div class="line">req.query.name  -&gt; zfpx</div></pre></td></tr></table></figure>
</li>
<li><p><strong>req.params(处理 /:name 形式的 get 或 post 请求，获取请求参数)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// GET /user/zfpx </div><div class="line">req.params.name -&gt; zfpx</div></pre></td></tr></table></figure>
</li>
<li><p><strong>req.body(处理 post 请求，获取 post 请求体)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">req.body.name</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="四-模板引擎"><a href="#四-模板引擎" class="headerlink" title="四.模板引擎"></a>四.模板引擎</h2><h4 id="1-什么是模板引擎"><a href="#1-什么是模板引擎" class="headerlink" title="1.什么是模板引擎"></a>1.什么是模板引擎</h4><p>模板引擎（Template Engine）是一个将页面模板和要显示的数据结合起来生成 HTML 页面的工具。 如果说上面讲到的 express 中的路由控制方法相当于 MVC 中的控制器的话，那模板引擎就相当于 MVC 中的视图。</p>
<h4 id="2-ejs"><a href="#2-ejs" class="headerlink" title="2.ejs"></a>2.ejs</h4><p>ejs使用起来十分简单，而且与 express 集成良好。</p>
<h4 id="3-使用模板引擎"><a href="#3-使用模板引擎" class="headerlink" title="3. 使用模板引擎"></a>3. 使用模板引擎</h4><p>前面我们通过以下两行代码设置了模板文件的存储位置和使用的模板引擎：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：我们通过 express -e zhufengpeixunblog 只是初始化了一个使用 ejs 模板引擎的工程而已，比如 node_modules 下添加了 ejs 模块，views 文件夹下有 index.ejs 。并不是说强制该工程只能使用 ejs 不能使用其他的模板引擎比如 jade，真正指定使用哪个模板引擎的是 app.set(‘view engine’, ‘ejs’); 。<br></p>
<p>在 routes/index.js 中通过调用 res.render() 渲染模版，并将其产生的页面直接返回给客户端。它接受两个参数，第一个是模板的名称，即 views 目录下的模板文件名，扩展名 .ejs 可选。第二个参数是传递给模板的数据对象，用于模板翻译。</p>
<p>打开 views/index.ejs ，内容如下：</p>
<p><strong>index.ejs</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">/* GET home page. */</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure></p>
<p>当我们 res.render(‘index’, { title: ‘Express’ }); 时，模板引擎会把 &lt;%= title %&gt; 替换成 Express，然后把替换后的页面显示给用户。</p>
<p>渲染后生成的页面代码为：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Express<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Express<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome to Express<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意：我们通过 app.use(express.static(path.join(__dirname, ‘public’))) 设置了静态文件目录为 public 文件夹， 所以上面代码中的 href=’/stylesheets/style.css’ 就相当于 href=’public/stylesheets/style.css’ 。</p>
<p>ejs 的标签系统非常简单，它只有以下三种标签：</p>
<p>&lt;% code %&gt;：JavaScript 代码。 &lt;%= code %&gt;：显示替换过 HTML 特殊字符的内容。 &lt;%- code %&gt;：显示原始 HTML 内容。 注意： &lt;%= code %&gt; 和 &lt;%- code %&gt; 的区别，当变量 code 为普通字符串时，两者没有区别。当 code 比如为<br>:hello这种字符串时，&lt;%= code %&gt; 会原样输出hello，而 &lt;%- code %&gt; 则会显示 H1 大的 hello 字符串。</p>
<h4 id="4-页面布局"><a href="#4-页面布局" class="headerlink" title="4.页面布局"></a>4.页面布局</h4><p>这里我们不使用layout进行页面布局，而是使用更为简单灵活的include。include 的简单使用如下：</p>
<p><strong>index.ejs</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;%- include a %&gt;</div><div class="line">hello,world!</div><div class="line">&lt;%- include b %&gt;</div></pre></td></tr></table></figure></p>
<p><strong>a.ejs</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is a.ejs</div></pre></td></tr></table></figure></p>
<p><strong>b.ejs</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is b.ejs</div></pre></td></tr></table></figure></p>
<p>最终 index.ejs 会显示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">this is a.ejs</div><div class="line">hello,world!</div><div class="line">this is b.ejs</div></pre></td></tr></table></figure></p>
<h2 id="五-路由规划"><a href="#五-路由规划" class="headerlink" title="五.路由规划"></a>五.路由规划</h2><h4 id="1-路由规划"><a href="#1-路由规划" class="headerlink" title="1.路由规划"></a>1.路由规划</h4><p>我们已经把设计的构想图贴出来了，接下来的任务就是完成路由规划了。路由规划，或者说控制器规划是整个网站的骨架部分，因为它处于整个架构的枢纽位置，相当于各个接口之间的粘合剂，所以应该优先考虑。</p>
<ul>
<li>/ ：首页</li>
<li>/users/login ：用户登录</li>
<li>/users/reg ：用户注册</li>
<li>/articles/post ：发表文章</li>
<li>/articles/logout ：登出<h4 id="2-增加路由"><a href="#2-增加路由" class="headerlink" title="2.增加路由"></a>2.增加路由</h4>routes/users.js 中添加下列代码<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 用户注册</div><div class="line"> */</div><div class="line">router.get(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'user/reg'</span>, &#123;<span class="attr">title</span>: <span class="string">'注册'</span>&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 当填写用户注册信息提交时的处理</div><div class="line"> */</div><div class="line">router.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 显示用户登录表单</div><div class="line"> */</div><div class="line">router.get(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'user/login'</span>, &#123;<span class="attr">title</span>: <span class="string">'登录'</span>&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 当填写用户登录信息提交时的处理</div><div class="line"> */</div><div class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.get(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>routes/articles.js 中添加下列代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'article/add'</span>, &#123; <span class="attr">title</span>: <span class="string">'发表文章'</span> &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.post(<span class="string">'/add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="2-修改app-js"><a href="#2-修改app-js" class="headerlink" title="2.修改app.js"></a>2.修改app.js</h4><p>app.js中添加以下代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> articles = <span class="built_in">require</span>(<span class="string">'./routes/article'</span>);</div><div class="line">app.use(<span class="string">'/articles'</span>, articles);</div></pre></td></tr></table></figure></p>
<h4 id="3-增加模板"><a href="#3-增加模板" class="headerlink" title="3.增加模板"></a>3.增加模板</h4><p>views下增加以下文件</p>
<ul>
<li><p><strong>views/article/add.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;%= title %&gt;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>views/user/login.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;%= title %&gt;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>views/user/reg.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;%= title %&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-效果"><a href="#4-效果" class="headerlink" title="4.效果"></a>4.效果</h4><p><strong>用户注册</strong></p>
<ul>
<li><a href="http://localhost:3000/users/reg" target="_blank" rel="external">http://localhost:3000/users/reg</a></li>
</ul>
<p><strong>用户登陆</strong></p>
<ul>
<li><a href="http://localhost:3000/users/login" target="_blank" rel="external">http://localhost:3000/users/login</a></li>
</ul>
<p><strong>发表文章</strong></p>
<ul>
<li><a href="http://localhost:3000/articles/add" target="_blank" rel="external">http://localhost:3000/articles/add</a></li>
</ul>
<h2 id="六-开发准备"><a href="#六-开发准备" class="headerlink" title="六.开发准备"></a>六.开发准备</h2><h4 id="1-mongodb"><a href="#1-mongodb" class="headerlink" title="1.mongodb"></a>1.mongodb</h4><p>mongodb初级入门</p>
<p>mongoose实用教程</p>
<h4 id="2-node会话"><a href="#2-node会话" class="headerlink" title="2.node会话"></a>2.node会话</h4><p>node会话</p>
<h4 id="3-MD5加密算法"><a href="#3-MD5加密算法" class="headerlink" title="3.MD5加密算法"></a>3.MD5加密算法</h4><p><strong>算法简介</strong></p>
<p>MD5的全称是Message-Digest Algorithm 5（信息-摘要算法），在90年代初由Mit Laboratory for Computer Science和Rsa data security inc的Ronald l. rivest开发出来，经md2、md3和md4发展而来。它的作用是让大容量信息在用数字签名软件签署私人密匙前被“压缩”成一种保密的格式（就是把一个任意长度的字节串变换成一定长的大整数）.不管是md2、md4还是md5，它们都需要获得一个随机长度的信息并产生一个128位的信息摘要.<br>MD5 算法的哈希值大小为 128 位。是一种不可逆的算法。</p>
<p><strong>算法特点</strong></p>
<ul>
<li>两个不同的明文不会得到相同的输出值</li>
<li>MD5结果不能反推明文，不可逆</li>
</ul>
<p><strong>安全性</strong></p>
<p>从安全的角度讲，MD5的输出为128位，若采用纯强力攻击寻找一个消息具有给定Hash值的计算困难性为2128，用每秒可试验1000000000个消息的计算机需时1.07×1022年。若采用生日攻击法，寻找有相同Hash值的两个消息需要试验264个消息，用每秒可试验1000000000个消息的计算机需时585年。<br> 实际应用上，例如我知道‘password’的MD5值是5f4dcc3b5aa765d61d8327deb882cf99，那么我就用一个数据库存起来，只要我看到5f4dcc3b5aa765d61d8327deb882cf99，我就知道这个是口令‘password‘使用MD5处理之后的值，原来的口令就是’password’。MD5在身份鉴别系统中用于口令保护已经是很久了事情了，大部分黑客也有针对这种Hash方式准备相应的数据库进行反查，这种数据库称为彩虹表，MD5的安全性大大减弱。</p>
<p><strong>MD5加密例程</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</div><div class="line"><span class="keyword">var</span> content = <span class="string">'password'</span></div><div class="line"><span class="keyword">var</span> md5 = crypto.createHash(<span class="string">'md5'</span>);</div><div class="line">md5.update(content);</div><div class="line"><span class="keyword">var</span> d = md5.digest(<span class="string">'hex'</span>);  <span class="comment">//MD5值是5f4dcc3b5aa765d61d8327deb882cf99</span></div></pre></td></tr></table></figure></p>
<p><strong>SHA1算法</strong></p>
<p>SHA1的全称是Secure Hash Algorithm(安全哈希算法)。加密哈希函数将任意长度的二进制字符串映射为固定长度的小型二进制字符串。加密哈希函数有这样一个属性：在计算上不大可能找到散列为相同的值的两个不同的输入；也就是说，两组数据的哈希值仅在对应的数据也匹配时才会匹配。数据的少量更改会在哈希值中产生不可预知的大量更改。所以你很难从加密后的文字中找到蛛丝马迹。<br>SHA1 算法的哈希值大小为 160 位。是一种不可逆的算法。</p>
<p><strong>SHA1加密例程</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</div><div class="line"><span class="keyword">var</span> content = <span class="string">'password'</span></div><div class="line"><span class="keyword">var</span> shasum = crypto.createHash(<span class="string">'sha1'</span>);</div><div class="line">shasum.update(content);</div><div class="line"><span class="keyword">var</span> d = shasum.digest(<span class="string">'hex'</span>);</div></pre></td></tr></table></figure></p>
<p><strong>MD5与sha1的不同点</strong></p>
<p>MD5最后生成的摘要信息是16个字节，SHA1是20个字节。</p>
<h2 id="七-初始化bower"><a href="#七-初始化bower" class="headerlink" title="七.初始化bower"></a>七.初始化bower</h2><h4 id="1-初始化bower"><a href="#1-初始化bower" class="headerlink" title="1.初始化bower"></a>1.初始化bower</h4><p>先执行此命令，然后会执行一系列交互问答 bower init<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">E:\zhufengpeixunblog&gt;bower init</div><div class="line">? name: zhufengpeixunblog</div><div class="line">? version: 0.0.0</div><div class="line">? description:</div><div class="line">? main file:</div><div class="line">? what types of modules does this package expose?</div><div class="line">? keywords:</div><div class="line">? authors: zhangrenyang-t510 &lt;zhang_renyang@&gt;</div><div class="line">? license: MIT</div><div class="line">? homepage:</div><div class="line">? set currently installed components as dependencies? Yes</div><div class="line">? add commonly ignored files to ignore list? Yes</div><div class="line">? would you like to mark this package as private which prevents it from being accidentally published to the regis</div><div class="line">? would you like to mark this package as private which prevents it from being accidentally published to the regis</div><div class="line"></div><div class="line">&#123;</div><div class="line">  name: &apos;zhufengpeixunblog&apos;,</div><div class="line">  version: &apos;0.0.0&apos;,</div><div class="line">  authors: [</div><div class="line">    &apos;zhangrenyang-t510 &lt;zhang_renyang@&gt;&apos;</div><div class="line">  ],</div><div class="line">  license: &apos;MIT&apos;,</div><div class="line">  ignore: [</div><div class="line">    &apos;**/.*&apos;,</div><div class="line">    &apos;node_modules&apos;,</div><div class="line">    &apos;bower_components&apos;,</div><div class="line">    &apos;test&apos;,</div><div class="line">    &apos;tests&apos;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"></div><div class="line">? Looks good? Yes</div></pre></td></tr></table></figure></p>
<p>执行完此命令后会生成一个 bower.json 文件。</p>
<h4 id="2-创建配置文件-bowerrc"><a href="#2-创建配置文件-bowerrc" class="headerlink" title="2.创建配置文件 .bowerrc"></a>2.创建配置文件 .bowerrc</h4><p>里面内容如下:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"directory"</span>:<span class="string">"./public/lib"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>这表示以后bower安装的模块都安装在./public/lib下面。</p>
<h4 id="3-安装bootstrap"><a href="#3-安装bootstrap" class="headerlink" title="3.安装bootstrap"></a>3.安装bootstrap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bower install bootstrap --save</div></pre></td></tr></table></figure>
<p>大家可以看到，不但安装了bootstrap,也安装了依赖的jquery<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">E:\zhufengpeixunblog&gt;bower install bootstrap --save</div><div class="line">bower bootstrap#*               cached git://github.com/twbs/bootstrap.git#3.3.5</div><div class="line">bower bootstrap#*             validate 3.3.5 against git://github.com/twbs/bootstrap.git#*</div><div class="line">bower jquery#&gt;= 1.9.1           cached git://github.com/jquery/jquery.git#2.1.4</div><div class="line">bower jquery#&gt;= 1.9.1         validate 2.1.4 against git://github.com/jquery/jquery.git#&gt;= 1.9.1</div><div class="line">bower bootstrap#~3.3.5         install bootstrap#3.3.5</div><div class="line">bower jquery#&gt;= 1.9.1          install jquery#2.1.4</div><div class="line"></div><div class="line">bootstrap#3.3.5 public\lib\bootstrap</div><div class="line">└── jquery#2.1.4</div><div class="line"></div><div class="line">jquery#2.1.4 public\lib\jquery</div></pre></td></tr></table></figure></p>
<h2 id="八-完善页面"><a href="#八-完善页面" class="headerlink" title="八.完善页面"></a>八.完善页面</h2><h4 id="1-在views下创建include文件夹，在include下添加包含的头部"><a href="#1-在views下创建include文件夹，在include下添加包含的头部" class="headerlink" title="1.在views下创建include文件夹，在include下添加包含的头部"></a>1.在views下创建include文件夹，在include下添加包含的头部</h4><p>header.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html lang=&quot;zh-CN&quot;&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</div><div class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</div><div class="line">    &lt;title&gt;珠峰博客&lt;/title&gt;</div><div class="line">    &lt;link href=&quot;/lib/bootstrap/dist/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;!--最外面的容器nav标签，并添加nav-bar样式类，表示这里面属于导航条 --&gt;</div><div class="line">&lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt;</div><div class="line">    &lt;!--第二步：增加header--&gt;</div><div class="line">    &lt;div class=&quot;navbar-header&quot;&gt;</div><div class="line">        &lt;!--最左侧的，默认不可见 按钮标签里嵌套了三个span的icon。然后给与navbar-toggle样式类和属性collapse(收起)，点击的时候目标为data-target。当窗口缩小到一定程度，右侧的效果显现。--&gt;</div><div class="line">        &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#menus&quot;&gt;</div><div class="line">            &lt;span class=&quot;sr-only&quot;&gt;珠峰博客&lt;/span&gt;</div><div class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">        &lt;/button&gt;</div><div class="line">        &lt;a href=&quot;/&quot; class=&quot;navbar-brand&quot;&gt;珠峰博客&lt;/a&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;!-- 放置其它的导航条 --&gt;</div><div class="line">    &lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;menus&quot;&gt;</div><div class="line">        &lt;ul class=&quot;nav navbar-nav&quot;&gt;</div><div class="line">            &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;/users/reg&quot;&gt;注册&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/users/login&quot;&gt;登录&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/articles/add&quot;&gt;发表文章&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/users/logout&quot;&gt;登出&lt;/a&gt;&lt;/li&gt;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/nav&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-在include下添加包含的尾部"><a href="#2-在include下添加包含的尾部" class="headerlink" title="2.在include下添加包含的尾部"></a>2.在include下添加包含的尾部</h4><p>footer.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;/lib/jquery/dist/jquery.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;script src=&quot;/lib/bootstrap/dist/js/bootstrap.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h4 id="3-修改首页"><a href="#3-修改首页" class="headerlink" title="3.修改首页"></a>3.修改首页</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;% include include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line"> 主页</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<p>效果如下:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://7xjf2l.com2.z0.glb.qiniucdn.com/homepage.jpg"</span> <span class="attr">class</span>=<span class="string">"img-responsive"</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="4-修改用户注册页面"><a href="#4-修改用户注册页面" class="headerlink" title="4.修改用户注册页面"></a>4.修改用户注册页面</h4><p>views/user/reg.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&lt;% include ../include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line">    &lt;form action=&quot;/users/reg&quot; method=&quot;post&quot;  role=&quot;form&quot; class=&quot;form-horizontal&quot;&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;username&quot; class=&quot;col-sm-2 control-label&quot;&gt;用户名&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt; &lt;span class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/span&gt; &lt;/div&gt;</div><div class="line">                &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;username&quot; name=&quot;username&quot; placeholder=&quot;用户名&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line"></div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;email&quot; class=&quot;col-sm-2 control-label&quot;&gt;邮箱&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-envelope&quot;&gt;&lt;/span&gt;&lt;/div&gt;</div><div class="line">                &lt;input type=&quot;email&quot; class=&quot;form-control&quot; name=&quot;email&quot; id=&quot;email&quot; placeholder=&quot;邮箱&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;password&quot; class=&quot;col-sm-2 control-label&quot;&gt;确认密码&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-lock&quot;&gt;&lt;/span&gt;&lt;/div&gt;</div><div class="line">&lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; id=&quot;password&quot; placeholder=&quot;密码&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;repassword&quot; class=&quot;col-sm-2 control-label&quot;&gt;确认密码&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-lock&quot;&gt;&lt;/span&gt;&lt;/div&gt;</div><div class="line">                &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;repassword&quot; id=&quot;repassword&quot; placeholder=&quot;确认密码&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;div class=&quot;col-sm-offset-2 col-sm-10&quot;&gt;</div><div class="line">                &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">                &lt;button type=&quot;reset&quot; class=&quot;btn btn-default&quot;&gt;重置&lt;/button&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include ../include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h4 id="5-修改用户登录界面"><a href="#5-修改用户登录界面" class="headerlink" title="5.修改用户登录界面"></a>5.修改用户登录界面</h4><p>views/user/login.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&lt;% include ../include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line">    &lt;form action=&quot;/users/login&quot; method=&quot;post&quot;  role=&quot;form&quot; class=&quot;form-horizontal&quot;&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;username&quot; class=&quot;col-sm-2 control-label&quot;&gt;用户名&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt; &lt;span class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/span&gt; &lt;/div&gt;</div><div class="line">                &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;username&quot; name=&quot;username&quot; placeholder=&quot;用户名&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line"></div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;password&quot; class=&quot;col-sm-2 control-label&quot;&gt;确认密码&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-lock&quot;&gt;&lt;/span&gt;&lt;/div&gt;</div><div class="line">                &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; id=&quot;password&quot; placeholder=&quot;密码&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;div class=&quot;col-sm-offset-2 col-sm-10&quot;&gt;</div><div class="line">                &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">                &lt;button type=&quot;reset&quot; class=&quot;btn btn-default&quot;&gt;重置&lt;/button&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include ../include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h4 id="6-修改发表文章页面"><a href="#6-修改发表文章页面" class="headerlink" title="6.修改发表文章页面"></a>6.修改发表文章页面</h4><p>views/article/add.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;% include ../include/header.ejs%&gt;</div><div class="line">  &lt;div class=&quot;container&quot;&gt;</div><div class="line">      &lt;form action=&quot;/articles/add&quot; method=&quot;post&quot;  role=&quot;form&quot; class=&quot;form-horizontal&quot;&gt;</div><div class="line">          &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">              &lt;label for=&quot;title&quot; class=&quot;col-sm-2 control-label&quot;&gt;标题&lt;/label&gt;</div><div class="line">              &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                  &lt;input type=&quot;text&quot; value=&quot;&quot; class=&quot;form-control&quot; id=&quot;title&quot; name=&quot;title&quot; placeholder=&quot;标题&quot;/&gt;</div><div class="line">              &lt;/div&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">          &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">              &lt;label for=&quot;content&quot; class=&quot;col-sm-2 control-label&quot;&gt;正文&lt;/label&gt;</div><div class="line">              &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                  &lt;textarea class=&quot;form-control&quot;   id=&quot;&quot; cols=&quot;30&quot; rows=&quot;10&quot; id=&quot;content&quot; name=&quot;content&quot; placeholder=&quot;请输入内容&quot;&gt;&lt;/textarea&gt;</div><div class="line">              &lt;/div&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">          &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">              &lt;div class=&quot;col-sm-offset-2 col-sm-10&quot;&gt;</div><div class="line">                  &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">                  &lt;button type=&quot;reset&quot; class=&quot;btn btn-default&quot;&gt;重置&lt;/button&gt;</div><div class="line">              &lt;/div&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">      &lt;/form&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;% include ../include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h2 id="九-连接数据库"><a href="#九-连接数据库" class="headerlink" title="九.连接数据库"></a>九.连接数据库</h2><h4 id="1-安装数据库支持"><a href="#1-安装数据库支持" class="headerlink" title="1. 安装数据库支持"></a>1. 安装数据库支持</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install mongoose --save</div></pre></td></tr></table></figure>
<p>安装mongodb模块到node_modules下面并把此配置添加到package.json文件中</p>
<h4 id="2-在工程根目录下创建-settings-js-文件"><a href="#2-在工程根目录下创建-settings-js-文件" class="headerlink" title="2.在工程根目录下创建 settings.js 文件"></a>2.在工程根目录下创建 settings.js 文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">cookieSecret</span>:<span class="string">'zhufengkey'</span>, <span class="comment">//用于 Cookie 加密与数据库无关</span></div><div class="line">    db:<span class="string">'zhufengblog'</span>,<span class="comment">//数据库的名称</span></div><div class="line">    host:<span class="string">'123.57.143.189'</span>, <span class="comment">//数据库的地址</span></div><div class="line">    port:<span class="number">27017</span>,  <span class="comment">//数据库的端口号</span></div><div class="line">    url:<span class="string">"mongodb://123.57.143.189:27017/zhufengblog"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-编写数据库交互-创建db文件夹-在db文件夹下创建文件models-js"><a href="#3-编写数据库交互-创建db文件夹-在db文件夹下创建文件models-js" class="headerlink" title="3.编写数据库交互 创建db文件夹 在db文件夹下创建文件models.js"></a>3.编写数据库交互 创建db文件夹 在db文件夹下创建文件models.js</h4><p>此文件存放着所有的模型<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line"><span class="keyword">var</span> ObjectId = mongoose.Schema.Types.ObjectId;</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">User</span>:&#123; <span class="comment">//设置User的数据模型 </span></div><div class="line">        username:&#123;<span class="attr">type</span>:<span class="built_in">String</span>,<span class="attr">required</span>:<span class="literal">true</span>&#125;,<span class="comment">//用户名</span></div><div class="line">        password:&#123;<span class="attr">type</span>:<span class="built_in">String</span>,<span class="attr">required</span>:<span class="literal">true</span>&#125;,<span class="comment">//密码</span></div><div class="line">        email:&#123;<span class="attr">type</span>:<span class="built_in">String</span>,<span class="attr">required</span>:<span class="literal">true</span>&#125;,<span class="comment">//邮箱</span></div><div class="line">        avatar:&#123;<span class="attr">type</span>:<span class="built_in">String</span>,<span class="attr">required</span>:<span class="literal">true</span>&#125;<span class="comment">//头像</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">Article</span>: &#123; <span class="comment">//设置文章的数据模型</span></div><div class="line">        user:&#123;<span class="attr">type</span>:ObjectId,<span class="attr">ref</span>:<span class="string">'User'</span>&#125;, <span class="comment">//用户</span></div><div class="line">        title: <span class="built_in">String</span>, <span class="comment">//标题</span></div><div class="line">        content: <span class="built_in">String</span>, <span class="comment">//内容</span></div><div class="line">        createAt:&#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now&#125; <span class="comment">//创建时间</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-在db文件夹下创建文件index-js"><a href="#4-在db文件夹下创建文件index-js" class="headerlink" title="4.在db文件夹下创建文件index.js"></a>4.在db文件夹下创建文件index.js</h4><p>此文件负责向外暴露模型,因为Model赋给了global作为属性，那就意味着在程序任何地方都可以调用了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>),</div><div class="line">    Schema = mongoose.Schema,</div><div class="line">    models = <span class="built_in">require</span>(<span class="string">'./models'</span>);</div><div class="line"><span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'../settings'</span>);    </div><div class="line">mongoose.connect(settings.url);</div><div class="line">mongoose.model(<span class="string">'User'</span>, <span class="keyword">new</span> Schema(models.User));</div><div class="line">mongoose.model(<span class="string">'Article'</span>, <span class="keyword">new</span> Schema(models.Article));</div><div class="line">global.Model = <span class="function"><span class="keyword">function</span> (<span class="params">type</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> mongoose.model(type);;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h4 id="5-在app-js中添加"><a href="#5-在app-js中添加" class="headerlink" title="5.在app.js中添加"></a>5.在app.js中添加</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>(<span class="string">'./db'</span>); <span class="comment">//导入db模块</span></div></pre></td></tr></table></figure>
<h2 id="十-实现会话支持"><a href="#十-实现会话支持" class="headerlink" title="十.实现会话支持"></a>十.实现会话支持</h2><h4 id="1-安装会话支持模块"><a href="#1-安装会话支持模块" class="headerlink" title="1.安装会话支持模块"></a>1.安装会话支持模块</h4><p>使用 express-session 和 connect-mongo 模块实现了将会话信息存储到mongodb中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install express-session --save</div><div class="line">npm install connect-mongo --save</div></pre></td></tr></table></figure></p>
<h4 id="2-修改app-js-1"><a href="#2-修改app-js-1" class="headerlink" title="2.修改app.js"></a>2.修改app.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'./settings'</span>);</div><div class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</div><div class="line"><span class="keyword">var</span> MongoStore = <span class="built_in">require</span>(<span class="string">'connect-mongo'</span>)(session);</div><div class="line">app.use(session(&#123;</div><div class="line">  <span class="attr">secret</span>: settings.cookieSecret,<span class="comment">//secret 用来防止篡改 cookie</span></div><div class="line">  key: settings.db,<span class="comment">//key 的值为 cookie 的名字</span></div><div class="line">  cookie: &#123;<span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>&#125;,<span class="comment">//设定 cookie 的生存期，这里我们设置 cookie 的生存期为 30 天</span></div><div class="line">  resave:<span class="literal">true</span>,</div><div class="line">  <span class="attr">saveUninitialized</span>:<span class="literal">true</span>,</div><div class="line">  <span class="attr">store</span>: <span class="keyword">new</span> MongoStore(&#123; <span class="comment">//设置它的 store 参数为 MongoStore 实例，把会话信息存储到数据库中，以避免重启服务器时会话丢失</span></div><div class="line">    db: settings.db,</div><div class="line">    <span class="attr">host</span>: settings.host,</div><div class="line">    <span class="attr">port</span>: settings.port,</div><div class="line">  &#125;)</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>添加完了以后我们就可以路由中通过request.session来操作会话对象了.</p>
<h2 id="十一-用户注册登陆"><a href="#十一-用户注册登陆" class="headerlink" title="十一.用户注册登陆"></a>十一.用户注册登陆</h2><h4 id="1-增加工具方法"><a href="#1-增加工具方法" class="headerlink" title="1.增加工具方法"></a>1.增加工具方法</h4><p>在routes/users.js中增加md5加密的工具方法<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5</span>(<span class="params">val</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">'crypto'</span>).createHash(<span class="string">'md5'</span>).update(val).digest(<span class="string">'hex'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="2-用户注册路由"><a href="#2-用户注册路由" class="headerlink" title="2.用户注册路由"></a>2.用户注册路由</h4><p>注册表单的form中action=”/users/reg”,所以我们要实现用户注册的路由 修改 routes/users.js 中的 router.post(‘/reg’…<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  <span class="comment">//就是 POST 请求信息解析过后的对象，例如我们要访问 POST 来的表单内的 name="username" 域的值，只需访问 req.body['username'] 或 req.body.username 即可。</span></div><div class="line">  <span class="keyword">var</span> user = req.body;<span class="comment">//</span></div><div class="line">  <span class="keyword">if</span>(user.password != user.repassword)&#123;</div><div class="line">    req.flash(<span class="string">'error'</span>,<span class="string">'两次输入的密码不一致'</span>);</div><div class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'/users/reg'</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">delete</span> user.repassword; <span class="comment">//由于repassword不需要保存，所以可以删除</span></div><div class="line">  user.password = md5(user.password); <span class="comment">//对密码进行md5加密</span></div><div class="line">  user.avatar = <span class="string">"https://secure.gravatar.com/avatar/"</span>+md5(user.email)+<span class="string">"?s=48"</span>; 得到用户的头像</div><div class="line">  <span class="keyword">new</span> Model(<span class="string">'User'</span>)(user).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,user</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(err)&#123;</div><div class="line">      req.flash(<span class="string">'error'</span>,err);</div><div class="line">      <span class="keyword">return</span> res.redirect(<span class="string">'/users/reg'</span>);</div><div class="line">    &#125;</div><div class="line">    req.session.user = user;<span class="comment">//用户信息存入 session</span></div><div class="line">    res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="3-用户登陆路由"><a href="#3-用户登陆路由" class="headerlink" title="3.用户登陆路由"></a>3.用户登陆路由</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> user = req.body;</div><div class="line">    user.password = md5(user.password);</div><div class="line">    Model(<span class="string">'User'</span>).findOne(user,<span class="function"><span class="keyword">function</span>(<span class="params">err,user</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>,err);</div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'/users/login'</span>);</div><div class="line">        &#125;</div><div class="line">        req.session.user = user;<span class="comment">//用户信息存入 session</span></div><div class="line">        res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="4-用户登出"><a href="#4-用户登出" class="headerlink" title="4.用户登出"></a>4.用户登出</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    req.session.user = <span class="literal">null</span>;<span class="comment">//用户信息存入 session</span></div><div class="line">    res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="十二-发表文章"><a href="#十二-发表文章" class="headerlink" title="十二.发表文章"></a>十二.发表文章</h2><h4 id="1-发表文章路由"><a href="#1-发表文章路由" class="headerlink" title="1.发表文章路由"></a>1.发表文章路由</h4><p>发表文章表单的form中action=”/articles/add”,所以我们要实现发表文章路由 修改 routes/article.js 中的 post(‘/add’)<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    req.body.user = req.session.user._id;</div><div class="line">    <span class="keyword">new</span> Model(<span class="string">'Article'</span>)(req.body).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'/articles/add'</span>);</div><div class="line">        &#125;</div><div class="line">        res.redirect(<span class="string">'/'</span>);<span class="comment">//发表文章成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="十三-页面通知"><a href="#十三-页面通知" class="headerlink" title="十三.页面通知"></a>十三.页面通知</h2><h4 id="1-什么是-flash"><a href="#1-什么是-flash" class="headerlink" title="1.什么是 flash?"></a>1.什么是 flash?</h4><p>我们所说的 flash 即 connect-flash 模块（<a href="https://github.com/jaredhanson/connect-flash），flash" target="_blank" rel="external">https://github.com/jaredhanson/connect-flash），flash</a> 是一个在 session 中用于存储信息的特定区域。信息写入 flash ，下一次显示完毕后即被清除。典型的应用是结合重定向的功能，确保信息是提供给下一个被渲染的页面。</p>
<h4 id="2-安装模块"><a href="#2-安装模块" class="headerlink" title="2.安装模块"></a>2.安装模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install connect-flash --save</div></pre></td></tr></table></figure>
<h4 id="3-在app-js中添加调用此模块"><a href="#3-在app-js中添加调用此模块" class="headerlink" title="3.在app.js中添加调用此模块"></a>3.在app.js中添加调用此模块</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> flash = <span class="built_in">require</span>(<span class="string">'connect-flash'</span>);</div><div class="line">app.use(flash());</div></pre></td></tr></table></figure>
<h4 id="4-在发表文章的路由里放置flash提示信息"><a href="#4-在发表文章的路由里放置flash提示信息" class="headerlink" title="4.在发表文章的路由里放置flash提示信息"></a>4.在发表文章的路由里放置flash提示信息</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    req.body.user = req.session.user._id;</div><div class="line">    <span class="keyword">new</span> Model(<span class="string">'Article'</span>)(req.body).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>, <span class="string">'更新文章失败!'</span>); <span class="comment">//放置失败信息</span></div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'/articles/add'</span>);</div><div class="line">        &#125;</div><div class="line">        req.flash(<span class="string">'success'</span>, <span class="string">'更新文章成功!'</span>); <span class="comment">// 放置成功信息</span></div><div class="line">        res.redirect(<span class="string">'/'</span>);<span class="comment">//发表文章成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="5-在页面里增加显示提示的区域"><a href="#5-在页面里增加显示提示的区域" class="headerlink" title="5.在页面里增加显示提示的区域"></a>5.在页面里增加显示提示的区域</h4><p>修改 views/include/header.ejs 在最底部增加以下区域<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;container text-center&quot;&gt;</div><div class="line">    &lt;% if (success) &#123; %&gt;</div><div class="line">    &lt;div class=&quot;alert alert-success&quot; role=&quot;alert&quot;&gt;&lt;%= success %&gt;&lt;/div&gt;</div><div class="line">    &lt;% &#125; %&gt;</div><div class="line">    &lt;% if (error) &#123; %&gt;</div><div class="line">    &lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;&lt;%= error %&gt;&lt;/div&gt;</div><div class="line">    &lt;% &#125; %&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<h4 id="6-用session中的值为模板赋默认值"><a href="#6-用session中的值为模板赋默认值" class="headerlink" title="6.用session中的值为模板赋默认值"></a>6.用session中的值为模板赋默认值</h4><p>在app.js 中增加以下中间件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line">  res.locals.user = req.session.user;</div><div class="line">  res.locals.success = req.flash(<span class="string">'success'</span>).toString();</div><div class="line">  res.locals.error = req.flash(<span class="string">'error'</span>).toString();</div><div class="line">  next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="7-请自行修改其它提示"><a href="#7-请自行修改其它提示" class="headerlink" title="7.请自行修改其它提示"></a>7.请自行修改其它提示</h4><h2 id="十四-控制导航内容的显示"><a href="#十四-控制导航内容的显示" class="headerlink" title="十四.控制导航内容的显示"></a>十四.控制导航内容的显示</h2><h4 id="1-控制导航"><a href="#1-控制导航" class="headerlink" title="1.控制导航"></a>1.控制导航</h4><p>用户是否登陆看到的页面应该是不一样的，所以应该根据用户登陆状态来控制导航菜单的显示状态</p>
<h4 id="2-修改导航"><a href="#2-修改导航" class="headerlink" title="2.修改导航"></a>2.修改导航</h4><p>修改 views/include/header.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;nav navbar-nav&quot;&gt;</div><div class="line">            &lt;%</div><div class="line">            if(!user)&#123;</div><div class="line">            %&gt;</div><div class="line">            &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;/users/reg&quot;&gt;注册&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/users/login&quot;&gt;登录&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;%</div><div class="line">            &#125;else&#123;</div><div class="line">            %&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/articles/add&quot;&gt;发表文章&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/users/logout&quot;&gt;登出&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;%</div><div class="line">            &#125;</div><div class="line">            %&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<p>用户登陆后显示发表文章和登出按钮，用户登陆前显示注册和登录按钮。</p>
<h2 id="十五-页面权限控制"><a href="#十五-页面权限控制" class="headerlink" title="十五.页面权限控制"></a>十五.页面权限控制</h2><h4 id="1-页面权限控制"><a href="#1-页面权限控制" class="headerlink" title="1.页面权限控制"></a>1.页面权限控制</h4><p>我们虽然已经完成了用户注册与登陆的功能，但并不能阻止比如已经登陆的用户访问 <a href="http://localhost:3000/users/reg" target="_blank" rel="external">http://localhost:3000/users/reg</a> 页面， 为此，我们需要为页面设置访问权限。即注册和登陆页面应该阻止已登陆的用户访问， 登出及后面我们将要实现的发表页只对已登录的用户开放。 如何实现页面权限的控制呢？我们可以把用户登录状态的检查放到路由中间件中，在每个路径前增加路由中间件，即可实现页面权限控制。 我们添加 checkNotLogin 和 checkLogin 函数来实现这个功能</p>
<h4 id="2-添加中间件"><a href="#2-添加中间件" class="headerlink" title="2.添加中间件"></a>2.添加中间件</h4><p>添加middleware文件夹 在middleware下添加index.js文件 middleware/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">exports.checkLogin = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">     <span class="keyword">if</span> (!req.session.user) &#123;</div><div class="line">         req.flash(<span class="string">'error'</span>, <span class="string">'未登录!'</span>);</div><div class="line">         <span class="keyword">return</span> res.redirect(<span class="string">'/users/login'</span>);</div><div class="line">     &#125;</div><div class="line">     next();</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> exports.checkNotLogin = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">     <span class="keyword">if</span> (req.session.user) &#123;</div><div class="line">         req.flash(<span class="string">'error'</span>, <span class="string">'已登录!'</span>);</div><div class="line">         <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>);<span class="comment">//返回之前的页面</span></div><div class="line">     &#125;</div><div class="line">     next();</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h4 id="3-在路由中添加中间件"><a href="#3-在路由中添加中间件" class="headerlink" title="3.在路由中添加中间件"></a>3.在路由中添加中间件</h4><p>修改 routes/users.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/reg'</span>,middleware.checkNotLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'user/reg'</span>, &#123;<span class="attr">title</span>: <span class="string">'注册'</span>&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>修改routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/add'</span>,middleware.checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'article/add'</span>, &#123; <span class="attr">title</span>: <span class="string">'发表文章'</span> &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>凡是不能登陆的中间加入 checkNotLogin 凡是需要登陆的中间加入 checkLogin</p>
<h2 id="十六-在首页显示文章列表"><a href="#十六-在首页显示文章列表" class="headerlink" title="十六.在首页显示文章列表"></a>十六.在首页显示文章列表</h2><h4 id="1-修改首页模板"><a href="#1-修改首页模板" class="headerlink" title="1.修改首页模板"></a>1.修改首页模板</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;% include include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line"> &lt;ul class=&quot;media-list&quot;&gt;</div><div class="line">  &lt;%</div><div class="line">  articles.forEach(function(article)&#123;</div><div class="line">  %&gt;</div><div class="line">  &lt;li class=&quot;media&quot;&gt;</div><div class="line">   &lt;div class=&quot;media-left&quot;&gt;</div><div class="line">    &lt;a href=&quot;#&quot;&gt;</div><div class="line">     &lt;img class=&quot;media-object&quot; src=&quot;&lt;%=article.user.avatar%&gt;&quot; alt=&quot;&quot;&gt;</div><div class="line">    &lt;/a&gt;</div><div class="line">   &lt;/div&gt;</div><div class="line">   &lt;div class=&quot;media-body&quot;&gt;</div><div class="line">    &lt;h4 class=&quot;media-heading&quot;&gt;&lt;a href=&quot;/articles/detail/&lt;%=article._id%&gt;&quot;&gt;&lt;%=article.title%&gt;&lt;/a&gt;&lt;/h4&gt;</div><div class="line">    &lt;p class=&quot;media-left&quot;&gt;&lt;%- article.content%&gt;&lt;/p&gt;</div><div class="line">   &lt;/div&gt;</div><div class="line">   &lt;div class=&quot;media-bottom&quot;&gt;</div><div class="line">    作者:&lt;%=article.user.username%&gt;</div><div class="line">    发表时间:&lt;%=article.createAt.toLocaleString()%&gt;</div><div class="line">   &lt;/div&gt;</div><div class="line">  &lt;/li&gt;</div><div class="line">  &lt;%</div><div class="line">  &#125;);</div><div class="line">  %&gt;</div><div class="line"> &lt;/ul&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-修改路由"><a href="#2-修改路由" class="headerlink" title="2.修改路由"></a>2.修改路由</h4><p>routes/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  Model(<span class="string">'Article'</span>).find(&#123;&#125;).populate(<span class="string">'user'</span>).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,articles</span>)</span>&#123;</div><div class="line">    res.render(<span class="string">'index'</span>, &#123;<span class="attr">title</span>: <span class="string">'主页'</span>,<span class="attr">articles</span>:articles&#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="十七-文章内容使用markdown"><a href="#十七-文章内容使用markdown" class="headerlink" title="十七.文章内容使用markdown"></a>十七.文章内容使用markdown</h2><h4 id="1-安装markdown插件"><a href="#1-安装markdown插件" class="headerlink" title="1.安装markdown插件"></a>1.安装markdown插件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install markdown -save</div></pre></td></tr></table></figure>
<h4 id="2-修改路由-1"><a href="#2-修改路由-1" class="headerlink" title="2.修改路由"></a>2.修改路由</h4><p>routes/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">markdown = <span class="built_in">require</span>(<span class="string">'markdown'</span>).markdown;</div><div class="line"></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  Model(<span class="string">'Article'</span>).find(&#123;&#125;).populate(<span class="string">'user'</span>).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,articles</span>)</span>&#123;</div><div class="line">    articles.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">article</span>) </span>&#123;</div><div class="line">      article.content = markdown.toHTML(article.content);</div><div class="line">    &#125;);</div><div class="line">    res.render(<span class="string">'index'</span>, &#123;<span class="attr">title</span>: <span class="string">'主页'</span>,<span class="attr">articles</span>:articles&#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="十八-发表文章时可以上传图片"><a href="#十八-发表文章时可以上传图片" class="headerlink" title="十八.发表文章时可以上传图片"></a>十八.发表文章时可以上传图片</h2><h4 id="1-安装文件上传模块"><a href="#1-安装文件上传模块" class="headerlink" title="1.安装文件上传模块"></a>1.安装文件上传模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install multer --save</div></pre></td></tr></table></figure>
<h4 id="2-修改模板"><a href="#2-修改模板" class="headerlink" title="2.修改模板"></a>2.修改模板</h4><p>views/article/add.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;!--form的类型改为--&gt;</div><div class="line">enctype=&quot;multipart/form-data&quot;</div><div class="line"></div><div class="line">&lt;!--增加一个字段--&gt;</div><div class="line">&lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;img&quot; class=&quot;col-sm-2 control-label&quot;&gt;图片&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                &lt;input type=&quot;file&quot; class=&quot;form-control&quot;  name=&quot;img&quot; id=&quot;img&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">&lt;/div</div></pre></td></tr></table></figure></p>
<h4 id="3-修改模型"><a href="#3-修改模型" class="headerlink" title="3.修改模型"></a>3.修改模型</h4><p>db/models.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Article: &#123;</div><div class="line">          user:&#123;type:ObjectId,ref:&apos;User&apos;&#125;,</div><div class="line">          title: String,</div><div class="line">          content: String,</div><div class="line">          img:String, //增加了图片字段</div><div class="line">          createAt:&#123;type: Date, default: Date.now&#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-修改路由"><a href="#4-修改路由" class="headerlink" title="4.修改路由"></a>4.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> storage = multer.diskStorage(&#123;</div><div class="line">    <span class="attr">destination</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, file, cb</span>) </span>&#123;</div><div class="line">        cb(<span class="literal">null</span>, <span class="string">'../public/uploads'</span>)</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">filename</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, file, cb</span>) </span>&#123;</div><div class="line">        cb(<span class="literal">null</span>, <span class="built_in">Date</span>.now()+<span class="string">'.'</span>+file.mimetype.slice(file.mimetype.indexOf(<span class="string">'/'</span>)+<span class="number">1</span>))</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"><span class="keyword">var</span> upload = multer(&#123; <span class="attr">storage</span>:storage&#125;);</div><div class="line"></div><div class="line">router.post(<span class="string">'/add'</span>,middleware.checkLogin,upload.single(<span class="string">'img'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    req.body.user = req.session.user._id;</div><div class="line">    <span class="keyword">if</span>(req.file)&#123;</div><div class="line">        req.body.img = path.join(<span class="string">'/uploads'</span>,req.file.filename);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="十九-实现文章页面"><a href="#十九-实现文章页面" class="headerlink" title="十九.实现文章页面"></a>十九.实现文章页面</h2><h4 id="1-修改首页"><a href="#1-修改首页" class="headerlink" title="1.修改首页"></a>1.修改首页</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;h4 class=&quot;media-heading&quot;&gt;&lt;a href=&quot;/articles/detail/&lt;%=article._id%&gt;&quot;&gt;&lt;%=article.title%&gt;&lt;/a&gt;&lt;/h4&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-修改路由-2"><a href="#2-修改路由-2" class="headerlink" title="2.修改路由"></a>2.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/detail/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    Model(<span class="string">'Article'</span>).findOne(&#123;<span class="attr">_id</span>:req.params._id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        article.content = markdown.toHTML(article.content);</div><div class="line">        res.render(<span class="string">'article/detail'</span>,&#123;<span class="attr">title</span>:<span class="string">'查看文章'</span>,<span class="attr">article</span>:article&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="3-增加详情页"><a href="#3-增加详情页" class="headerlink" title="3.增加详情页"></a>3.增加详情页</h4><p>views/article/detail.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;% include ../include/header.ejs%&gt;</div><div class="line"> &lt;div class=&quot;container&quot;&gt;</div><div class="line">     &lt;div class=&quot;panel panel-default&quot;&gt;</div><div class="line">         &lt;div class=&quot;panel-heading&quot;&gt;</div><div class="line">             &lt;%=article.title%&gt;</div><div class="line">         &lt;/div&gt;</div><div class="line">         &lt;div class=&quot;panel-body&quot;&gt;</div><div class="line">             &lt;%-article.content%&gt;</div><div class="line">         &lt;/div&gt;</div><div class="line">         &lt;div class=&quot;panel-footer&quot;&gt;</div><div class="line">             &lt;a href=&quot;/articles/edit/&lt;%=article._id%&gt;&quot; class=&quot;btn btn-warning&quot;&gt;编辑&lt;/a&gt;</div><div class="line">             &lt;a href=&quot;/articles/delete/&lt;%=article._id%&gt;&quot; class=&quot;btn btn-danger&quot;&gt;删除&lt;/a&gt;</div><div class="line">         &lt;/div&gt;</div><div class="line">     &lt;/div&gt;</div><div class="line"> &lt;/div&gt;</div><div class="line"> &lt;% include ../include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h2 id="二十-增加编辑与删除功能"><a href="#二十-增加编辑与删除功能" class="headerlink" title="二十.增加编辑与删除功能"></a>二十.增加编辑与删除功能</h2><h4 id="1-修改详情页"><a href="#1-修改详情页" class="headerlink" title="1.修改详情页"></a>1.修改详情页</h4><p>views/article/detail.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;/articles/edit/&lt;%=article._id%&gt;&quot; class=&quot;btn btn-warning&quot;&gt;编辑&lt;/a&gt;</div><div class="line">&lt;a href=&quot;/articles/delete/&lt;%=article._id%&gt;&quot; class=&quot;btn btn-danger&quot;&gt;删除&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-修改添加文章界面"><a href="#2-修改添加文章界面" class="headerlink" title="2.修改添加文章界面"></a>2.修改添加文章界面</h4><p>views/article/add.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;form action=&quot;/articles/add&quot; method=&quot;post&quot;  role=&quot;form&quot; class=&quot;form-horizontal&quot; enctype=&quot;multipart/form-data&quot;&gt;</div><div class="line">        &lt;input type=&quot;hidden&quot; value=&quot;&lt;%=article._id%&gt;&quot; name=&quot;_id&quot;/&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;title&quot; class=&quot;col-sm-2 control-label&quot;&gt;标题&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                &lt;input type=&quot;text&quot; value=&quot;&lt;%=article.title%&gt;&quot; class=&quot;form-control&quot; id=&quot;title&quot; name=&quot;title&quot; placeholder=&quot;标题&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;content&quot; class=&quot;col-sm-2 control-label&quot;&gt;正文&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                &lt;textarea class=&quot;form-control&quot;   id=&quot;&quot; cols=&quot;30&quot; rows=&quot;10&quot; id=&quot;content&quot; name=&quot;content&quot; placeholder=&quot;请输入内容&quot; &gt;&lt;%=article.content%&gt;&lt;/textarea&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;img&quot; class=&quot;col-sm-2 control-label&quot;&gt;图片&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                &lt;%</div><div class="line">                    if(article.img)&#123;</div><div class="line">                        %&gt;</div><div class="line">                             &lt;img src=&quot;&lt;%=article.img%&gt;&quot; style=&quot;width:100px;height:100px&quot; alt=&quot;&quot;/&gt;</div><div class="line">                        &lt;%</div><div class="line">                    &#125;</div><div class="line">                 %&gt;</div><div class="line">&lt;input type=&quot;file&quot; class=&quot;form-control&quot;  name=&quot;img&quot; id=&quot;img&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;div class=&quot;col-sm-offset-2 col-sm-10&quot;&gt;</div><div class="line">                &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">                &lt;button type=&quot;reset&quot; class=&quot;btn btn-default&quot;&gt;重置&lt;/button&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;/form&gt;</div></pre></td></tr></table></figure></p>
<h4 id="3-修改路由"><a href="#3-修改路由" class="headerlink" title="3.修改路由"></a>3.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/add'</span>,middleware.checkLogin,upload.single(<span class="string">'img'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(req.file)&#123;</div><div class="line">        req.body.img = path.join(<span class="string">'/uploads'</span>,req.file.filename);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> _id = req.body._id;</div><div class="line">    <span class="keyword">if</span>(_id)&#123;</div><div class="line">        <span class="keyword">var</span> set = &#123;<span class="attr">title</span>:req.body.title,<span class="attr">content</span>:req.body.content&#125;;</div><div class="line">        <span class="keyword">if</span>(req.file)</div><div class="line">            set.img = req.body.img;</div><div class="line">        Model(<span class="string">'Article'</span>).update(&#123;<span class="attr">_id</span>:_id&#125;,&#123;<span class="attr">$set</span>:set&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(err)&#123;</div><div class="line">                req.flash(<span class="string">'error'</span>,err);</div><div class="line">                <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>);</div><div class="line">            &#125;</div><div class="line">            req.flash(<span class="string">'success'</span>, <span class="string">'更新文章成功!'</span>);</div><div class="line">            res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">        &#125;);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        req.body.user = req.session.user._id;</div><div class="line">        <span class="keyword">new</span> Model(<span class="string">'Article'</span>)(req.body).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(err)&#123;</div><div class="line">                req.flash(<span class="string">'error'</span>,err);</div><div class="line">                <span class="keyword">return</span> res.redirect(<span class="string">'/articles/add'</span>);</div><div class="line">            &#125;</div><div class="line">            req.flash(<span class="string">'success'</span>, <span class="string">'发表文章成功!'</span>);</div><div class="line">            res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">router.get(<span class="string">'/detail/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    Model(<span class="string">'Article'</span>).findOne(&#123;<span class="attr">_id</span>:req.params._id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        article.content = markdown.toHTML(article.content);</div><div class="line">        res.render(<span class="string">'article/detail'</span>,&#123;<span class="attr">title</span>:<span class="string">'查看文章'</span>,<span class="attr">article</span>:article&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line">router.get(<span class="string">'/delete/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    Model(<span class="string">'Article'</span>).remove(&#123;<span class="attr">_id</span>:req.params._id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>,err);</div><div class="line">            res.redirect(<span class="string">'back'</span>);</div><div class="line">        &#125;</div><div class="line">        req.flash(<span class="string">'success'</span>, <span class="string">'删除文章成功!'</span>);</div><div class="line">        res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.get(<span class="string">'/edit/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    Model(<span class="string">'Article'</span>).findOne(&#123;<span class="attr">_id</span>:req.params._id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        res.render(<span class="string">'article/add'</span>,&#123;<span class="attr">title</span>:<span class="string">'编辑文章'</span>,<span class="attr">article</span>:article&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="二十一-实现搜索和分页功能"><a href="#二十一-实现搜索和分页功能" class="headerlink" title="二十一.实现搜索和分页功能"></a>二十一.实现搜索和分页功能</h2><h4 id="1-在导航栏增加搜索框"><a href="#1-在导航栏增加搜索框" class="headerlink" title="1.在导航栏增加搜索框"></a>1.在导航栏增加搜索框</h4><p>views/include/header.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;form  class=&quot;navbar-form navbar-right&quot; role=&quot;search&quot; method=&quot;get&quot; action=&quot;/articles/list/1/2&quot;&gt;</div><div class="line">            &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">                &lt;label for=&quot;keyword&quot;&gt;关键字&lt;/label&gt;</div><div class="line">                &lt;input type=&quot;text&quot; name=&quot;keyword&quot; id=&quot;keyword&quot; class=&quot;form-control&quot; value=&quot;&lt;%=keyword%&gt;&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">            &lt;button type=&quot;submit&quot; class=&quot;btn  btn-default&quot; value=&quot;search&quot; name=&quot;searchBtn&quot;&gt;搜索&lt;/button&gt;</div><div class="line">        &lt;/form&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-在首页增加分页条"><a href="#2-在首页增加分页条" class="headerlink" title="2.在首页增加分页条"></a>2.在首页增加分页条</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;pagination&quot;&gt;</div><div class="line">  &lt;%</div><div class="line">  for(var i=1;i&lt;=totalPage;i++)&#123;</div><div class="line">  %&gt;</div><div class="line">  &lt;li&gt;&lt;a href=&quot;/articles/list/&lt;%=i%&gt;/&lt;%=pageSize%&gt;?keyword=&lt;%=keyword%&gt;&quot;&gt;&lt;%=i%&gt;&lt;/a&gt;&lt;/li&gt;</div><div class="line">  &lt;%</div><div class="line">  &#125;</div><div class="line">  %&gt;</div><div class="line"> &lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<h4 id="3-首页导航重定向到文章列表页"><a href="#3-首页导航重定向到文章列表页" class="headerlink" title="3.首页导航重定向到文章列表页"></a>3.首页导航重定向到文章列表页</h4><p>routes/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.redirect(<span class="string">'/articles/list/1/2'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="4-增加文章列表导航"><a href="#4-增加文章列表导航" class="headerlink" title="4.增加文章列表导航"></a>4.增加文章列表导航</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/list/:pageNum/:pageSize'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> pageNum = req.params.pageNum&amp;&amp;req.params.pageNum&gt;<span class="number">0</span>?<span class="built_in">parseInt</span>(req.params.pageNum):<span class="number">1</span>;</div><div class="line">    <span class="keyword">var</span> pageSize =req.params.pageSize&amp;&amp;req.params.pageSize&gt;<span class="number">0</span>?<span class="built_in">parseInt</span>(req.params.pageSize):<span class="number">2</span>;</div><div class="line">    <span class="keyword">var</span> query = &#123;&#125;;</div><div class="line">    <span class="keyword">var</span> searchBtn = req.query.searchBtn;</div><div class="line">    <span class="keyword">var</span> keyword = req.query.keyword;</div><div class="line">    <span class="keyword">if</span>(searchBtn)&#123;</div><div class="line">        req.session.keyword = keyword;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(req.session.keyword)&#123;</div><div class="line">        query[<span class="string">'title'</span>] = <span class="keyword">new</span> <span class="built_in">RegExp</span>(req.session.keyword,<span class="string">"i"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Model(<span class="string">'Article'</span>).count(query,<span class="function"><span class="keyword">function</span>(<span class="params">err,count</span>)</span>&#123;</div><div class="line">        Model(<span class="string">'Article'</span>).find(query).sort(&#123;<span class="attr">createAt</span>:<span class="number">-1</span>&#125;).skip((pageNum<span class="number">-1</span>)*pageSize).limit(pageSize).populate(<span class="string">'user'</span>).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,articles</span>)</span>&#123;</div><div class="line">            articles.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">article</span>) </span>&#123;</div><div class="line">                article.content = markdown.toHTML(article.content);</div><div class="line">            &#125;);</div><div class="line">            res.render(<span class="string">'index'</span>,&#123;</div><div class="line">                <span class="attr">title</span>:<span class="string">'主页'</span>,</div><div class="line">                <span class="attr">pageNum</span>:pageNum,</div><div class="line">                <span class="attr">pageSize</span>:pageSize,</div><div class="line">                <span class="attr">keyword</span>:req.session.keyword,</div><div class="line">                <span class="attr">totalPage</span>:<span class="built_in">Math</span>.ceil(count/pageSize),</div><div class="line">                <span class="attr">articles</span>:articles</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="二十二-实现评论功能"><a href="#二十二-实现评论功能" class="headerlink" title="二十二.实现评论功能"></a>二十二.实现评论功能</h2><h4 id="1-修改模板"><a href="#1-修改模板" class="headerlink" title="1.修改模板"></a>1.修改模板</h4><p>views/article/detail.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;panel panel-default&quot;&gt;</div><div class="line">        &lt;div class=&quot;panel-heading&quot;&gt;</div><div class="line">            评论列表</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;panel-body&quot;  style=&quot;height:300px;overflow-y: scroll&quot;&gt;</div><div class="line">            &lt;ul class=&quot;media-list&quot;&gt;</div><div class="line">                &lt;%</div><div class="line">                article.comments.forEach(function(comment)&#123;</div><div class="line">                %&gt;</div><div class="line">                &lt;li class=&quot;media&quot;&gt;</div><div class="line">                    &lt;div class=&quot;media-left&quot;&gt;</div><div class="line">                        &lt;a href=&quot;#&quot;&gt;</div><div class="line">                            &lt;img class=&quot;media-object&quot; src=&quot;&lt;%=comment.user.avatar%&gt;&quot; alt=&quot;&quot;&gt;</div><div class="line">                        &lt;/a&gt;</div><div class="line">                    &lt;/div&gt;</div><div class="line">                    &lt;div class=&quot;media-body&quot;&gt;</div><div class="line">                        &lt;p class=&quot;media-left&quot;&gt;&lt;%- comment.content%&gt;&lt;/p&gt;</div><div class="line">                    &lt;/div&gt;</div><div class="line">                    &lt;div class=&quot;media-bottom&quot;&gt;</div><div class="line">                        &lt;%=comment.user.username%&gt; &lt;%=comment.createAt.toLocaleString()%&gt;</div><div class="line">                    &lt;/div&gt;</div><div class="line">                &lt;/li&gt;</div><div class="line">                &lt;%</div><div class="line">                &#125;);</div><div class="line">                %&gt;</div><div class="line">            &lt;/ul&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;/div&gt;</div><div class="line"></div><div class="line"> &lt;div class=&quot;panel panel-default&quot;&gt;</div><div class="line">        &lt;form action=&quot;/articles/comment&quot; method=&quot;post&quot;&gt;</div><div class="line">            &lt;input type=&quot;hidden&quot; value=&quot;&lt;%=article._id%&gt;&quot; name=&quot;_id&quot;/&gt;</div><div class="line">            &lt;div class=&quot;panel-body&quot;&gt;</div><div class="line">                &lt;textarea class=&quot;form-control&quot;   id=&quot;&quot; cols=&quot;30&quot; rows=&quot;10&quot; id=&quot;content&quot; name=&quot;content&quot; placeholder=&quot;请输入评论&quot; &gt;&lt;/textarea&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">            &lt;div class=&quot;panel-footer&quot;&gt;</div><div class="line">                &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/form&gt;</div><div class="line">    &lt;/div&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-修改模型"><a href="#2-修改模型" class="headerlink" title="2.修改模型"></a>2.修改模型</h4><p>db/models.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">comments: [&#123;<span class="attr">user</span>:&#123;<span class="attr">type</span>:ObjectId,<span class="attr">ref</span>:<span class="string">'User'</span>&#125;,<span class="attr">content</span>:<span class="built_in">String</span>,<span class="attr">createAt</span>:&#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now&#125;&#125;]</div></pre></td></tr></table></figure></p>
<h4 id="3-修改路由-1"><a href="#3-修改路由-1" class="headerlink" title="3.修改路由"></a>3.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/comment'</span>,middleware.checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">   <span class="keyword">var</span> user = req.session.user;</div><div class="line">   Model(<span class="string">'Article'</span>).update(&#123;<span class="attr">_id</span>:req.body._id&#125;,&#123;<span class="attr">$push</span>:&#123;<span class="attr">comments</span>:&#123;<span class="attr">user</span>:user._id,<span class="attr">content</span>:req.body.content&#125;&#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>,err);</div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>);</div><div class="line">        &#125;</div><div class="line">        req.flash(<span class="string">'success'</span>, <span class="string">'评论成功!'</span>);</div><div class="line">        res.redirect(<span class="string">'back'</span>);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="二十三-显示pv和评论数"><a href="#二十三-显示pv和评论数" class="headerlink" title="二十三.显示pv和评论数"></a>二十三.显示pv和评论数</h2><h4 id="1-安装async"><a href="#1-安装async" class="headerlink" title="1.安装async"></a>1.安装async</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install async --save</div></pre></td></tr></table></figure>
<h4 id="2-修改模型-1"><a href="#2-修改模型-1" class="headerlink" title="2.修改模型"></a>2.修改模型</h4><p>db/models.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pv: &#123;type:Number,default:0&#125;</div></pre></td></tr></table></figure></p>
<h4 id="3-修改路由-2"><a href="#3-修改路由-2" class="headerlink" title="3.修改路由"></a>3.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line">router.get(<span class="string">'/detail/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="keyword">async</span>.parallel([<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        Model(<span class="string">'Article'</span>).findOne(&#123;<span class="attr">_id</span>:req.params._id&#125;).populate(<span class="string">'user'</span>).populate(<span class="string">'comments.user'</span>).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">                article.content = markdown.toHTML(article.content);</div><div class="line">                callback(err,article);</div><div class="line">        &#125;);</div><div class="line">    &#125;,<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        Model(<span class="string">'Article'</span>).update(&#123;<span class="attr">_id</span>:req.params._id&#125;,&#123;<span class="attr">$inc</span>:&#123;<span class="attr">pv</span>:<span class="number">1</span>&#125;&#125;,callback);</div><div class="line">    &#125;],<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>,err);</div><div class="line">            res.redirect(<span class="string">'back'</span>);</div><div class="line">        &#125;</div><div class="line">        res.render(<span class="string">'article/detail'</span>,&#123;<span class="attr">title</span>:<span class="string">'查看文章'</span>,<span class="attr">article</span>:result[<span class="number">0</span>]&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="4-修改模板"><a href="#4-修改模板" class="headerlink" title="4.修改模板"></a>4.修改模板</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">阅读：&lt;%= article.pv %&gt;|</div><div class="line">评论：&lt;%= article.comments.length%&gt;</div></pre></td></tr></table></figure></p>
<h2 id="二十四-美化404页面"><a href="#二十四-美化404页面" class="headerlink" title="二十四.美化404页面"></a>二十四.美化404页面</h2><h4 id="1-修改404中间件"><a href="#1-修改404中间件" class="headerlink" title="1.修改404中间件"></a>1.修改404中间件</h4><p>app.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// catch 404 and forward to error handler</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">"404"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="2-增加404页面模板"><a href="#2-增加404页面模板" class="headerlink" title="2.增加404页面模板"></a>2.增加404页面模板</h4><p>views/404.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;% include include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line">    &lt;img src=&quot;http://7xjf2l.com2.z0.glb.qiniucdn.com/20131122112727-1356352347.jpg&quot; alt=&quot;404&quot;/&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h2 id="二十五-打印日志"><a href="#二十五-打印日志" class="headerlink" title="二十五.打印日志"></a>二十五.打印日志</h2><p>现在给博客增加日志，实现访问日志（access.log）和错误日志（error.log）功能</p>
<h4 id="1-把日志保存为日志文件"><a href="#1-把日志保存为日志文件" class="headerlink" title="1.把日志保存为日志文件"></a>1.把日志保存为日志文件</h4><p>app.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//正常日志</span></div><div class="line"><span class="keyword">var</span> accessLog = fs.createWriteStream(<span class="string">'access.log'</span>, &#123;<span class="attr">flags</span>: <span class="string">'a'</span>&#125;);</div><div class="line">app.use(logger(<span class="string">'dev'</span>,&#123;<span class="attr">stream</span>: accessLog&#125;));</div><div class="line"></div><div class="line"><span class="comment">//错误日志</span></div><div class="line"><span class="keyword">var</span> errorLog = fs.createWriteStream(<span class="string">'error.log'</span>, &#123;<span class="attr">flags</span>: <span class="string">'a'</span>&#125;);</div><div class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> meta = <span class="string">'['</span> + <span class="keyword">new</span> <span class="built_in">Date</span>() + <span class="string">'] '</span> + req.url + <span class="string">'\n'</span>;</div><div class="line">  errorLog.write(meta + err.stack + <span class="string">'\n'</span>);</div><div class="line">  next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/17/Blog/" data-id="cj5m7x3b20001e8u2s58wxk4r" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-angular" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/14/angular/" class="article-date">
  <time datetime="2017-04-14T09:20:01.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/14/angular/">angular</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/14/angular/" data-id="cj5m7x3bi0003e8u2vw94o356" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-正则" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/14/正则/" class="article-date">
  <time datetime="2017-04-14T08:15:49.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/14/正则/">正则</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="常用正则表达式"><a href="#常用正则表达式" class="headerlink" title="常用正则表达式"></a>常用正则表达式</h2><ul>
<li>网址（URL）[a-zA-z]+://[^\s]* </li>
<li>IP地址(IP Address)((2[0-4]\d|25[0-5]|[01]?\d\d?).){3}(2[0-4]\d|25[0-5]|[01]?\d\d?) </li>
<li>电子邮件(Email) \w+([-+.]\w+)<em>@\w+([-.]\w+)</em>.\w+([-.]\w+)* </li>
<li>QQ号码 [1-9]\d{4,} </li>
<li>HTML标记(包含内容或自闭合) &lt;(.<em>)(.</em>)&gt;.<em>&lt;\/\1&gt;|&lt;(.</em>) \/&gt; </li>
<li>密码(由数字/大写字母/小写字母/标点符号组成，四种都必有，8位以上) (?=^.{8,}$)(?=.<em>\d)(?=.</em>\W+)(?=.<em>[A-Z])(?=.</em>[a-z])(?!.<em>\n).</em>$  </li>
<li>日期(年-月-日) (\d{4}|\d{2})-((1[0-2])|(0?[1-9]))-(([12][0-9])|(3[01])|(0?[1-9])) </li>
<li>日期(月/日/年) ((1[0-2])|(0?[1-9]))/(([12][0-9])|(3[01])|(0?[1-9]))/(\d{4}|\d{2}) </li>
<li>时间(小时:分钟, 24小时制) ((1|0?)[0-9]|2[0-3]):([0-5][0-9]) </li>
<li>汉字(字符) [\u4e00-\u9fa5] </li>
<li>中文及全角标点符号(字符) [\u3000-\u301e\ufe10-\ufe19\ufe30-\ufe44\ufe50-\ufe6b\uff01-\uffee] </li>
<li>中国大陆固定电话号码 (\d{4}-|\d{3}-)?(\d{8}|\d{7}) </li>
<li>中国大陆手机号码 1\d{10} </li>
<li>中国大陆邮政编码 [1-9]\d{5} </li>
<li>中国大陆身份证号(15位或18位) \d{15}(\d\d[0-9xX])? </li>
<li>非负整数(正整数或零) \d+ </li>
<li>正整数 [0-9]<em>[1-9][0-9]</em> </li>
<li>负整数 -[0-9]<em>[1-9][0-9]</em> </li>
<li>整数 -?\d+ </li>
<li>小数 (-?\d+)(.\d+)? </li>
<li>不包含abc的单词 \b((?!abc)\w)+\b </li>
<li>用户名 /^[a-z0-9_-]{3,16}$/ </li>
<li>密码 /^[a-z0-9_-]{6,18}$/ </li>
<li>十六进制值 /^#?([a-f0-9]{6}|[a-f0-9]{3})$/ </li>
<li>电子邮箱 /^([a-z0-9_.-]+)@([\da-z.-]+).([a-z.]{2,6})$/ </li>
<li>URL /^(https?:\/\/)?([\da-z.-]+).([a-z.]{2,6})([\/\w .-]<em>)</em>\/?$/ </li>
<li>IP 地址 /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/ </li>
<li>HTML 标签 /^&lt;([a-z]+)([^&lt;]+)<em>(?:&gt;(.</em>)&lt;\/\1&gt;|\s+\/&gt;)$/ </li>
<li>Unicode编码中的汉字范围 /^[u4e00-u9fa5],{0,}$/ </li>
<li><p>匹配中文字符的正则表达式 [\u4e00-\u9fa5] </p>
<h2 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h2></li>
<li><p>\ 将下一个字符标记为一个特殊字符、或一个原义字符、或一个向后引用、或一个八进制转义符。例如，“n”匹配字符“n”。“\n”匹配一个换行符。序列“\”匹配“\”而“(”则匹配“(”。 </p>
</li>
<li><p>^ 匹配输入字符串的开始位置。如果设置了RegExp对象的Multiline属性，^也匹配“\n”或“\r”之后的位置。 </p>
</li>
<li><p>$ 匹配输入字符串的结束位置。如果设置了RegExp对象的Multiline属性，$也匹配“\n”或“\r”之前的位置。 </p>
</li>
<li><p>* 匹配前面的子表达式零次或多次。例如，zo<em>能匹配“z”以及“zoo”。</em>等价于{0,}。 </p>
</li>
<li><p>+ 匹配前面的子表达式一次或多次。例如，“zo+”能匹配“zo”以及“zoo”，但不能匹配“z”。+等价于{1,}。 </p>
</li>
<li><p>\? 匹配前面的子表达式零次或一次。例如，“do(es)?”可以匹配“do”或“does”中的“do”。?等价于{0,1}。 </p>
</li>
<li><p>{n} n是一个非负整数。匹配确定的n次。例如，“o{2}”不能匹配“Bob”中的“o”，但是能匹配“food”中的两个o。 </p>
</li>
<li><p>{n,} n是一个非负整数。至少匹配n次。例如，“o{2,}”不能匹配“Bob”中的“o”，但能匹配“foooood”中的所有o。“o{1,}”等价于“o+”。“o{0,}”则等价于“o*”。 </p>
</li>
<li><p>{n,m} m和n均为非负整数，其中n&lt;=m。最少匹配n次且最多匹配m次。例如，“o{1,3}”将匹配“fooooood”中的前三个o。“o{0,1}”等价于“o?”。请注意在逗号和两个数之间不能有空格。 </p>
</li>
<li><p>\? 当该字符紧跟在任何一个其他限制符（*,+,?，{n}，{n,}，{n,m}）后面时，匹配模式是非贪婪的。非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。例如，对于字符串“oooo”，“o+?”将匹配单个“o”，而“o+”将匹配所有“o”。 </p>
</li>
<li><p>. 匹配除“\n”之外的任何单个字符。要匹配包括“\n”在内的任何字符，请使用像“[.\n]”的模式。 </p>
</li>
<li><p>(pattern) 匹配pattern并获取这一匹配。所获取的匹配可以从产生的Matches集合得到，在VBScript中使用SubMatches集合，在JScript中则使用$0…$9属性。要匹配圆括号字符，请使用“(”或“)”。 </p>
</li>
<li><p>(?:pattern) 匹配pattern但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用或字符“(|)”来组合一个模式的各个部分是很有用。例如“industr(?:y|ies)”就是一个比“industry|industries”更简略的表达式。 </p>
</li>
<li><p>(?=pattern) 正向预查，在任何匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，“Windows(?=95|98|NT|2000)”能匹配“Windows2000”中的“Windows”，但不能匹配“Windows3.1”中的“Windows”。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。 </p>
</li>
<li><p>(?!pattern) 负向预查，在任何不匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如“Windows(?!95|98|NT|2000)”能匹配“Windows3.1”中的“Windows”，但不能匹配“Windows2000”中的“Windows”。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始 </p>
</li>
<li><p>x|y 匹配x或y。例如，“z|food”能匹配“z”或“food”。“(z|f)ood”则匹配“zood”或“food”。 </p>
</li>
<li><p>[xyz] 字符集合。匹配所包含的任意一个字符。例如，“[abc]”可以匹配“plain”中的“a”。 </p>
</li>
<li><p>[^xyz] 负值字符集合。匹配未包含的任意字符。例如，“[^abc]”可以匹配“plain”中的“p”。 </p>
</li>
<li><p>[a-z] 字符范围。匹配指定范围内的任意字符。例如，“[a-z]”可以匹配“a”到“z”范围内的任意小写字母字符。 </p>
</li>
<li><p>[^a-z] 负值字符范围。匹配任何不在指定范围内的任意字符。例如，“[^a-z]”可以匹配任何不在“a”到“z”范围内的任意字符。 </p>
</li>
<li><p>\b 匹配一个单词边界，也就是指单词和空格间的位置。例如，“er\b”可以匹配“never”中的“er”，但不能匹配“verb”中的“er”。 </p>
</li>
<li><p>\B 匹配非单词边界。“er\B”能匹配“verb”中的“er”，但不能匹配“never”中的“er”。 </p>
</li>
<li><p>\cx 匹配由x指明的控制字符。例如，\cM匹配一个Control-M或回车符。x的值必须为A-Z或a-z之一。否则，将c视为一个原义的“c”字符。 </p>
</li>
<li><p>\d 匹配一个数字字符。等价于[0-9]。 </p>
</li>
<li><p>\D 匹配一个非数字字符。等价于[^0-9]。 </p>
</li>
<li><p>\f 匹配一个换页符。等价于\x0c和\cL。 </p>
</li>
<li><p>\n 匹配一个换行符。等价于\x0a和\cJ。 </p>
</li>
<li><p>\r 匹配一个回车符。等价于\x0d和\cM。 </p>
</li>
<li><p>\s 匹配任何空白字符，包括空格、制表符、换页符等等。等价于[\f\n\r\t\v]。 </p>
</li>
<li><p>\S 匹配任何非空白字符。等价于[^\f\n\r\t\v]。 </p>
</li>
<li><p>\t 匹配一个制表符。等价于\x09和\cI。 </p>
</li>
<li><p>\v 匹配一个垂直制表符。等价于\x0b和\cK。 </p>
</li>
<li><p>\w 匹配包括下划线的任何单词字符。等价于“[A-Za-z0-9_]”。 </p>
</li>
<li><p>\W 匹配任何非单词字符。等价于“[^A-Za-z0-9_]”。 </p>
</li>
<li><p>\xn 匹配n，其中n为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，“\x41”匹配“A”。“\x041”则等价于“\x04&amp;1”。正则表达式中可以使用ASCII编码。. </p>
</li>
<li><p>\num 匹配num，其中num是一个正整数。对所获取的匹配的引用。例如，“(.)\1”匹配两个连续的相同字符。 </p>
</li>
<li><p>\n 标识一个八进制转义值或一个向后引用。如果\n之前至少n个获取的子表达式，则n为向后引用。否则，如果n为八进制数字（0-7），则n为一个八进制转义值。 </p>
</li>
<li><p>\nm 标识一个八进制转义值或一个向后引用。如果\nm之前至少有nm个获得子表达式，则nm为向后引用。如果\nm之前至少有n个获取，则n为一个后跟文字m的向后引用。如果前面的条件都不满足，若n和m均为八进制数字（0-7），则\nm将匹配八进制转义值nm。 </p>
</li>
<li><p>\nml 如果n为八进制数字（0-3），且m和l均为八进制数字（0-7），则匹配八进制转义值nml。 </p>
</li>
<li><p>\un 匹配n，其中n是一个用四个十六进制数字表示的Unicode字符。例如，\u00A9匹配版权符号（?）。 </p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/14/正则/" data-id="cj5m7x3bi0005e8u2u77e6qyj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-git常用指令" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/14/git常用指令/" class="article-date">
  <time datetime="2017-04-14T06:10:35.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/14/git常用指令/">git常用指令</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="查看、添加、提交、删除、找回，重置修改文件"><a href="#查看、添加、提交、删除、找回，重置修改文件" class="headerlink" title="查看、添加、提交、删除、找回，重置修改文件"></a>查看、添加、提交、删除、找回，重置修改文件</h2><ul>
<li>git help <command> # 显示command的help</li>
<li>git show # 显示某次提交的内容 git show $id</li>
<li>git co – <file> # 抛弃工作区修</file></li>
<li>git co . # 抛弃工作区修改</li>
<li>git add <file> # 将工作文件修改提交到本地暂存区</file></li>
<li>git add . # 将所有修改过的工作文件提交暂存区</li>
<li>git r <file> # 从版本库中删除文件</file></li>
<li>git rm <file> –cached # 从版本库中删除文件，但不删除文件</file></li>
<li>git reset <file> # 从暂存区恢复到工作文件</file></li>
<li>git reset – . # 从暂存区恢复到工作文件</li>
<li>git reset –hard # 恢复最近一次提交过的状态，即放弃上次提交后的所有本次修</li>
<li>git ci <file> git ci . git ci -a # 将git add, git rm和git ci等操作都合并在一起做  </file></li>
<li>git ci -am “some comments”</li>
<li>git ci –amend # 修改最后一次提交记录</li>
<li>git revert &lt;$id&gt; # 恢复某次提交的状态，恢复动作本身也创建次提交对象</li>
<li>git revert HEAD # 恢复最后一次提交的状态  <h2 id="查看文件diff"><a href="#查看文件diff" class="headerlink" title="查看文件diff"></a>查看文件diff</h2></li>
<li>git diff <file> # 比较当前文件和暂存区文件差异 git diff  </file></li>
<li>git diff <id1>&lt; id1&gt;<id2> # 比较两次提交之间的差异  </id2></id1></li>
<li>git diff <branch1>..<branch2> # 在两个分支之间比较  </branch2></branch1></li>
<li>git diff –staged # 比较暂存区和版本库差异  </li>
<li>git diff –cached # 比较暂存区和版本库差异  </li>
<li>git diff –stat # 仅仅比较统计信息  <h2 id="查看提交记录"><a href="#查看提交记录" class="headerlink" title="查看提交记录"></a>查看提交记录</h2></li>
<li>git log git log <file> # 查看该文件每次提交记录  </file></li>
<li>git log -p <file> # 查看每次详细修改内容的diff  </file></li>
<li>git log -p -2 # 查看最近两次详细修改内容的diff  </li>
<li>git log –stat #查看提交统计信息  <h2 id="tig"><a href="#tig" class="headerlink" title="tig"></a>tig</h2></li>
<li>Mac上可以使用tig代替diff和log，brew install tig  <h2 id="Git本地分支管理"><a href="#Git本地分支管理" class="headerlink" title="Git本地分支管理"></a>Git本地分支管理</h2><h4 id="查看、切换、创建和删除分支"><a href="#查看、切换、创建和删除分支" class="headerlink" title="查看、切换、创建和删除分支"></a>查看、切换、创建和删除分支</h4></li>
<li>git br -r # 查看远程分支</li>
<li>git br <new_branch> # 创建新的分支</new_branch></li>
<li>git br -v # 查看各个分支最后提交信息</li>
<li>git br –merged # 查看已经被合并到当前分支的分支</li>
<li>git br –no-merged # 查看尚未被合并到当前分支的分支</li>
<li>git co <branch> # 切换到某个分支</branch></li>
<li>git co -b <new_branch> # 创建新的分支，并且切换过去</new_branch></li>
<li>git co -b <new_branch> <branch> # 基于branch创建新的new_branch</branch></new_branch></li>
<li>git co $id # 把某次历史提交记录checkout出来，但无分支信息，切换到其他分支会自动删除</li>
<li>git co $id -b <new_branch> # 把某次历史提交记录checkout出来，创建成一个分支</new_branch></li>
<li>git br -d <branch> # 删除某个分支</branch></li>
<li>git br -D <branch> # 强制删除某个分支 (未被合并的分支被删除的时候需要强制)<h4 id="分支合并和rebase"><a href="#分支合并和rebase" class="headerlink" title="分支合并和rebase"></a>分支合并和rebase</h4></branch></li>
<li>git merge <branch> # 将branch分支合并到当前分支</branch></li>
<li>git merge origin/master –no-ff # 不要Fast-Foward合并，这样可以生成merge提交</li>
<li>git rebase master <branch> # 将master rebase到branch，相当于： git co <branch> &amp;&amp; git rebase master &amp;&amp; git co master &amp;&amp; git merge <branch><h2 id="Git补丁管理-方便在多台机器上开发同步时用"><a href="#Git补丁管理-方便在多台机器上开发同步时用" class="headerlink" title="Git补丁管理(方便在多台机器上开发同步时用)"></a>Git补丁管理(方便在多台机器上开发同步时用)</h2></branch></branch></branch></li>
<li>git diff &gt; ../sync.patch # 生成补丁</li>
<li>git apply ../sync.patch # 打补丁</li>
<li>git apply –check ../sync.patch #测试补丁能否成功<h2 id="Git暂存管理"><a href="#Git暂存管理" class="headerlink" title="Git暂存管理"></a>Git暂存管理</h2></li>
<li>git stash # 暂存</li>
<li>git stash list # 列所有stash</li>
<li>git stash apply # 恢复暂存的内容</li>
<li>git stash drop # 删除暂存区<h2 id="Git远程分支管理"><a href="#Git远程分支管理" class="headerlink" title="Git远程分支管理"></a>Git远程分支管理</h2></li>
<li>git pull # 抓取远程仓库所有分支更新并合并到本地</li>
<li>git pull –no-ff # 抓取远程仓库所有分支更新并合并到本地，不要快进合并</li>
<li>git fetch origin # 抓取远程仓库更新</li>
<li>git merge origin/master # 将远程主分支合并到本地当前分支</li>
<li>git co –track origin/branch # 跟踪某个远程分支创建相应的本地分支</li>
<li>git co -b <local_branch> origin/<remote_branch> # 基于远程分支创建本地分支，功能同上</remote_branch></local_branch></li>
<li>git push # push所有分支</li>
<li>git push origin master # 将本地主分支推到远程主分支</li>
<li>git push -u origin master # 将本地主分支推到远程(如无远程主分支则创建，用于初始化远程仓库)</li>
<li>git push origin <local_branch> # 创建远程分支， origin是远程仓库名</local_branch></li>
<li>git push origin <local_branch>:<remote_branch> # 创建远程分支</remote_branch></local_branch></li>
<li>git push origin :<remote_branch> #先删除本地分支(git br -d <branch>)，然后再push删除远程分支<h2 id="Git远程仓库管理"><a href="#Git远程仓库管理" class="headerlink" title="Git远程仓库管理"></a>Git远程仓库管理</h2></branch></remote_branch></li>
<li>git remote -v # 查看远程服务器地址和仓库名称</li>
<li>git remote show origin # 查看远程服务器仓库状态</li>
<li>git remote add origin git@ github:robbin/robbin_site.git # 添加远程仓库地址</li>
<li>git remote set-url origin git@ github.com:robbin/robbin_site.git # 设置远程仓库地址(用于修改远程仓库地址) git remote rm <repository> # 删除远程仓库<h2 id="创建远程仓库"><a href="#创建远程仓库" class="headerlink" title="创建远程仓库"></a>创建远程仓库</h2></repository></li>
<li>git clone –bare robbin_site robbin_site.git # 用带版本的项目创建纯版本仓库</li>
<li>scp -r my_project.git git@ git.csdn.net:~ # 将纯仓库上传到服务器上</li>
<li>mkdir robbin_site.git &amp;&amp; cd robbin_site.git &amp;&amp; git –bare init # 在服务器创建纯仓库</li>
<li>git remote add origin git@ github.com:robbin/robbin_site.git # 设置远程仓库地址</li>
<li>git push -u origin master # 客户端首次提交</li>
<li>git push -u origin develop # 首次将本地develop分支提交到远程develop分支，并且track</li>
<li>git remote set-head origin master # 设置远程仓库的HEAD指向master分支,也可以命令设置跟踪远程库和本地库</li>
<li>git branch –set-upstream master origin/master</li>
<li>git branch –set-upstream develop origin/develop</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/14/git常用指令/" data-id="cj5m7x3bi0004e8u2j4muvmzb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hexo-github静态博客" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/14/hexo-github静态博客/" class="article-date">
  <time datetime="2017-04-14T03:27:02.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/14/hexo-github静态博客/">hexo+github静态博客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h2><ol>
<li>hexo常用命令</li>
</ol>
<ul>
<li>hexo g #完整命令为hexo generate,用于生成静态文件</li>
<li>hexo s #完整命令为hexo server,用于启动服务器，主要用来本地预览</li>
<li>hexo d #完整命令为hexo deploy,用于将本地文件发布到github上</li>
<li>hexo n #完整命令为hexo new,用于新建一篇文章</li>
</ul>
<ol>
<li>npm安装hexo</li>
</ol>
<ul>
<li>在任意位置点击鼠标右键，选择Git Base,输入安装命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g hexo</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="生成hexo文件"><a href="#生成hexo文件" class="headerlink" title="生成hexo文件"></a>生成hexo文件</h2><ol>
<li><p>在你喜爱的文件夹下（如E:\Hexo），执行以下指令(在E:\Hexo内点击鼠标右键，选择Git Bash)，Hexo 即会自动在目标文件夹建立网站所需要的所有文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo init</div></pre></td></tr></table></figure>
</li>
<li><p>安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install</div></pre></td></tr></table></figure>
</li>
<li><p>在E:\hexo内执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexo g</div><div class="line">hexo s</div></pre></td></tr></table></figure>
</li>
</ol>
<p>4.然后用浏览器访问<a href="http://localhost:4000，" target="_blank" rel="external">http://localhost:4000，</a> 此时，你应该看到了一个漂亮的博客了</p>
<h2 id="注册github账号"><a href="#注册github账号" class="headerlink" title="注册github账号"></a>注册github账号</h2><h2 id="创建reponsitory"><a href="#创建reponsitory" class="headerlink" title="创建reponsitory"></a>创建reponsitory</h2><ul>
<li>创建的仓库名必须是  username+github.io<h2 id="部署本地文件到github"><a href="#部署本地文件到github" class="headerlink" title="部署本地文件到github"></a>部署本地文件到github</h2></li>
</ul>
<ol>
<li>编辑E：\hexo下的_config.yml文件，在_config.yml最下方，<blockquote>
<p>添加如下配置(命令中的tengj为Github的用户名)。<br><br> 另外记得一点，hexo的配置文件中任何’:’后面都是带一个空格的),<br>如果配置以下命令出现ERROR Deployer not found : github，则参考上文的解决方法</p>
</blockquote>
</li>
</ol>
<ul>
<li>如下<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">deploy: </div><div class="line">  type: git</div><div class="line">  repository: https://github.com/tangyongkai/tangyongkai.github.io.git</div><div class="line">  branch: master</div></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li><blockquote>
<p>如果你是第一次使用Github或者是已经使用过，但没有配置过SSH，则可能需要配置一下:<br>在Git Bash输入以下指令（任意位置点击鼠标右键），检查是否已经存在了SSH keys。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ls -al ~/.ssh</div></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>如果不存在就没有关系，如果存在的话，直接删除.ssh文件夹里面所有文件：</p>
<ul>
<li>.ssh在C盘user/.ssh</li>
</ul>
</li>
<li><p>输入以下指令（邮箱就是你注册Github时候的邮箱）后，回车，出现提示让你输入的时候直接先回车，好像需要3次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa -C &quot;358593266@qq.com&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>输入指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-agent -s</div></pre></td></tr></table></figure>
</li>
</ol>
<p>6.输入指令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-add ~/.ssh/id_rsa</div></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li><p>输入之后，在我这里是出错了，不知道你的有没有出错。<br>could not open a connection to your agent<br>如果出错输入以下命令</p>
<p>eval <code>ssh-agent -s</code><br>ssh-add  </p>
</li>
</ul>
<ol>
<li>到了这一步，就可以添加SSH key到你的Github账户了。键入以下指令，拷贝Key（先拷贝了，等一下可以直接粘贴，不放心的在执行下面命令后，先黏贴在记事本上）：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clip &lt; ~/.ssh/id_rsa.pub</div></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<ul>
<li>然后到Github里面，点击右上角的设置图标Settings,找到SSH keys,Ttile随便你命名，Key就黏贴上你刚才复制的key,然后点Add SSH key，最后会让你重新输入下gitHub的密码</li>
</ul>
<ol>
<li><p>最后还是测试一下吧，键入以下命令：你可能会看到有警告，没事，输入“yes”就好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -T git@github.com</div></pre></td></tr></table></figure>
</li>
<li><p>以上就表示SSH配置好了，执行以下命令部署到Github上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexo g</div><div class="line">hexo d</div></pre></td></tr></table></figure>
</li>
<li><p>如果执行hexo d命令报下名错：就先安装一下hexo-deployer-git这个模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-deployer-git --save</div></pre></td></tr></table></figure>
</li>
</ol>
<p>11.安装好了继续执行hexo d部署命令，输入gitHub的账号密码，就可以访问了。我的是： tengj.github.io</p>
<h2 id="发表文章"><a href="#发表文章" class="headerlink" title="发表文章"></a>发表文章</h2><ol>
<li><p>在Git Bash执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new &quot;文件名&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>•在E:\hexo\source_post中打开my-new-post.md，打开方式使用记事本或者其他文本工具。<br>hexo中写文章使用的是Markdown，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">title: my new post #可以改成中文的，如“新文章”</div><div class="line">date: 2016-02-21 16:04:09 #发表日期，一般不改动</div><div class="line">categories: blog #文章文类</div><div class="line">tags: [文章] #文章标签，多于一项时用这种格式，只有一项时使用tags: blog</div><div class="line">--</div><div class="line">这里是正文，用markdown写，你可以选择写一段显示在首页的简介后，加上</div><div class="line">&lt;!--more--&gt;，在&lt;!--more--&gt;之前的内容会显示在首页，之后的内容会被隐藏，当游客点击Read more    才</div></pre></td></tr></table></figure>
<p>3.写完文章后，你可以使用1.$ hexo g生成静态文件。2.$ hexo s在本地预览效果。3.hexo d同步到github，</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/14/hexo-github静态博客/" data-id="cj5m7x3bi0002e8u2bb783ugv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/07/27/gulp/">gulp</a>
          </li>
        
          <li>
            <a href="/2017/04/17/Blog/">Blog</a>
          </li>
        
          <li>
            <a href="/2017/04/14/angular/">angular</a>
          </li>
        
          <li>
            <a href="/2017/04/14/正则/">正则</a>
          </li>
        
          <li>
            <a href="/2017/04/14/git常用指令/">git常用指令</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>