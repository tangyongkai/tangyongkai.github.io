<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Blog | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Blog一.使用Express生成器生成一个实例项目1.安装 Express express 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入： 1$ npm install -g express-generator  安装 express 命令行工具，使用它我们可以初始化一个">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://yoursite.com/2017/04/17/Blog/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Blog一.使用Express生成器生成一个实例项目1.安装 Express express 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入： 1$ npm install -g express-generator  安装 express 命令行工具，使用它我们可以初始化一个">
<meta property="og:updated_time" content="2017-07-26T05:48:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Blog">
<meta name="twitter:description" content="Blog一.使用Express生成器生成一个实例项目1.安装 Express express 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入： 1$ npm install -g express-generator  安装 express 命令行工具，使用它我们可以初始化一个">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/17/Blog/" class="article-date">
  <time datetime="2017-04-17T03:27:02.000Z" itemprop="datePublished">2017-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Blog
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h1><h2 id="一-使用Express生成器生成一个实例项目"><a href="#一-使用Express生成器生成一个实例项目" class="headerlink" title="一.使用Express生成器生成一个实例项目"></a>一.使用Express生成器生成一个实例项目</h2><h4 id="1-安装-Express"><a href="#1-安装-Express" class="headerlink" title="1.安装 Express"></a>1.安装 Express</h4><ul>
<li><p><strong>express 是 Node.js 上最流行的 Web 开发框架，正如他的名字一样，使用它我们可以快速的开发一个 Web 应用。我们用 express 来搭建我们的博客，打开命令行，输入：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install -g express-generator</div></pre></td></tr></table></figure>
</li>
<li><p><strong>安装 express 命令行工具，使用它我们可以初始化一个 express 项目。在命令行中输入：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ express -e zhufengpeixunblog</div><div class="line">$ cd zhufengpeixunblog &amp;&amp; npm install</div></pre></td></tr></table></figure>
</li>
<li><p><strong>执行结果中会显示生成的文件并提示后续的命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">E:\&gt;express -e zhufengpeixunblog</div><div class="line"></div><div class="line">   create : zhufengpeixunblog</div><div class="line">   create : zhufengpeixunblog/package.json</div><div class="line">   create : zhufengpeixunblog/app.js</div><div class="line">   create : zhufengpeixunblog/public</div><div class="line">   create : zhufengpeixunblog/routes</div><div class="line">   create : zhufengpeixunblog/routes/index.js</div><div class="line">   create : zhufengpeixunblog/routes/users.js</div><div class="line">   create : zhufengpeixunblog/public/images</div><div class="line">   create : zhufengpeixunblog/public/javascripts</div><div class="line">   create : zhufengpeixunblog/views</div><div class="line">   create : zhufengpeixunblog/views/index.ejs</div><div class="line">   create : zhufengpeixunblog/views/error.ejs</div><div class="line">   create : zhufengpeixunblog/public/stylesheets</div><div class="line">   create : zhufengpeixunblog/public/stylesheets/style.css</div><div class="line">   create : zhufengpeixunblog/bin</div><div class="line">   create : zhufengpeixunblog/bin/www</div><div class="line"></div><div class="line">   install dependencies:</div><div class="line">     &gt; cd zhufengpeixunblog &amp;&amp; npm install</div><div class="line"></div><div class="line">   run the app:</div><div class="line">     &gt; SET DEBUG=zhufengpeixunblog:* &amp; npm start</div></pre></td></tr></table></figure>
</li>
<li><p><strong>进入生成的目录并安装依赖</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">E:\&gt;cd zhufengpeixunblog &amp;&amp; npm install</div><div class="line"></div><div class="line">debug@2.2.0 node_modules\debug</div><div class="line">└── ms@0.7.1</div><div class="line"></div><div class="line">morgan@1.6.1 node_modules\morgan</div><div class="line">├── on-headers@1.0.1</div><div class="line">├── basic-auth@1.0.3</div><div class="line">├── depd@1.0.1</div><div class="line">└── on-finished@2.3.0 (ee-first@1.1.1)</div><div class="line"></div><div class="line">cookie-parser@1.3.5 node_modules\cookie-parser</div><div class="line">├── cookie@0.1.3</div><div class="line">└── cookie-signature@1.0.6</div><div class="line"></div><div class="line">serve-favicon@2.3.0 node_modules\serve-favicon</div><div class="line">├── ms@0.7.1</div><div class="line">├── etag@1.7.0</div><div class="line">├── fresh@0.3.0</div><div class="line">└── parseurl@1.3.0</div><div class="line"></div><div class="line">body-parser@1.13.3 node_modules\body-parser</div><div class="line">├── bytes@2.1.0</div><div class="line">├── content-type@1.0.1</div><div class="line">├── depd@1.0.1</div><div class="line">├── on-finished@2.3.0 (ee-first@1.1.1)</div><div class="line">├── qs@4.0.0</div><div class="line">├── iconv-lite@0.4.11</div><div class="line">├── http-errors@1.3.1 (statuses@1.2.1, inherits@2.0.1)</div><div class="line">├── type-is@1.6.9 (media-typer@0.3.0, mime-types@2.1.7)</div><div class="line">└── raw-body@2.1.4 (unpipe@1.0.0, iconv-lite@0.4.12)</div><div class="line"></div><div class="line">express@4.13.3 node_modules\express</div><div class="line">├── escape-html@1.0.2</div><div class="line">├── array-flatten@1.1.1</div><div class="line">├── path-to-regexp@0.1.7</div><div class="line">├── merge-descriptors@1.0.0</div><div class="line">├── content-type@1.0.1</div><div class="line">├── methods@1.1.1</div><div class="line">├── utils-merge@1.0.0</div><div class="line">├── content-disposition@0.5.0</div><div class="line">├── range-parser@1.0.3</div><div class="line">├── serve-static@1.10.0</div><div class="line">├── vary@1.0.1</div><div class="line">├── depd@1.0.1</div><div class="line">├── cookie@0.1.3</div><div class="line">├── cookie-signature@1.0.6</div><div class="line">├── fresh@0.3.0</div><div class="line">├── etag@1.7.0</div><div class="line">├── on-finished@2.3.0 (ee-first@1.1.1)</div><div class="line">├── parseurl@1.3.0</div><div class="line">├── qs@4.0.0</div><div class="line">├── finalhandler@0.4.0 (unpipe@1.0.0)</div><div class="line">├── accepts@1.2.13 (negotiator@0.5.3, mime-types@2.1.7)</div><div class="line">├── type-is@1.6.9 (media-typer@0.3.0, mime-types@2.1.7)</div><div class="line">├── proxy-addr@1.0.8 (forwarded@0.1.0, ipaddr.js@1.0.1)</div><div class="line">└── send@0.13.0 (destroy@1.0.3, ms@0.7.1, statuses@1.2.1, mime@1.3.4, http-errors@1.3.1)</div><div class="line"></div><div class="line">E:\zhufengpeixunblog&gt;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>设置环境变量并启动服务器,在命令行中执行下列命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SET DEBUG=zhufengpeixunblog:* &amp; npm start</div></pre></td></tr></table></figure>
</li>
<li><p><strong>执行完成后会显示</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zhufengpeixunblog:server Listening on port 3000 +0ms</div></pre></td></tr></table></figure>
</li>
<li><p><strong>在浏览器里访问 <a href="http://localhost:3000" target="_blank" rel="external">http://localhost:3000</a> 就可以显示欢迎页面</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Express</div><div class="line">Welcome to Express</div></pre></td></tr></table></figure>
</li>
<li><p><strong>刚才我们就用express生成器生成了一个使用ejs模板的示例工程。</strong></p>
<h4 id="2-推送至github"><a href="#2-推送至github" class="headerlink" title="2.推送至github"></a>2.推送至github</h4></li>
<li><strong>创建.gitignore文件。里面内容</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">node_modules</div><div class="line">.idea</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-提交到本地仓库"><a href="#3-提交到本地仓库" class="headerlink" title="3.提交到本地仓库"></a>3.提交到本地仓库</h4><ul>
<li><strong>git init 初始化仓库</strong></li>
<li><strong>git add -A 把所有的文件添加到暂存区</strong></li>
<li><p><strong>git commit -m”初始化珠峰博客” 把所有的修改添加到历史区</strong></p>
<h4 id="4-创建远程仓库"><a href="#4-创建远程仓库" class="headerlink" title="4.创建远程仓库"></a>4.创建远程仓库</h4></li>
<li><p><strong>在github上登陆</strong></p>
</li>
<li><strong>创建一个新的项目，请特别注意</strong></li>
<li><strong>一定不要勾选Initialize this repository with a README 前面的复选框</strong></li>
<li><strong>也不要去下拉框里选择 .gitignore 或license</strong></li>
<li><strong>要保持默认，直接点击 Create repository</strong><h4 id="5-推送到远程仓库"><a href="#5-推送到远程仓库" class="headerlink" title="5.推送到远程仓库"></a>5.推送到远程仓库</h4></li>
<li><strong>git remote add origin <a href="https://github.com/zhufengnodejs/zhufengblog.git" target="_blank" rel="external">https://github.com/zhufengnodejs/zhufengblog.git</a> 添加远程仓库的关联</strong></li>
<li><strong>git push -u origin master 把本地的仓库推送到远程服务器上去</strong><h2 id="二-项目文件分析"><a href="#二-项目文件分析" class="headerlink" title="二.项目文件分析"></a>二.项目文件分析</h2><h4 id="1-生成文件说明"><a href="#1-生成文件说明" class="headerlink" title="1.生成文件说明"></a>1.生成文件说明</h4></li>
<li><strong>app.js：express的主配置文件</strong></li>
<li><strong>package.json：存储着工程的信息及模块依赖，当在 dependencies 中添加依赖的模块时，运行 npm install，npm 会检查当前目录下的 package.json，并自动安装所有指定的模块</strong></li>
<li><strong>node_modules：存放 package.json 中安装的模块，当你在 package.json 添加依赖的模块并安装后，存放在这个文件夹下</strong></li>
<li><strong>public：存放 image、css、js 等文件</strong></li>
<li><strong>routes：存放路由文件</strong></li>
<li><strong>views：存放视图文件或者说模版文件</strong></li>
<li><strong>bin：可执行文件，可以从此启动服务器</strong><h4 id="2-app-js"><a href="#2-app-js" class="headerlink" title="2. app.js"></a>2. app.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>); <span class="comment">//加载node_modules下的express模块</span></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> favicon = <span class="built_in">require</span>(<span class="string">'serve-favicon'</span>);</div><div class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</div><div class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> routes = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div><div class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();<span class="comment">// 生成一个express实例 app</span></div><div class="line"></div><div class="line"><span class="comment">// view engine setup</span></div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));<span class="comment">//设置 views 文件夹为存放视图文件的目录, 即存放模板文件的地方,__dirname 为全局变量,存储当前正在执行的脚本所在的目录。</span></div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>); <span class="comment">//设置视图模板引擎为 ejs。</span></div><div class="line"></div><div class="line"><span class="comment">// uncomment after placing your favicon in /public</span></div><div class="line"><span class="comment">//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico'))); 设置/public/favicon.ico为favicon图标。</span></div><div class="line">app.use(logger(<span class="string">'dev'</span>)); <span class="comment">//加载日志中间件。</span></div><div class="line">app.use(bodyParser.json()); <span class="comment">//加载解析json的中间件。</span></div><div class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));<span class="comment">//加载解析urlencoded请求体的中间件。</span></div><div class="line">app.use(cookieParser()); <span class="comment">//加载解析cookie的中间件。</span></div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>))); <span class="comment">//设置public文件夹为存放静态文件的目录。</span></div><div class="line"></div><div class="line">app.use(<span class="string">'/'</span>, routes); <span class="comment">//根目录的路由</span></div><div class="line">app.use(<span class="string">'/users'</span>, users);<span class="comment">// 用户路由</span></div><div class="line"></div><div class="line"><span class="comment">// catch 404 and forward to error handler 捕获404错误，并转发到错误处理器。</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found'</span>);</div><div class="line">  err.status = <span class="number">404</span>;</div><div class="line">  next(err);</div><div class="line">&#125;);</div><div class="line"><span class="comment">// error handlers 错误处理器</span></div><div class="line"></div><div class="line"><span class="comment">// development error handler 开发环境下的错误处理</span></div><div class="line"><span class="comment">// will print stacktrace 将打印出堆栈信息</span></div><div class="line"><span class="keyword">if</span> (app.get(<span class="string">'env'</span>) === <span class="string">'development'</span>) &#123;</div><div class="line">  app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">    res.status(err.status || <span class="number">500</span>);</div><div class="line">    res.render(<span class="string">'error'</span>, &#123;</div><div class="line">      <span class="attr">message</span>: err.message,</div><div class="line">      <span class="attr">error</span>: err</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// production error handler 生产环境下的错误处理</span></div><div class="line"><span class="comment">// no stacktraces leaked to user 不向用户暴露堆栈信息</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  res.status(err.status || <span class="number">500</span>);</div><div class="line">  res.render(<span class="string">'error'</span>, &#123;</div><div class="line">    <span class="attr">message</span>: err.message,</div><div class="line">    <span class="attr">error</span>: &#123;&#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = app;  <span class="comment">//导出app供 bin/www 使用</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-bin-www"><a href="#3-bin-www" class="headerlink" title="3. bin/www"></a>3. bin/www</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env node  表明是 node 可执行文件。</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Module dependencies.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'../app'</span>);<span class="comment">// 引入我们上面app.js导出的app实例</span></div><div class="line"><span class="keyword">var</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'zhufengpeixunblog:server'</span>); <span class="comment">// 引入打印调试日志的debug模块，并设置名称。</span></div><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>); <span class="comment">//引入http</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get port from environment and store in Express. 从环境变量中获取端口号并存放到express中</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> port = normalizePort(process.env.PORT || <span class="string">'3000'</span>);<span class="comment">// 设置端口号</span></div><div class="line">app.set(<span class="string">'port'</span>, port); <span class="comment">//设置端口号</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Create HTTP server. 创建http服务器</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">var</span> server = http.createServer(app); </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Listen on provided port, on all network interfaces. 在所有的网络接口中监听提供的端口</div><div class="line"> */</div><div class="line"></div><div class="line">server.listen(port);</div><div class="line">server.on(<span class="string">'error'</span>, onError);<span class="comment">// 监听错误事件</span></div><div class="line">server.on(<span class="string">'listening'</span>, onListening); <span class="comment">//启动工程并监听3000端口，成功后打印 Express server listening on port 3000</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Normalize a port into a number, string, or false. 把一个端口处理成一个数字或字符串或者false</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizePort</span>(<span class="params">val</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> port = <span class="built_in">parseInt</span>(val, <span class="number">10</span>); <span class="comment">//先试图转成10进制数字</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="built_in">isNaN</span>(port)) &#123;</div><div class="line">    <span class="comment">// named pipe 转不成数字就当作命名管道来处理</span></div><div class="line">    <span class="keyword">return</span> val;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (port &gt;= <span class="number">0</span>) &#123;</div><div class="line">    <span class="comment">// port number 如果端口大于0就返回端口</span></div><div class="line">    <span class="keyword">return</span> port;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">//不是命名管道，也不是正常端口就返回false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Event listener for HTTP server "error" event. 服务器的错误事件监听器</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">error</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (error.syscall !== <span class="string">'listen'</span>) &#123; <span class="comment">//如果系统调用不是监听则抛出错误</span></div><div class="line">    <span class="keyword">throw</span> error;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> bind = <span class="keyword">typeof</span> port === <span class="string">'string'</span></div><div class="line">    ? <span class="string">'Pipe '</span> + port</div><div class="line">    : <span class="string">'Port '</span> + port;</div><div class="line"></div><div class="line">  <span class="comment">// handle specific listen errors with friendly messages 更友好的处理特定的监听错误</span></div><div class="line">  <span class="keyword">switch</span> (error.code) &#123; <span class="comment">//错误编码</span></div><div class="line">    <span class="keyword">case</span> <span class="string">'EACCES'</span>:<span class="comment">// 没有权限</span></div><div class="line">      <span class="built_in">console</span>.error(bind + <span class="string">' requires elevated privileges'</span>); 没有权限绑定指定的端口</div><div class="line">      process.exit(<span class="number">1</span>); <span class="comment">//异常退出</span></div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="string">'EADDRINUSE'</span>: <span class="comment">//端口被占用</span></div><div class="line">      <span class="built_in">console</span>.error(bind + <span class="string">' is already in use'</span>);<span class="comment">//端口被占用</span></div><div class="line">      process.exit(<span class="number">1</span>);<span class="comment">//异常退出</span></div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">throw</span> error; <span class="comment">//其它的情况抛出错误并中止进程</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Event listener for HTTP server "listening" event. 服务器的监听端口成功事件回调</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onListening</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> addr = server.address();<span class="comment">// 取得服务器的地址</span></div><div class="line">  <span class="keyword">var</span> bind = <span class="keyword">typeof</span> addr === <span class="string">'string'</span> <span class="comment">//监听地址如果是字符串返回命名管道名，如果是数字返回端口</span></div><div class="line">    ? <span class="string">'pipe '</span> + addr</div><div class="line">    : <span class="string">'port '</span> + addr.port;</div><div class="line">  debug(<span class="string">'Listening on '</span> + bind); <span class="comment">//记录日志</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-routes-index-js"><a href="#4-routes-index-js" class="headerlink" title="4. routes/index.js"></a>4. routes/index.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);<span class="comment">// 导入express模块</span></div><div class="line"><span class="keyword">var</span> router = express.Router();<span class="comment">// 生成一个路由实例</span></div><div class="line"></div><div class="line"><span class="comment">/* GET home page.  取得主页*/</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123; <span class="comment">//当用户访问根目录也就是 / 的时候执行此回调</span></div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;); <span class="comment">//渲染views/index.ejs模版并显示到浏览器中</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router; <span class="comment">//导出这个路由并在app.js中通过app.use('/', routes); 加载</span></div></pre></td></tr></table></figure>
<h4 id="5-views-index-ejs"><a href="#5-views-index-ejs" class="headerlink" title="5. views/index.ejs"></a>5. views/index.ejs</h4><p>在渲染模板时我们传入了一个变量 title 值为 express 字符串，模板引擎会将所有 &lt;%= title %&gt; 替换为 express ，然后将渲染后生成的html显示到浏览器中<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome to <span class="tag">&lt;<span class="name">%=</span> <span class="attr">title</span> %&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="三-路由介绍"><a href="#三-路由介绍" class="headerlink" title="三.路由介绍"></a>三.路由介绍</h2><h4 id="1-工作原理"><a href="#1-工作原理" class="headerlink" title="1.工作原理"></a>1.工作原理</h4><p>routes/index.js 中有以下代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">/* GET home page. */</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure></p>
<p>这段代码的意思是当访问主页时，调用 ejs 模板引擎，来渲染 index.ejs 模版文件（即将 title 变量全部替换为字符串 Express），生成静态页面并显示在浏览器中。</p>
<h4 id="2-路由配置"><a href="#2-路由配置" class="headerlink" title="2.路由配置"></a>2.路由配置</h4><p>express 封装了多种 http 请求方式，主要只使用 get 和 post 两种，即 app.get() 和 app.post() 。 app.get() 和 app.post() 的第一个参数都为请求的路径，第二个参数为处理请求的回调函数，回调函数有两个参数分别是 req 和 res，代表请求信息和响应信息 。路径请求及对应的获取路径有以下几种形式：</p>
<ul>
<li><p><strong>req.query(处理 get 请求，获取查询字符串)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GET /index.html?name=zfpx</div><div class="line">req.query.name  -&gt; zfpx</div></pre></td></tr></table></figure>
</li>
<li><p><strong>req.params(处理 /:name 形式的 get 或 post 请求，获取请求参数)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// GET /user/zfpx </div><div class="line">req.params.name -&gt; zfpx</div></pre></td></tr></table></figure>
</li>
<li><p><strong>req.body(处理 post 请求，获取 post 请求体)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">req.body.name</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="四-模板引擎"><a href="#四-模板引擎" class="headerlink" title="四.模板引擎"></a>四.模板引擎</h2><h4 id="1-什么是模板引擎"><a href="#1-什么是模板引擎" class="headerlink" title="1.什么是模板引擎"></a>1.什么是模板引擎</h4><p>模板引擎（Template Engine）是一个将页面模板和要显示的数据结合起来生成 HTML 页面的工具。 如果说上面讲到的 express 中的路由控制方法相当于 MVC 中的控制器的话，那模板引擎就相当于 MVC 中的视图。</p>
<h4 id="2-ejs"><a href="#2-ejs" class="headerlink" title="2.ejs"></a>2.ejs</h4><p>ejs使用起来十分简单，而且与 express 集成良好。</p>
<h4 id="3-使用模板引擎"><a href="#3-使用模板引擎" class="headerlink" title="3. 使用模板引擎"></a>3. 使用模板引擎</h4><p>前面我们通过以下两行代码设置了模板文件的存储位置和使用的模板引擎：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：我们通过 express -e zhufengpeixunblog 只是初始化了一个使用 ejs 模板引擎的工程而已，比如 node_modules 下添加了 ejs 模块，views 文件夹下有 index.ejs 。并不是说强制该工程只能使用 ejs 不能使用其他的模板引擎比如 jade，真正指定使用哪个模板引擎的是 app.set(‘view engine’, ‘ejs’); 。<br></p>
<p>在 routes/index.js 中通过调用 res.render() 渲染模版，并将其产生的页面直接返回给客户端。它接受两个参数，第一个是模板的名称，即 views 目录下的模板文件名，扩展名 .ejs 可选。第二个参数是传递给模板的数据对象，用于模板翻译。</p>
<p>打开 views/index.ejs ，内容如下：</p>
<p><strong>index.ejs</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> router = express.Router();</div><div class="line"></div><div class="line"><span class="comment">/* GET home page. */</span></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router;</div></pre></td></tr></table></figure></p>
<p>当我们 res.render(‘index’, { title: ‘Express’ }); 时，模板引擎会把 &lt;%= title %&gt; 替换成 Express，然后把替换后的页面显示给用户。</p>
<p>渲染后生成的页面代码为：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Express<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Express<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome to Express<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意：我们通过 app.use(express.static(path.join(__dirname, ‘public’))) 设置了静态文件目录为 public 文件夹， 所以上面代码中的 href=’/stylesheets/style.css’ 就相当于 href=’public/stylesheets/style.css’ 。</p>
<p>ejs 的标签系统非常简单，它只有以下三种标签：</p>
<p>&lt;% code %&gt;：JavaScript 代码。 &lt;%= code %&gt;：显示替换过 HTML 特殊字符的内容。 &lt;%- code %&gt;：显示原始 HTML 内容。 注意： &lt;%= code %&gt; 和 &lt;%- code %&gt; 的区别，当变量 code 为普通字符串时，两者没有区别。当 code 比如为<br>:hello这种字符串时，&lt;%= code %&gt; 会原样输出hello，而 &lt;%- code %&gt; 则会显示 H1 大的 hello 字符串。</p>
<h4 id="4-页面布局"><a href="#4-页面布局" class="headerlink" title="4.页面布局"></a>4.页面布局</h4><p>这里我们不使用layout进行页面布局，而是使用更为简单灵活的include。include 的简单使用如下：</p>
<p><strong>index.ejs</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;%- include a %&gt;</div><div class="line">hello,world!</div><div class="line">&lt;%- include b %&gt;</div></pre></td></tr></table></figure></p>
<p><strong>a.ejs</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is a.ejs</div></pre></td></tr></table></figure></p>
<p><strong>b.ejs</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is b.ejs</div></pre></td></tr></table></figure></p>
<p>最终 index.ejs 会显示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">this is a.ejs</div><div class="line">hello,world!</div><div class="line">this is b.ejs</div></pre></td></tr></table></figure></p>
<h2 id="五-路由规划"><a href="#五-路由规划" class="headerlink" title="五.路由规划"></a>五.路由规划</h2><h4 id="1-路由规划"><a href="#1-路由规划" class="headerlink" title="1.路由规划"></a>1.路由规划</h4><p>我们已经把设计的构想图贴出来了，接下来的任务就是完成路由规划了。路由规划，或者说控制器规划是整个网站的骨架部分，因为它处于整个架构的枢纽位置，相当于各个接口之间的粘合剂，所以应该优先考虑。</p>
<ul>
<li>/ ：首页</li>
<li>/users/login ：用户登录</li>
<li>/users/reg ：用户注册</li>
<li>/articles/post ：发表文章</li>
<li>/articles/logout ：登出<h4 id="2-增加路由"><a href="#2-增加路由" class="headerlink" title="2.增加路由"></a>2.增加路由</h4>routes/users.js 中添加下列代码<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 用户注册</div><div class="line"> */</div><div class="line">router.get(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'user/reg'</span>, &#123;<span class="attr">title</span>: <span class="string">'注册'</span>&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 当填写用户注册信息提交时的处理</div><div class="line"> */</div><div class="line">router.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 显示用户登录表单</div><div class="line"> */</div><div class="line">router.get(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'user/login'</span>, &#123;<span class="attr">title</span>: <span class="string">'登录'</span>&#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 当填写用户登录信息提交时的处理</div><div class="line"> */</div><div class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.get(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>routes/articles.js 中添加下列代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'article/add'</span>, &#123; <span class="attr">title</span>: <span class="string">'发表文章'</span> &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.post(<span class="string">'/add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="2-修改app-js"><a href="#2-修改app-js" class="headerlink" title="2.修改app.js"></a>2.修改app.js</h4><p>app.js中添加以下代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> articles = <span class="built_in">require</span>(<span class="string">'./routes/article'</span>);</div><div class="line">app.use(<span class="string">'/articles'</span>, articles);</div></pre></td></tr></table></figure></p>
<h4 id="3-增加模板"><a href="#3-增加模板" class="headerlink" title="3.增加模板"></a>3.增加模板</h4><p>views下增加以下文件</p>
<ul>
<li><p><strong>views/article/add.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;%= title %&gt;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>views/user/login.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;%= title %&gt;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>views/user/reg.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;%= title %&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-效果"><a href="#4-效果" class="headerlink" title="4.效果"></a>4.效果</h4><p><strong>用户注册</strong></p>
<ul>
<li><a href="http://localhost:3000/users/reg" target="_blank" rel="external">http://localhost:3000/users/reg</a></li>
</ul>
<p><strong>用户登陆</strong></p>
<ul>
<li><a href="http://localhost:3000/users/login" target="_blank" rel="external">http://localhost:3000/users/login</a></li>
</ul>
<p><strong>发表文章</strong></p>
<ul>
<li><a href="http://localhost:3000/articles/add" target="_blank" rel="external">http://localhost:3000/articles/add</a></li>
</ul>
<h2 id="六-开发准备"><a href="#六-开发准备" class="headerlink" title="六.开发准备"></a>六.开发准备</h2><h4 id="1-mongodb"><a href="#1-mongodb" class="headerlink" title="1.mongodb"></a>1.mongodb</h4><p>mongodb初级入门</p>
<p>mongoose实用教程</p>
<h4 id="2-node会话"><a href="#2-node会话" class="headerlink" title="2.node会话"></a>2.node会话</h4><p>node会话</p>
<h4 id="3-MD5加密算法"><a href="#3-MD5加密算法" class="headerlink" title="3.MD5加密算法"></a>3.MD5加密算法</h4><p><strong>算法简介</strong></p>
<p>MD5的全称是Message-Digest Algorithm 5（信息-摘要算法），在90年代初由Mit Laboratory for Computer Science和Rsa data security inc的Ronald l. rivest开发出来，经md2、md3和md4发展而来。它的作用是让大容量信息在用数字签名软件签署私人密匙前被“压缩”成一种保密的格式（就是把一个任意长度的字节串变换成一定长的大整数）.不管是md2、md4还是md5，它们都需要获得一个随机长度的信息并产生一个128位的信息摘要.<br>MD5 算法的哈希值大小为 128 位。是一种不可逆的算法。</p>
<p><strong>算法特点</strong></p>
<ul>
<li>两个不同的明文不会得到相同的输出值</li>
<li>MD5结果不能反推明文，不可逆</li>
</ul>
<p><strong>安全性</strong></p>
<p>从安全的角度讲，MD5的输出为128位，若采用纯强力攻击寻找一个消息具有给定Hash值的计算困难性为2128，用每秒可试验1000000000个消息的计算机需时1.07×1022年。若采用生日攻击法，寻找有相同Hash值的两个消息需要试验264个消息，用每秒可试验1000000000个消息的计算机需时585年。<br> 实际应用上，例如我知道‘password’的MD5值是5f4dcc3b5aa765d61d8327deb882cf99，那么我就用一个数据库存起来，只要我看到5f4dcc3b5aa765d61d8327deb882cf99，我就知道这个是口令‘password‘使用MD5处理之后的值，原来的口令就是’password’。MD5在身份鉴别系统中用于口令保护已经是很久了事情了，大部分黑客也有针对这种Hash方式准备相应的数据库进行反查，这种数据库称为彩虹表，MD5的安全性大大减弱。</p>
<p><strong>MD5加密例程</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</div><div class="line"><span class="keyword">var</span> content = <span class="string">'password'</span></div><div class="line"><span class="keyword">var</span> md5 = crypto.createHash(<span class="string">'md5'</span>);</div><div class="line">md5.update(content);</div><div class="line"><span class="keyword">var</span> d = md5.digest(<span class="string">'hex'</span>);  <span class="comment">//MD5值是5f4dcc3b5aa765d61d8327deb882cf99</span></div></pre></td></tr></table></figure></p>
<p><strong>SHA1算法</strong></p>
<p>SHA1的全称是Secure Hash Algorithm(安全哈希算法)。加密哈希函数将任意长度的二进制字符串映射为固定长度的小型二进制字符串。加密哈希函数有这样一个属性：在计算上不大可能找到散列为相同的值的两个不同的输入；也就是说，两组数据的哈希值仅在对应的数据也匹配时才会匹配。数据的少量更改会在哈希值中产生不可预知的大量更改。所以你很难从加密后的文字中找到蛛丝马迹。<br>SHA1 算法的哈希值大小为 160 位。是一种不可逆的算法。</p>
<p><strong>SHA1加密例程</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</div><div class="line"><span class="keyword">var</span> content = <span class="string">'password'</span></div><div class="line"><span class="keyword">var</span> shasum = crypto.createHash(<span class="string">'sha1'</span>);</div><div class="line">shasum.update(content);</div><div class="line"><span class="keyword">var</span> d = shasum.digest(<span class="string">'hex'</span>);</div></pre></td></tr></table></figure></p>
<p><strong>MD5与sha1的不同点</strong></p>
<p>MD5最后生成的摘要信息是16个字节，SHA1是20个字节。</p>
<h2 id="七-初始化bower"><a href="#七-初始化bower" class="headerlink" title="七.初始化bower"></a>七.初始化bower</h2><h4 id="1-初始化bower"><a href="#1-初始化bower" class="headerlink" title="1.初始化bower"></a>1.初始化bower</h4><p>先执行此命令，然后会执行一系列交互问答 bower init<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">E:\zhufengpeixunblog&gt;bower init</div><div class="line">? name: zhufengpeixunblog</div><div class="line">? version: 0.0.0</div><div class="line">? description:</div><div class="line">? main file:</div><div class="line">? what types of modules does this package expose?</div><div class="line">? keywords:</div><div class="line">? authors: zhangrenyang-t510 &lt;zhang_renyang@&gt;</div><div class="line">? license: MIT</div><div class="line">? homepage:</div><div class="line">? set currently installed components as dependencies? Yes</div><div class="line">? add commonly ignored files to ignore list? Yes</div><div class="line">? would you like to mark this package as private which prevents it from being accidentally published to the regis</div><div class="line">? would you like to mark this package as private which prevents it from being accidentally published to the regis</div><div class="line"></div><div class="line">&#123;</div><div class="line">  name: &apos;zhufengpeixunblog&apos;,</div><div class="line">  version: &apos;0.0.0&apos;,</div><div class="line">  authors: [</div><div class="line">    &apos;zhangrenyang-t510 &lt;zhang_renyang@&gt;&apos;</div><div class="line">  ],</div><div class="line">  license: &apos;MIT&apos;,</div><div class="line">  ignore: [</div><div class="line">    &apos;**/.*&apos;,</div><div class="line">    &apos;node_modules&apos;,</div><div class="line">    &apos;bower_components&apos;,</div><div class="line">    &apos;test&apos;,</div><div class="line">    &apos;tests&apos;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"></div><div class="line">? Looks good? Yes</div></pre></td></tr></table></figure></p>
<p>执行完此命令后会生成一个 bower.json 文件。</p>
<h4 id="2-创建配置文件-bowerrc"><a href="#2-创建配置文件-bowerrc" class="headerlink" title="2.创建配置文件 .bowerrc"></a>2.创建配置文件 .bowerrc</h4><p>里面内容如下:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"directory"</span>:<span class="string">"./public/lib"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>这表示以后bower安装的模块都安装在./public/lib下面。</p>
<h4 id="3-安装bootstrap"><a href="#3-安装bootstrap" class="headerlink" title="3.安装bootstrap"></a>3.安装bootstrap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bower install bootstrap --save</div></pre></td></tr></table></figure>
<p>大家可以看到，不但安装了bootstrap,也安装了依赖的jquery<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">E:\zhufengpeixunblog&gt;bower install bootstrap --save</div><div class="line">bower bootstrap#*               cached git://github.com/twbs/bootstrap.git#3.3.5</div><div class="line">bower bootstrap#*             validate 3.3.5 against git://github.com/twbs/bootstrap.git#*</div><div class="line">bower jquery#&gt;= 1.9.1           cached git://github.com/jquery/jquery.git#2.1.4</div><div class="line">bower jquery#&gt;= 1.9.1         validate 2.1.4 against git://github.com/jquery/jquery.git#&gt;= 1.9.1</div><div class="line">bower bootstrap#~3.3.5         install bootstrap#3.3.5</div><div class="line">bower jquery#&gt;= 1.9.1          install jquery#2.1.4</div><div class="line"></div><div class="line">bootstrap#3.3.5 public\lib\bootstrap</div><div class="line">└── jquery#2.1.4</div><div class="line"></div><div class="line">jquery#2.1.4 public\lib\jquery</div></pre></td></tr></table></figure></p>
<h2 id="八-完善页面"><a href="#八-完善页面" class="headerlink" title="八.完善页面"></a>八.完善页面</h2><h4 id="1-在views下创建include文件夹，在include下添加包含的头部"><a href="#1-在views下创建include文件夹，在include下添加包含的头部" class="headerlink" title="1.在views下创建include文件夹，在include下添加包含的头部"></a>1.在views下创建include文件夹，在include下添加包含的头部</h4><p>header.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html lang=&quot;zh-CN&quot;&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</div><div class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</div><div class="line">    &lt;title&gt;珠峰博客&lt;/title&gt;</div><div class="line">    &lt;link href=&quot;/lib/bootstrap/dist/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;!--最外面的容器nav标签，并添加nav-bar样式类，表示这里面属于导航条 --&gt;</div><div class="line">&lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt;</div><div class="line">    &lt;!--第二步：增加header--&gt;</div><div class="line">    &lt;div class=&quot;navbar-header&quot;&gt;</div><div class="line">        &lt;!--最左侧的，默认不可见 按钮标签里嵌套了三个span的icon。然后给与navbar-toggle样式类和属性collapse(收起)，点击的时候目标为data-target。当窗口缩小到一定程度，右侧的效果显现。--&gt;</div><div class="line">        &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#menus&quot;&gt;</div><div class="line">            &lt;span class=&quot;sr-only&quot;&gt;珠峰博客&lt;/span&gt;</div><div class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">        &lt;/button&gt;</div><div class="line">        &lt;a href=&quot;/&quot; class=&quot;navbar-brand&quot;&gt;珠峰博客&lt;/a&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;!-- 放置其它的导航条 --&gt;</div><div class="line">    &lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;menus&quot;&gt;</div><div class="line">        &lt;ul class=&quot;nav navbar-nav&quot;&gt;</div><div class="line">            &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;/users/reg&quot;&gt;注册&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/users/login&quot;&gt;登录&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/articles/add&quot;&gt;发表文章&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/users/logout&quot;&gt;登出&lt;/a&gt;&lt;/li&gt;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/nav&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-在include下添加包含的尾部"><a href="#2-在include下添加包含的尾部" class="headerlink" title="2.在include下添加包含的尾部"></a>2.在include下添加包含的尾部</h4><p>footer.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;/lib/jquery/dist/jquery.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;script src=&quot;/lib/bootstrap/dist/js/bootstrap.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h4 id="3-修改首页"><a href="#3-修改首页" class="headerlink" title="3.修改首页"></a>3.修改首页</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;% include include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line"> 主页</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<p>效果如下:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://7xjf2l.com2.z0.glb.qiniucdn.com/homepage.jpg"</span> <span class="attr">class</span>=<span class="string">"img-responsive"</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="4-修改用户注册页面"><a href="#4-修改用户注册页面" class="headerlink" title="4.修改用户注册页面"></a>4.修改用户注册页面</h4><p>views/user/reg.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&lt;% include ../include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line">    &lt;form action=&quot;/users/reg&quot; method=&quot;post&quot;  role=&quot;form&quot; class=&quot;form-horizontal&quot;&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;username&quot; class=&quot;col-sm-2 control-label&quot;&gt;用户名&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt; &lt;span class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/span&gt; &lt;/div&gt;</div><div class="line">                &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;username&quot; name=&quot;username&quot; placeholder=&quot;用户名&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line"></div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;email&quot; class=&quot;col-sm-2 control-label&quot;&gt;邮箱&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-envelope&quot;&gt;&lt;/span&gt;&lt;/div&gt;</div><div class="line">                &lt;input type=&quot;email&quot; class=&quot;form-control&quot; name=&quot;email&quot; id=&quot;email&quot; placeholder=&quot;邮箱&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;password&quot; class=&quot;col-sm-2 control-label&quot;&gt;确认密码&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-lock&quot;&gt;&lt;/span&gt;&lt;/div&gt;</div><div class="line">&lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; id=&quot;password&quot; placeholder=&quot;密码&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;repassword&quot; class=&quot;col-sm-2 control-label&quot;&gt;确认密码&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-lock&quot;&gt;&lt;/span&gt;&lt;/div&gt;</div><div class="line">                &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;repassword&quot; id=&quot;repassword&quot; placeholder=&quot;确认密码&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;div class=&quot;col-sm-offset-2 col-sm-10&quot;&gt;</div><div class="line">                &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">                &lt;button type=&quot;reset&quot; class=&quot;btn btn-default&quot;&gt;重置&lt;/button&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include ../include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h4 id="5-修改用户登录界面"><a href="#5-修改用户登录界面" class="headerlink" title="5.修改用户登录界面"></a>5.修改用户登录界面</h4><p>views/user/login.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&lt;% include ../include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line">    &lt;form action=&quot;/users/login&quot; method=&quot;post&quot;  role=&quot;form&quot; class=&quot;form-horizontal&quot;&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;username&quot; class=&quot;col-sm-2 control-label&quot;&gt;用户名&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt; &lt;span class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/span&gt; &lt;/div&gt;</div><div class="line">                &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;username&quot; name=&quot;username&quot; placeholder=&quot;用户名&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line"></div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;password&quot; class=&quot;col-sm-2 control-label&quot;&gt;确认密码&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;input-group col-sm-10&quot;&gt;</div><div class="line">                &lt;div class=&quot;input-group-addon&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-lock&quot;&gt;&lt;/span&gt;&lt;/div&gt;</div><div class="line">                &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name=&quot;password&quot; id=&quot;password&quot; placeholder=&quot;密码&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;div class=&quot;col-sm-offset-2 col-sm-10&quot;&gt;</div><div class="line">                &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">                &lt;button type=&quot;reset&quot; class=&quot;btn btn-default&quot;&gt;重置&lt;/button&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include ../include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h4 id="6-修改发表文章页面"><a href="#6-修改发表文章页面" class="headerlink" title="6.修改发表文章页面"></a>6.修改发表文章页面</h4><p>views/article/add.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;% include ../include/header.ejs%&gt;</div><div class="line">  &lt;div class=&quot;container&quot;&gt;</div><div class="line">      &lt;form action=&quot;/articles/add&quot; method=&quot;post&quot;  role=&quot;form&quot; class=&quot;form-horizontal&quot;&gt;</div><div class="line">          &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">              &lt;label for=&quot;title&quot; class=&quot;col-sm-2 control-label&quot;&gt;标题&lt;/label&gt;</div><div class="line">              &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                  &lt;input type=&quot;text&quot; value=&quot;&quot; class=&quot;form-control&quot; id=&quot;title&quot; name=&quot;title&quot; placeholder=&quot;标题&quot;/&gt;</div><div class="line">              &lt;/div&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">          &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">              &lt;label for=&quot;content&quot; class=&quot;col-sm-2 control-label&quot;&gt;正文&lt;/label&gt;</div><div class="line">              &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                  &lt;textarea class=&quot;form-control&quot;   id=&quot;&quot; cols=&quot;30&quot; rows=&quot;10&quot; id=&quot;content&quot; name=&quot;content&quot; placeholder=&quot;请输入内容&quot;&gt;&lt;/textarea&gt;</div><div class="line">              &lt;/div&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">          &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">              &lt;div class=&quot;col-sm-offset-2 col-sm-10&quot;&gt;</div><div class="line">                  &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">                  &lt;button type=&quot;reset&quot; class=&quot;btn btn-default&quot;&gt;重置&lt;/button&gt;</div><div class="line">              &lt;/div&gt;</div><div class="line">          &lt;/div&gt;</div><div class="line">      &lt;/form&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;% include ../include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h2 id="九-连接数据库"><a href="#九-连接数据库" class="headerlink" title="九.连接数据库"></a>九.连接数据库</h2><h4 id="1-安装数据库支持"><a href="#1-安装数据库支持" class="headerlink" title="1. 安装数据库支持"></a>1. 安装数据库支持</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install mongoose --save</div></pre></td></tr></table></figure>
<p>安装mongodb模块到node_modules下面并把此配置添加到package.json文件中</p>
<h4 id="2-在工程根目录下创建-settings-js-文件"><a href="#2-在工程根目录下创建-settings-js-文件" class="headerlink" title="2.在工程根目录下创建 settings.js 文件"></a>2.在工程根目录下创建 settings.js 文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">cookieSecret</span>:<span class="string">'zhufengkey'</span>, <span class="comment">//用于 Cookie 加密与数据库无关</span></div><div class="line">    db:<span class="string">'zhufengblog'</span>,<span class="comment">//数据库的名称</span></div><div class="line">    host:<span class="string">'123.57.143.189'</span>, <span class="comment">//数据库的地址</span></div><div class="line">    port:<span class="number">27017</span>,  <span class="comment">//数据库的端口号</span></div><div class="line">    url:<span class="string">"mongodb://123.57.143.189:27017/zhufengblog"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-编写数据库交互-创建db文件夹-在db文件夹下创建文件models-js"><a href="#3-编写数据库交互-创建db文件夹-在db文件夹下创建文件models-js" class="headerlink" title="3.编写数据库交互 创建db文件夹 在db文件夹下创建文件models.js"></a>3.编写数据库交互 创建db文件夹 在db文件夹下创建文件models.js</h4><p>此文件存放着所有的模型<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line"><span class="keyword">var</span> ObjectId = mongoose.Schema.Types.ObjectId;</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">User</span>:&#123; <span class="comment">//设置User的数据模型 </span></div><div class="line">        username:&#123;<span class="attr">type</span>:<span class="built_in">String</span>,<span class="attr">required</span>:<span class="literal">true</span>&#125;,<span class="comment">//用户名</span></div><div class="line">        password:&#123;<span class="attr">type</span>:<span class="built_in">String</span>,<span class="attr">required</span>:<span class="literal">true</span>&#125;,<span class="comment">//密码</span></div><div class="line">        email:&#123;<span class="attr">type</span>:<span class="built_in">String</span>,<span class="attr">required</span>:<span class="literal">true</span>&#125;,<span class="comment">//邮箱</span></div><div class="line">        avatar:&#123;<span class="attr">type</span>:<span class="built_in">String</span>,<span class="attr">required</span>:<span class="literal">true</span>&#125;<span class="comment">//头像</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">Article</span>: &#123; <span class="comment">//设置文章的数据模型</span></div><div class="line">        user:&#123;<span class="attr">type</span>:ObjectId,<span class="attr">ref</span>:<span class="string">'User'</span>&#125;, <span class="comment">//用户</span></div><div class="line">        title: <span class="built_in">String</span>, <span class="comment">//标题</span></div><div class="line">        content: <span class="built_in">String</span>, <span class="comment">//内容</span></div><div class="line">        createAt:&#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now&#125; <span class="comment">//创建时间</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-在db文件夹下创建文件index-js"><a href="#4-在db文件夹下创建文件index-js" class="headerlink" title="4.在db文件夹下创建文件index.js"></a>4.在db文件夹下创建文件index.js</h4><p>此文件负责向外暴露模型,因为Model赋给了global作为属性，那就意味着在程序任何地方都可以调用了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>),</div><div class="line">    Schema = mongoose.Schema,</div><div class="line">    models = <span class="built_in">require</span>(<span class="string">'./models'</span>);</div><div class="line"><span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'../settings'</span>);    </div><div class="line">mongoose.connect(settings.url);</div><div class="line">mongoose.model(<span class="string">'User'</span>, <span class="keyword">new</span> Schema(models.User));</div><div class="line">mongoose.model(<span class="string">'Article'</span>, <span class="keyword">new</span> Schema(models.Article));</div><div class="line">global.Model = <span class="function"><span class="keyword">function</span> (<span class="params">type</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> mongoose.model(type);;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h4 id="5-在app-js中添加"><a href="#5-在app-js中添加" class="headerlink" title="5.在app.js中添加"></a>5.在app.js中添加</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>(<span class="string">'./db'</span>); <span class="comment">//导入db模块</span></div></pre></td></tr></table></figure>
<h2 id="十-实现会话支持"><a href="#十-实现会话支持" class="headerlink" title="十.实现会话支持"></a>十.实现会话支持</h2><h4 id="1-安装会话支持模块"><a href="#1-安装会话支持模块" class="headerlink" title="1.安装会话支持模块"></a>1.安装会话支持模块</h4><p>使用 express-session 和 connect-mongo 模块实现了将会话信息存储到mongodb中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install express-session --save</div><div class="line">npm install connect-mongo --save</div></pre></td></tr></table></figure></p>
<h4 id="2-修改app-js-1"><a href="#2-修改app-js-1" class="headerlink" title="2.修改app.js"></a>2.修改app.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'./settings'</span>);</div><div class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</div><div class="line"><span class="keyword">var</span> MongoStore = <span class="built_in">require</span>(<span class="string">'connect-mongo'</span>)(session);</div><div class="line">app.use(session(&#123;</div><div class="line">  <span class="attr">secret</span>: settings.cookieSecret,<span class="comment">//secret 用来防止篡改 cookie</span></div><div class="line">  key: settings.db,<span class="comment">//key 的值为 cookie 的名字</span></div><div class="line">  cookie: &#123;<span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>&#125;,<span class="comment">//设定 cookie 的生存期，这里我们设置 cookie 的生存期为 30 天</span></div><div class="line">  resave:<span class="literal">true</span>,</div><div class="line">  <span class="attr">saveUninitialized</span>:<span class="literal">true</span>,</div><div class="line">  <span class="attr">store</span>: <span class="keyword">new</span> MongoStore(&#123; <span class="comment">//设置它的 store 参数为 MongoStore 实例，把会话信息存储到数据库中，以避免重启服务器时会话丢失</span></div><div class="line">    db: settings.db,</div><div class="line">    <span class="attr">host</span>: settings.host,</div><div class="line">    <span class="attr">port</span>: settings.port,</div><div class="line">  &#125;)</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>添加完了以后我们就可以路由中通过request.session来操作会话对象了.</p>
<h2 id="十一-用户注册登陆"><a href="#十一-用户注册登陆" class="headerlink" title="十一.用户注册登陆"></a>十一.用户注册登陆</h2><h4 id="1-增加工具方法"><a href="#1-增加工具方法" class="headerlink" title="1.增加工具方法"></a>1.增加工具方法</h4><p>在routes/users.js中增加md5加密的工具方法<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5</span>(<span class="params">val</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">'crypto'</span>).createHash(<span class="string">'md5'</span>).update(val).digest(<span class="string">'hex'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="2-用户注册路由"><a href="#2-用户注册路由" class="headerlink" title="2.用户注册路由"></a>2.用户注册路由</h4><p>注册表单的form中action=”/users/reg”,所以我们要实现用户注册的路由 修改 routes/users.js 中的 router.post(‘/reg’…<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  <span class="comment">//就是 POST 请求信息解析过后的对象，例如我们要访问 POST 来的表单内的 name="username" 域的值，只需访问 req.body['username'] 或 req.body.username 即可。</span></div><div class="line">  <span class="keyword">var</span> user = req.body;<span class="comment">//</span></div><div class="line">  <span class="keyword">if</span>(user.password != user.repassword)&#123;</div><div class="line">    req.flash(<span class="string">'error'</span>,<span class="string">'两次输入的密码不一致'</span>);</div><div class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'/users/reg'</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">delete</span> user.repassword; <span class="comment">//由于repassword不需要保存，所以可以删除</span></div><div class="line">  user.password = md5(user.password); <span class="comment">//对密码进行md5加密</span></div><div class="line">  user.avatar = <span class="string">"https://secure.gravatar.com/avatar/"</span>+md5(user.email)+<span class="string">"?s=48"</span>; 得到用户的头像</div><div class="line">  <span class="keyword">new</span> Model(<span class="string">'User'</span>)(user).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,user</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(err)&#123;</div><div class="line">      req.flash(<span class="string">'error'</span>,err);</div><div class="line">      <span class="keyword">return</span> res.redirect(<span class="string">'/users/reg'</span>);</div><div class="line">    &#125;</div><div class="line">    req.session.user = user;<span class="comment">//用户信息存入 session</span></div><div class="line">    res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="3-用户登陆路由"><a href="#3-用户登陆路由" class="headerlink" title="3.用户登陆路由"></a>3.用户登陆路由</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> user = req.body;</div><div class="line">    user.password = md5(user.password);</div><div class="line">    Model(<span class="string">'User'</span>).findOne(user,<span class="function"><span class="keyword">function</span>(<span class="params">err,user</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>,err);</div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'/users/login'</span>);</div><div class="line">        &#125;</div><div class="line">        req.session.user = user;<span class="comment">//用户信息存入 session</span></div><div class="line">        res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="4-用户登出"><a href="#4-用户登出" class="headerlink" title="4.用户登出"></a>4.用户登出</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    req.session.user = <span class="literal">null</span>;<span class="comment">//用户信息存入 session</span></div><div class="line">    res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="十二-发表文章"><a href="#十二-发表文章" class="headerlink" title="十二.发表文章"></a>十二.发表文章</h2><h4 id="1-发表文章路由"><a href="#1-发表文章路由" class="headerlink" title="1.发表文章路由"></a>1.发表文章路由</h4><p>发表文章表单的form中action=”/articles/add”,所以我们要实现发表文章路由 修改 routes/article.js 中的 post(‘/add’)<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    req.body.user = req.session.user._id;</div><div class="line">    <span class="keyword">new</span> Model(<span class="string">'Article'</span>)(req.body).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'/articles/add'</span>);</div><div class="line">        &#125;</div><div class="line">        res.redirect(<span class="string">'/'</span>);<span class="comment">//发表文章成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="十三-页面通知"><a href="#十三-页面通知" class="headerlink" title="十三.页面通知"></a>十三.页面通知</h2><h4 id="1-什么是-flash"><a href="#1-什么是-flash" class="headerlink" title="1.什么是 flash?"></a>1.什么是 flash?</h4><p>我们所说的 flash 即 connect-flash 模块（<a href="https://github.com/jaredhanson/connect-flash），flash" target="_blank" rel="external">https://github.com/jaredhanson/connect-flash），flash</a> 是一个在 session 中用于存储信息的特定区域。信息写入 flash ，下一次显示完毕后即被清除。典型的应用是结合重定向的功能，确保信息是提供给下一个被渲染的页面。</p>
<h4 id="2-安装模块"><a href="#2-安装模块" class="headerlink" title="2.安装模块"></a>2.安装模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install connect-flash --save</div></pre></td></tr></table></figure>
<h4 id="3-在app-js中添加调用此模块"><a href="#3-在app-js中添加调用此模块" class="headerlink" title="3.在app.js中添加调用此模块"></a>3.在app.js中添加调用此模块</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> flash = <span class="built_in">require</span>(<span class="string">'connect-flash'</span>);</div><div class="line">app.use(flash());</div></pre></td></tr></table></figure>
<h4 id="4-在发表文章的路由里放置flash提示信息"><a href="#4-在发表文章的路由里放置flash提示信息" class="headerlink" title="4.在发表文章的路由里放置flash提示信息"></a>4.在发表文章的路由里放置flash提示信息</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/add'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    req.body.user = req.session.user._id;</div><div class="line">    <span class="keyword">new</span> Model(<span class="string">'Article'</span>)(req.body).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>, <span class="string">'更新文章失败!'</span>); <span class="comment">//放置失败信息</span></div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'/articles/add'</span>);</div><div class="line">        &#125;</div><div class="line">        req.flash(<span class="string">'success'</span>, <span class="string">'更新文章成功!'</span>); <span class="comment">// 放置成功信息</span></div><div class="line">        res.redirect(<span class="string">'/'</span>);<span class="comment">//发表文章成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="5-在页面里增加显示提示的区域"><a href="#5-在页面里增加显示提示的区域" class="headerlink" title="5.在页面里增加显示提示的区域"></a>5.在页面里增加显示提示的区域</h4><p>修改 views/include/header.ejs 在最底部增加以下区域<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;container text-center&quot;&gt;</div><div class="line">    &lt;% if (success) &#123; %&gt;</div><div class="line">    &lt;div class=&quot;alert alert-success&quot; role=&quot;alert&quot;&gt;&lt;%= success %&gt;&lt;/div&gt;</div><div class="line">    &lt;% &#125; %&gt;</div><div class="line">    &lt;% if (error) &#123; %&gt;</div><div class="line">    &lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;&lt;%= error %&gt;&lt;/div&gt;</div><div class="line">    &lt;% &#125; %&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<h4 id="6-用session中的值为模板赋默认值"><a href="#6-用session中的值为模板赋默认值" class="headerlink" title="6.用session中的值为模板赋默认值"></a>6.用session中的值为模板赋默认值</h4><p>在app.js 中增加以下中间件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</div><div class="line">  res.locals.user = req.session.user;</div><div class="line">  res.locals.success = req.flash(<span class="string">'success'</span>).toString();</div><div class="line">  res.locals.error = req.flash(<span class="string">'error'</span>).toString();</div><div class="line">  next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="7-请自行修改其它提示"><a href="#7-请自行修改其它提示" class="headerlink" title="7.请自行修改其它提示"></a>7.请自行修改其它提示</h4><h2 id="十四-控制导航内容的显示"><a href="#十四-控制导航内容的显示" class="headerlink" title="十四.控制导航内容的显示"></a>十四.控制导航内容的显示</h2><h4 id="1-控制导航"><a href="#1-控制导航" class="headerlink" title="1.控制导航"></a>1.控制导航</h4><p>用户是否登陆看到的页面应该是不一样的，所以应该根据用户登陆状态来控制导航菜单的显示状态</p>
<h4 id="2-修改导航"><a href="#2-修改导航" class="headerlink" title="2.修改导航"></a>2.修改导航</h4><p>修改 views/include/header.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;nav navbar-nav&quot;&gt;</div><div class="line">            &lt;%</div><div class="line">            if(!user)&#123;</div><div class="line">            %&gt;</div><div class="line">            &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;/users/reg&quot;&gt;注册&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/users/login&quot;&gt;登录&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;%</div><div class="line">            &#125;else&#123;</div><div class="line">            %&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/articles/add&quot;&gt;发表文章&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li&gt;&lt;a href=&quot;/users/logout&quot;&gt;登出&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;%</div><div class="line">            &#125;</div><div class="line">            %&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<p>用户登陆后显示发表文章和登出按钮，用户登陆前显示注册和登录按钮。</p>
<h2 id="十五-页面权限控制"><a href="#十五-页面权限控制" class="headerlink" title="十五.页面权限控制"></a>十五.页面权限控制</h2><h4 id="1-页面权限控制"><a href="#1-页面权限控制" class="headerlink" title="1.页面权限控制"></a>1.页面权限控制</h4><p>我们虽然已经完成了用户注册与登陆的功能，但并不能阻止比如已经登陆的用户访问 <a href="http://localhost:3000/users/reg" target="_blank" rel="external">http://localhost:3000/users/reg</a> 页面， 为此，我们需要为页面设置访问权限。即注册和登陆页面应该阻止已登陆的用户访问， 登出及后面我们将要实现的发表页只对已登录的用户开放。 如何实现页面权限的控制呢？我们可以把用户登录状态的检查放到路由中间件中，在每个路径前增加路由中间件，即可实现页面权限控制。 我们添加 checkNotLogin 和 checkLogin 函数来实现这个功能</p>
<h4 id="2-添加中间件"><a href="#2-添加中间件" class="headerlink" title="2.添加中间件"></a>2.添加中间件</h4><p>添加middleware文件夹 在middleware下添加index.js文件 middleware/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">exports.checkLogin = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">     <span class="keyword">if</span> (!req.session.user) &#123;</div><div class="line">         req.flash(<span class="string">'error'</span>, <span class="string">'未登录!'</span>);</div><div class="line">         <span class="keyword">return</span> res.redirect(<span class="string">'/users/login'</span>);</div><div class="line">     &#125;</div><div class="line">     next();</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> exports.checkNotLogin = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">     <span class="keyword">if</span> (req.session.user) &#123;</div><div class="line">         req.flash(<span class="string">'error'</span>, <span class="string">'已登录!'</span>);</div><div class="line">         <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>);<span class="comment">//返回之前的页面</span></div><div class="line">     &#125;</div><div class="line">     next();</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h4 id="3-在路由中添加中间件"><a href="#3-在路由中添加中间件" class="headerlink" title="3.在路由中添加中间件"></a>3.在路由中添加中间件</h4><p>修改 routes/users.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/reg'</span>,middleware.checkNotLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'user/reg'</span>, &#123;<span class="attr">title</span>: <span class="string">'注册'</span>&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>修改routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/add'</span>,middleware.checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'article/add'</span>, &#123; <span class="attr">title</span>: <span class="string">'发表文章'</span> &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>凡是不能登陆的中间加入 checkNotLogin 凡是需要登陆的中间加入 checkLogin</p>
<h2 id="十六-在首页显示文章列表"><a href="#十六-在首页显示文章列表" class="headerlink" title="十六.在首页显示文章列表"></a>十六.在首页显示文章列表</h2><h4 id="1-修改首页模板"><a href="#1-修改首页模板" class="headerlink" title="1.修改首页模板"></a>1.修改首页模板</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;% include include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line"> &lt;ul class=&quot;media-list&quot;&gt;</div><div class="line">  &lt;%</div><div class="line">  articles.forEach(function(article)&#123;</div><div class="line">  %&gt;</div><div class="line">  &lt;li class=&quot;media&quot;&gt;</div><div class="line">   &lt;div class=&quot;media-left&quot;&gt;</div><div class="line">    &lt;a href=&quot;#&quot;&gt;</div><div class="line">     &lt;img class=&quot;media-object&quot; src=&quot;&lt;%=article.user.avatar%&gt;&quot; alt=&quot;&quot;&gt;</div><div class="line">    &lt;/a&gt;</div><div class="line">   &lt;/div&gt;</div><div class="line">   &lt;div class=&quot;media-body&quot;&gt;</div><div class="line">    &lt;h4 class=&quot;media-heading&quot;&gt;&lt;a href=&quot;/articles/detail/&lt;%=article._id%&gt;&quot;&gt;&lt;%=article.title%&gt;&lt;/a&gt;&lt;/h4&gt;</div><div class="line">    &lt;p class=&quot;media-left&quot;&gt;&lt;%- article.content%&gt;&lt;/p&gt;</div><div class="line">   &lt;/div&gt;</div><div class="line">   &lt;div class=&quot;media-bottom&quot;&gt;</div><div class="line">    作者:&lt;%=article.user.username%&gt;</div><div class="line">    发表时间:&lt;%=article.createAt.toLocaleString()%&gt;</div><div class="line">   &lt;/div&gt;</div><div class="line">  &lt;/li&gt;</div><div class="line">  &lt;%</div><div class="line">  &#125;);</div><div class="line">  %&gt;</div><div class="line"> &lt;/ul&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-修改路由"><a href="#2-修改路由" class="headerlink" title="2.修改路由"></a>2.修改路由</h4><p>routes/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  Model(<span class="string">'Article'</span>).find(&#123;&#125;).populate(<span class="string">'user'</span>).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,articles</span>)</span>&#123;</div><div class="line">    res.render(<span class="string">'index'</span>, &#123;<span class="attr">title</span>: <span class="string">'主页'</span>,<span class="attr">articles</span>:articles&#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="十七-文章内容使用markdown"><a href="#十七-文章内容使用markdown" class="headerlink" title="十七.文章内容使用markdown"></a>十七.文章内容使用markdown</h2><h4 id="1-安装markdown插件"><a href="#1-安装markdown插件" class="headerlink" title="1.安装markdown插件"></a>1.安装markdown插件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install markdown -save</div></pre></td></tr></table></figure>
<h4 id="2-修改路由-1"><a href="#2-修改路由-1" class="headerlink" title="2.修改路由"></a>2.修改路由</h4><p>routes/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">markdown = <span class="built_in">require</span>(<span class="string">'markdown'</span>).markdown;</div><div class="line"></div><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  Model(<span class="string">'Article'</span>).find(&#123;&#125;).populate(<span class="string">'user'</span>).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,articles</span>)</span>&#123;</div><div class="line">    articles.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">article</span>) </span>&#123;</div><div class="line">      article.content = markdown.toHTML(article.content);</div><div class="line">    &#125;);</div><div class="line">    res.render(<span class="string">'index'</span>, &#123;<span class="attr">title</span>: <span class="string">'主页'</span>,<span class="attr">articles</span>:articles&#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="十八-发表文章时可以上传图片"><a href="#十八-发表文章时可以上传图片" class="headerlink" title="十八.发表文章时可以上传图片"></a>十八.发表文章时可以上传图片</h2><h4 id="1-安装文件上传模块"><a href="#1-安装文件上传模块" class="headerlink" title="1.安装文件上传模块"></a>1.安装文件上传模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install multer --save</div></pre></td></tr></table></figure>
<h4 id="2-修改模板"><a href="#2-修改模板" class="headerlink" title="2.修改模板"></a>2.修改模板</h4><p>views/article/add.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;!--form的类型改为--&gt;</div><div class="line">enctype=&quot;multipart/form-data&quot;</div><div class="line"></div><div class="line">&lt;!--增加一个字段--&gt;</div><div class="line">&lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;img&quot; class=&quot;col-sm-2 control-label&quot;&gt;图片&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                &lt;input type=&quot;file&quot; class=&quot;form-control&quot;  name=&quot;img&quot; id=&quot;img&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">&lt;/div</div></pre></td></tr></table></figure></p>
<h4 id="3-修改模型"><a href="#3-修改模型" class="headerlink" title="3.修改模型"></a>3.修改模型</h4><p>db/models.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Article: &#123;</div><div class="line">          user:&#123;type:ObjectId,ref:&apos;User&apos;&#125;,</div><div class="line">          title: String,</div><div class="line">          content: String,</div><div class="line">          img:String, //增加了图片字段</div><div class="line">          createAt:&#123;type: Date, default: Date.now&#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-修改路由"><a href="#4-修改路由" class="headerlink" title="4.修改路由"></a>4.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> storage = multer.diskStorage(&#123;</div><div class="line">    <span class="attr">destination</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, file, cb</span>) </span>&#123;</div><div class="line">        cb(<span class="literal">null</span>, <span class="string">'../public/uploads'</span>)</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">filename</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, file, cb</span>) </span>&#123;</div><div class="line">        cb(<span class="literal">null</span>, <span class="built_in">Date</span>.now()+<span class="string">'.'</span>+file.mimetype.slice(file.mimetype.indexOf(<span class="string">'/'</span>)+<span class="number">1</span>))</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"><span class="keyword">var</span> upload = multer(&#123; <span class="attr">storage</span>:storage&#125;);</div><div class="line"></div><div class="line">router.post(<span class="string">'/add'</span>,middleware.checkLogin,upload.single(<span class="string">'img'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    req.body.user = req.session.user._id;</div><div class="line">    <span class="keyword">if</span>(req.file)&#123;</div><div class="line">        req.body.img = path.join(<span class="string">'/uploads'</span>,req.file.filename);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="十九-实现文章页面"><a href="#十九-实现文章页面" class="headerlink" title="十九.实现文章页面"></a>十九.实现文章页面</h2><h4 id="1-修改首页"><a href="#1-修改首页" class="headerlink" title="1.修改首页"></a>1.修改首页</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;h4 class=&quot;media-heading&quot;&gt;&lt;a href=&quot;/articles/detail/&lt;%=article._id%&gt;&quot;&gt;&lt;%=article.title%&gt;&lt;/a&gt;&lt;/h4&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-修改路由-2"><a href="#2-修改路由-2" class="headerlink" title="2.修改路由"></a>2.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/detail/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    Model(<span class="string">'Article'</span>).findOne(&#123;<span class="attr">_id</span>:req.params._id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        article.content = markdown.toHTML(article.content);</div><div class="line">        res.render(<span class="string">'article/detail'</span>,&#123;<span class="attr">title</span>:<span class="string">'查看文章'</span>,<span class="attr">article</span>:article&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="3-增加详情页"><a href="#3-增加详情页" class="headerlink" title="3.增加详情页"></a>3.增加详情页</h4><p>views/article/detail.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;% include ../include/header.ejs%&gt;</div><div class="line"> &lt;div class=&quot;container&quot;&gt;</div><div class="line">     &lt;div class=&quot;panel panel-default&quot;&gt;</div><div class="line">         &lt;div class=&quot;panel-heading&quot;&gt;</div><div class="line">             &lt;%=article.title%&gt;</div><div class="line">         &lt;/div&gt;</div><div class="line">         &lt;div class=&quot;panel-body&quot;&gt;</div><div class="line">             &lt;%-article.content%&gt;</div><div class="line">         &lt;/div&gt;</div><div class="line">         &lt;div class=&quot;panel-footer&quot;&gt;</div><div class="line">             &lt;a href=&quot;/articles/edit/&lt;%=article._id%&gt;&quot; class=&quot;btn btn-warning&quot;&gt;编辑&lt;/a&gt;</div><div class="line">             &lt;a href=&quot;/articles/delete/&lt;%=article._id%&gt;&quot; class=&quot;btn btn-danger&quot;&gt;删除&lt;/a&gt;</div><div class="line">         &lt;/div&gt;</div><div class="line">     &lt;/div&gt;</div><div class="line"> &lt;/div&gt;</div><div class="line"> &lt;% include ../include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h2 id="二十-增加编辑与删除功能"><a href="#二十-增加编辑与删除功能" class="headerlink" title="二十.增加编辑与删除功能"></a>二十.增加编辑与删除功能</h2><h4 id="1-修改详情页"><a href="#1-修改详情页" class="headerlink" title="1.修改详情页"></a>1.修改详情页</h4><p>views/article/detail.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;/articles/edit/&lt;%=article._id%&gt;&quot; class=&quot;btn btn-warning&quot;&gt;编辑&lt;/a&gt;</div><div class="line">&lt;a href=&quot;/articles/delete/&lt;%=article._id%&gt;&quot; class=&quot;btn btn-danger&quot;&gt;删除&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-修改添加文章界面"><a href="#2-修改添加文章界面" class="headerlink" title="2.修改添加文章界面"></a>2.修改添加文章界面</h4><p>views/article/add.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;form action=&quot;/articles/add&quot; method=&quot;post&quot;  role=&quot;form&quot; class=&quot;form-horizontal&quot; enctype=&quot;multipart/form-data&quot;&gt;</div><div class="line">        &lt;input type=&quot;hidden&quot; value=&quot;&lt;%=article._id%&gt;&quot; name=&quot;_id&quot;/&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;title&quot; class=&quot;col-sm-2 control-label&quot;&gt;标题&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                &lt;input type=&quot;text&quot; value=&quot;&lt;%=article.title%&gt;&quot; class=&quot;form-control&quot; id=&quot;title&quot; name=&quot;title&quot; placeholder=&quot;标题&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;content&quot; class=&quot;col-sm-2 control-label&quot;&gt;正文&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                &lt;textarea class=&quot;form-control&quot;   id=&quot;&quot; cols=&quot;30&quot; rows=&quot;10&quot; id=&quot;content&quot; name=&quot;content&quot; placeholder=&quot;请输入内容&quot; &gt;&lt;%=article.content%&gt;&lt;/textarea&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;label for=&quot;img&quot; class=&quot;col-sm-2 control-label&quot;&gt;图片&lt;/label&gt;</div><div class="line">            &lt;div class=&quot;col-sm-10&quot;&gt;</div><div class="line">                &lt;%</div><div class="line">                    if(article.img)&#123;</div><div class="line">                        %&gt;</div><div class="line">                             &lt;img src=&quot;&lt;%=article.img%&gt;&quot; style=&quot;width:100px;height:100px&quot; alt=&quot;&quot;/&gt;</div><div class="line">                        &lt;%</div><div class="line">                    &#125;</div><div class="line">                 %&gt;</div><div class="line">&lt;input type=&quot;file&quot; class=&quot;form-control&quot;  name=&quot;img&quot; id=&quot;img&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">            &lt;div class=&quot;col-sm-offset-2 col-sm-10&quot;&gt;</div><div class="line">                &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">                &lt;button type=&quot;reset&quot; class=&quot;btn btn-default&quot;&gt;重置&lt;/button&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;/form&gt;</div></pre></td></tr></table></figure></p>
<h4 id="3-修改路由"><a href="#3-修改路由" class="headerlink" title="3.修改路由"></a>3.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/add'</span>,middleware.checkLogin,upload.single(<span class="string">'img'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(req.file)&#123;</div><div class="line">        req.body.img = path.join(<span class="string">'/uploads'</span>,req.file.filename);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> _id = req.body._id;</div><div class="line">    <span class="keyword">if</span>(_id)&#123;</div><div class="line">        <span class="keyword">var</span> set = &#123;<span class="attr">title</span>:req.body.title,<span class="attr">content</span>:req.body.content&#125;;</div><div class="line">        <span class="keyword">if</span>(req.file)</div><div class="line">            set.img = req.body.img;</div><div class="line">        Model(<span class="string">'Article'</span>).update(&#123;<span class="attr">_id</span>:_id&#125;,&#123;<span class="attr">$set</span>:set&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(err)&#123;</div><div class="line">                req.flash(<span class="string">'error'</span>,err);</div><div class="line">                <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>);</div><div class="line">            &#125;</div><div class="line">            req.flash(<span class="string">'success'</span>, <span class="string">'更新文章成功!'</span>);</div><div class="line">            res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">        &#125;);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        req.body.user = req.session.user._id;</div><div class="line">        <span class="keyword">new</span> Model(<span class="string">'Article'</span>)(req.body).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(err)&#123;</div><div class="line">                req.flash(<span class="string">'error'</span>,err);</div><div class="line">                <span class="keyword">return</span> res.redirect(<span class="string">'/articles/add'</span>);</div><div class="line">            &#125;</div><div class="line">            req.flash(<span class="string">'success'</span>, <span class="string">'发表文章成功!'</span>);</div><div class="line">            res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">router.get(<span class="string">'/detail/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    Model(<span class="string">'Article'</span>).findOne(&#123;<span class="attr">_id</span>:req.params._id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        article.content = markdown.toHTML(article.content);</div><div class="line">        res.render(<span class="string">'article/detail'</span>,&#123;<span class="attr">title</span>:<span class="string">'查看文章'</span>,<span class="attr">article</span>:article&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line">router.get(<span class="string">'/delete/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    Model(<span class="string">'Article'</span>).remove(&#123;<span class="attr">_id</span>:req.params._id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>,err);</div><div class="line">            res.redirect(<span class="string">'back'</span>);</div><div class="line">        &#125;</div><div class="line">        req.flash(<span class="string">'success'</span>, <span class="string">'删除文章成功!'</span>);</div><div class="line">        res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">router.get(<span class="string">'/edit/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    Model(<span class="string">'Article'</span>).findOne(&#123;<span class="attr">_id</span>:req.params._id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">        res.render(<span class="string">'article/add'</span>,&#123;<span class="attr">title</span>:<span class="string">'编辑文章'</span>,<span class="attr">article</span>:article&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="二十一-实现搜索和分页功能"><a href="#二十一-实现搜索和分页功能" class="headerlink" title="二十一.实现搜索和分页功能"></a>二十一.实现搜索和分页功能</h2><h4 id="1-在导航栏增加搜索框"><a href="#1-在导航栏增加搜索框" class="headerlink" title="1.在导航栏增加搜索框"></a>1.在导航栏增加搜索框</h4><p>views/include/header.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;form  class=&quot;navbar-form navbar-right&quot; role=&quot;search&quot; method=&quot;get&quot; action=&quot;/articles/list/1/2&quot;&gt;</div><div class="line">            &lt;div class=&quot;form-group&quot;&gt;</div><div class="line">                &lt;label for=&quot;keyword&quot;&gt;关键字&lt;/label&gt;</div><div class="line">                &lt;input type=&quot;text&quot; name=&quot;keyword&quot; id=&quot;keyword&quot; class=&quot;form-control&quot; value=&quot;&lt;%=keyword%&gt;&quot;/&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">            &lt;button type=&quot;submit&quot; class=&quot;btn  btn-default&quot; value=&quot;search&quot; name=&quot;searchBtn&quot;&gt;搜索&lt;/button&gt;</div><div class="line">        &lt;/form&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-在首页增加分页条"><a href="#2-在首页增加分页条" class="headerlink" title="2.在首页增加分页条"></a>2.在首页增加分页条</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;pagination&quot;&gt;</div><div class="line">  &lt;%</div><div class="line">  for(var i=1;i&lt;=totalPage;i++)&#123;</div><div class="line">  %&gt;</div><div class="line">  &lt;li&gt;&lt;a href=&quot;/articles/list/&lt;%=i%&gt;/&lt;%=pageSize%&gt;?keyword=&lt;%=keyword%&gt;&quot;&gt;&lt;%=i%&gt;&lt;/a&gt;&lt;/li&gt;</div><div class="line">  &lt;%</div><div class="line">  &#125;</div><div class="line">  %&gt;</div><div class="line"> &lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<h4 id="3-首页导航重定向到文章列表页"><a href="#3-首页导航重定向到文章列表页" class="headerlink" title="3.首页导航重定向到文章列表页"></a>3.首页导航重定向到文章列表页</h4><p>routes/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.redirect(<span class="string">'/articles/list/1/2'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="4-增加文章列表导航"><a href="#4-增加文章列表导航" class="headerlink" title="4.增加文章列表导航"></a>4.增加文章列表导航</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/list/:pageNum/:pageSize'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> pageNum = req.params.pageNum&amp;&amp;req.params.pageNum&gt;<span class="number">0</span>?<span class="built_in">parseInt</span>(req.params.pageNum):<span class="number">1</span>;</div><div class="line">    <span class="keyword">var</span> pageSize =req.params.pageSize&amp;&amp;req.params.pageSize&gt;<span class="number">0</span>?<span class="built_in">parseInt</span>(req.params.pageSize):<span class="number">2</span>;</div><div class="line">    <span class="keyword">var</span> query = &#123;&#125;;</div><div class="line">    <span class="keyword">var</span> searchBtn = req.query.searchBtn;</div><div class="line">    <span class="keyword">var</span> keyword = req.query.keyword;</div><div class="line">    <span class="keyword">if</span>(searchBtn)&#123;</div><div class="line">        req.session.keyword = keyword;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(req.session.keyword)&#123;</div><div class="line">        query[<span class="string">'title'</span>] = <span class="keyword">new</span> <span class="built_in">RegExp</span>(req.session.keyword,<span class="string">"i"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Model(<span class="string">'Article'</span>).count(query,<span class="function"><span class="keyword">function</span>(<span class="params">err,count</span>)</span>&#123;</div><div class="line">        Model(<span class="string">'Article'</span>).find(query).sort(&#123;<span class="attr">createAt</span>:<span class="number">-1</span>&#125;).skip((pageNum<span class="number">-1</span>)*pageSize).limit(pageSize).populate(<span class="string">'user'</span>).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,articles</span>)</span>&#123;</div><div class="line">            articles.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">article</span>) </span>&#123;</div><div class="line">                article.content = markdown.toHTML(article.content);</div><div class="line">            &#125;);</div><div class="line">            res.render(<span class="string">'index'</span>,&#123;</div><div class="line">                <span class="attr">title</span>:<span class="string">'主页'</span>,</div><div class="line">                <span class="attr">pageNum</span>:pageNum,</div><div class="line">                <span class="attr">pageSize</span>:pageSize,</div><div class="line">                <span class="attr">keyword</span>:req.session.keyword,</div><div class="line">                <span class="attr">totalPage</span>:<span class="built_in">Math</span>.ceil(count/pageSize),</div><div class="line">                <span class="attr">articles</span>:articles</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="二十二-实现评论功能"><a href="#二十二-实现评论功能" class="headerlink" title="二十二.实现评论功能"></a>二十二.实现评论功能</h2><h4 id="1-修改模板"><a href="#1-修改模板" class="headerlink" title="1.修改模板"></a>1.修改模板</h4><p>views/article/detail.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;panel panel-default&quot;&gt;</div><div class="line">        &lt;div class=&quot;panel-heading&quot;&gt;</div><div class="line">            评论列表</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;panel-body&quot;  style=&quot;height:300px;overflow-y: scroll&quot;&gt;</div><div class="line">            &lt;ul class=&quot;media-list&quot;&gt;</div><div class="line">                &lt;%</div><div class="line">                article.comments.forEach(function(comment)&#123;</div><div class="line">                %&gt;</div><div class="line">                &lt;li class=&quot;media&quot;&gt;</div><div class="line">                    &lt;div class=&quot;media-left&quot;&gt;</div><div class="line">                        &lt;a href=&quot;#&quot;&gt;</div><div class="line">                            &lt;img class=&quot;media-object&quot; src=&quot;&lt;%=comment.user.avatar%&gt;&quot; alt=&quot;&quot;&gt;</div><div class="line">                        &lt;/a&gt;</div><div class="line">                    &lt;/div&gt;</div><div class="line">                    &lt;div class=&quot;media-body&quot;&gt;</div><div class="line">                        &lt;p class=&quot;media-left&quot;&gt;&lt;%- comment.content%&gt;&lt;/p&gt;</div><div class="line">                    &lt;/div&gt;</div><div class="line">                    &lt;div class=&quot;media-bottom&quot;&gt;</div><div class="line">                        &lt;%=comment.user.username%&gt; &lt;%=comment.createAt.toLocaleString()%&gt;</div><div class="line">                    &lt;/div&gt;</div><div class="line">                &lt;/li&gt;</div><div class="line">                &lt;%</div><div class="line">                &#125;);</div><div class="line">                %&gt;</div><div class="line">            &lt;/ul&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;/div&gt;</div><div class="line"></div><div class="line"> &lt;div class=&quot;panel panel-default&quot;&gt;</div><div class="line">        &lt;form action=&quot;/articles/comment&quot; method=&quot;post&quot;&gt;</div><div class="line">            &lt;input type=&quot;hidden&quot; value=&quot;&lt;%=article._id%&gt;&quot; name=&quot;_id&quot;/&gt;</div><div class="line">            &lt;div class=&quot;panel-body&quot;&gt;</div><div class="line">                &lt;textarea class=&quot;form-control&quot;   id=&quot;&quot; cols=&quot;30&quot; rows=&quot;10&quot; id=&quot;content&quot; name=&quot;content&quot; placeholder=&quot;请输入评论&quot; &gt;&lt;/textarea&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">            &lt;div class=&quot;panel-footer&quot;&gt;</div><div class="line">                &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;提交&lt;/button&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/form&gt;</div><div class="line">    &lt;/div&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-修改模型"><a href="#2-修改模型" class="headerlink" title="2.修改模型"></a>2.修改模型</h4><p>db/models.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">comments: [&#123;<span class="attr">user</span>:&#123;<span class="attr">type</span>:ObjectId,<span class="attr">ref</span>:<span class="string">'User'</span>&#125;,<span class="attr">content</span>:<span class="built_in">String</span>,<span class="attr">createAt</span>:&#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now&#125;&#125;]</div></pre></td></tr></table></figure></p>
<h4 id="3-修改路由-1"><a href="#3-修改路由-1" class="headerlink" title="3.修改路由"></a>3.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">router.post(<span class="string">'/comment'</span>,middleware.checkLogin, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">   <span class="keyword">var</span> user = req.session.user;</div><div class="line">   Model(<span class="string">'Article'</span>).update(&#123;<span class="attr">_id</span>:req.body._id&#125;,&#123;<span class="attr">$push</span>:&#123;<span class="attr">comments</span>:&#123;<span class="attr">user</span>:user._id,<span class="attr">content</span>:req.body.content&#125;&#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>,err);</div><div class="line">            <span class="keyword">return</span> res.redirect(<span class="string">'back'</span>);</div><div class="line">        &#125;</div><div class="line">        req.flash(<span class="string">'success'</span>, <span class="string">'评论成功!'</span>);</div><div class="line">        res.redirect(<span class="string">'back'</span>);</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="二十三-显示pv和评论数"><a href="#二十三-显示pv和评论数" class="headerlink" title="二十三.显示pv和评论数"></a>二十三.显示pv和评论数</h2><h4 id="1-安装async"><a href="#1-安装async" class="headerlink" title="1.安装async"></a>1.安装async</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install async --save</div></pre></td></tr></table></figure>
<h4 id="2-修改模型-1"><a href="#2-修改模型-1" class="headerlink" title="2.修改模型"></a>2.修改模型</h4><p>db/models.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pv: &#123;type:Number,default:0&#125;</div></pre></td></tr></table></figure></p>
<h4 id="3-修改路由-2"><a href="#3-修改路由-2" class="headerlink" title="3.修改路由"></a>3.修改路由</h4><p>routes/article.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</div><div class="line">router.get(<span class="string">'/detail/:_id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="keyword">async</span>.parallel([<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        Model(<span class="string">'Article'</span>).findOne(&#123;<span class="attr">_id</span>:req.params._id&#125;).populate(<span class="string">'user'</span>).populate(<span class="string">'comments.user'</span>).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,article</span>)</span>&#123;</div><div class="line">                article.content = markdown.toHTML(article.content);</div><div class="line">                callback(err,article);</div><div class="line">        &#125;);</div><div class="line">    &#125;,<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        Model(<span class="string">'Article'</span>).update(&#123;<span class="attr">_id</span>:req.params._id&#125;,&#123;<span class="attr">$inc</span>:&#123;<span class="attr">pv</span>:<span class="number">1</span>&#125;&#125;,callback);</div><div class="line">    &#125;],<span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(err)&#123;</div><div class="line">            req.flash(<span class="string">'error'</span>,err);</div><div class="line">            res.redirect(<span class="string">'back'</span>);</div><div class="line">        &#125;</div><div class="line">        res.render(<span class="string">'article/detail'</span>,&#123;<span class="attr">title</span>:<span class="string">'查看文章'</span>,<span class="attr">article</span>:result[<span class="number">0</span>]&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="4-修改模板"><a href="#4-修改模板" class="headerlink" title="4.修改模板"></a>4.修改模板</h4><p>views/index.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">阅读：&lt;%= article.pv %&gt;|</div><div class="line">评论：&lt;%= article.comments.length%&gt;</div></pre></td></tr></table></figure></p>
<h2 id="二十四-美化404页面"><a href="#二十四-美化404页面" class="headerlink" title="二十四.美化404页面"></a>二十四.美化404页面</h2><h4 id="1-修改404中间件"><a href="#1-修改404中间件" class="headerlink" title="1.修改404中间件"></a>1.修改404中间件</h4><p>app.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// catch 404 and forward to error handler</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">"404"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="2-增加404页面模板"><a href="#2-增加404页面模板" class="headerlink" title="2.增加404页面模板"></a>2.增加404页面模板</h4><p>views/404.ejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;% include include/header.ejs%&gt;</div><div class="line">&lt;div class=&quot;container&quot;&gt;</div><div class="line">    &lt;img src=&quot;http://7xjf2l.com2.z0.glb.qiniucdn.com/20131122112727-1356352347.jpg&quot; alt=&quot;404&quot;/&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;% include include/footer.ejs%&gt;</div></pre></td></tr></table></figure></p>
<h2 id="二十五-打印日志"><a href="#二十五-打印日志" class="headerlink" title="二十五.打印日志"></a>二十五.打印日志</h2><p>现在给博客增加日志，实现访问日志（access.log）和错误日志（error.log）功能</p>
<h4 id="1-把日志保存为日志文件"><a href="#1-把日志保存为日志文件" class="headerlink" title="1.把日志保存为日志文件"></a>1.把日志保存为日志文件</h4><p>app.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//正常日志</span></div><div class="line"><span class="keyword">var</span> accessLog = fs.createWriteStream(<span class="string">'access.log'</span>, &#123;<span class="attr">flags</span>: <span class="string">'a'</span>&#125;);</div><div class="line">app.use(logger(<span class="string">'dev'</span>,&#123;<span class="attr">stream</span>: accessLog&#125;));</div><div class="line"></div><div class="line"><span class="comment">//错误日志</span></div><div class="line"><span class="keyword">var</span> errorLog = fs.createWriteStream(<span class="string">'error.log'</span>, &#123;<span class="attr">flags</span>: <span class="string">'a'</span>&#125;);</div><div class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> meta = <span class="string">'['</span> + <span class="keyword">new</span> <span class="built_in">Date</span>() + <span class="string">'] '</span> + req.url + <span class="string">'\n'</span>;</div><div class="line">  errorLog.write(meta + err.stack + <span class="string">'\n'</span>);</div><div class="line">  next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/17/Blog/" data-id="cj5klaulx0000q4u294i73bb6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/04/14/angular/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          angular
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/17/Blog/">Blog</a>
          </li>
        
          <li>
            <a href="/2017/04/14/angular/">angular</a>
          </li>
        
          <li>
            <a href="/2017/04/14/正则/">正则</a>
          </li>
        
          <li>
            <a href="/2017/04/14/git常用指令/">git常用指令</a>
          </li>
        
          <li>
            <a href="/2017/04/14/hexo-github静态博客/">hexo+github静态博客</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>